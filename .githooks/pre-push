#!/bin/sh

# Pre-push hook to automatically bump patch version and create tags
# This runs before each push to automatically create new patch versions

echo "🔄 Running pre-push version bump..."

# Get current version from package.json
CURRENT_VERSION=$(node -p "require('./package.json').version")
echo "📦 Current version: $CURRENT_VERSION"

# Parse version numbers
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

# Auto-increment patch version
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

echo "🔢 Bumping to version: $NEW_VERSION"

# Update package.json
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
pkg.version = '$NEW_VERSION';
fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
"

# Generate changelog for new version
echo "📝 Generating changelog..."
node scripts/generate-changelog.js

# Add updated files
git add package.json src/data/changelog.js

# Create commit for version bump
git commit -m "chore: bump version to $NEW_VERSION

🎉 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# Create version tag
git tag "v$NEW_VERSION" -m "Version $NEW_VERSION"

echo "✅ Version bumped to $NEW_VERSION and tagged"
echo "🏷️  Created tag: v$NEW_VERSION"