---
// Stella Sora Characters Database Page
import CharactersLayout from '../../../layouts/stella-sora/CharactersLayout.astro';
import CharacterFilterBar from '../../../components/stella-sora/CharacterFilterBar.astro';
import SSCharacterSmallImage from '../../../components/stella-sora/SSCharacterSmallImage.astro';
import SSElementImage from '../../../components/stella-sora/SSElementImage.astro';
import { STELLA_SORA_CHARACTERS } from '../../../data/stella-sora/characters.js';

// Sort characters by Rarity initially (5-Star first, then 4-Star, then 3-Star)
const rarityOrder = { '5-Star': 0, '4-Star': 1, '3-Star': 2 };
const sortedCharacters = [...STELLA_SORA_CHARACTERS].sort((a, b) => {
  return (rarityOrder[a.rarity] || 99) - (rarityOrder[b.rarity] || 99);
});

// Generate structured data for character database
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'Stella Sora Character Database',
  description:
    'Browse all Stella Sora characters with detailed stats, skills, and information. Filter by rarity, element, role, and more.',
  url: new URL(Astro.url.pathname, Astro.site),
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: STELLA_SORA_CHARACTERS.length,
    itemListElement: sortedCharacters.slice(0, 20).map((character: any, index: number) => ({
      '@type': 'ListItem',
      position: index + 1,
      item: {
        '@type': 'VideoGameCharacter',
        name: character.name,
        description: `${character.rarity} ${character.element} ${character.role} character from Stella Sora`,
        image: new URL(character.image, Astro.site).href,
        isPartOf: {
          '@type': 'VideoGame',
          name: 'Stella Sora',
        },
        additionalProperty: [
          {
            '@type': 'PropertyValue',
            name: 'Rarity',
            value: character.rarity,
          },
          {
            '@type': 'PropertyValue',
            name: 'Element',
            value: character.element,
          },
          {
            '@type': 'PropertyValue',
            name: 'Role',
            value: character.role,
          },
        ],
      },
    })),
  },
};
---

<CharactersLayout
  title="Stella Sora Character Database - Complete Character List & Stats"
  description="Browse all Stella Sora characters with detailed stats, skills, and information. Filter by rarity, element, role, and more. Complete character database for Trekker collection."
  gameTitle="Character Database"
>
  <!-- Structured Data for Character Database -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <section class="page-content">
    <div class="content-wrapper">
      <!-- Database Controls Container -->
      <div class="database-controls-container">
        <!-- Controls Header -->
        <div class="controls-header">
          <h2 class="controls-title">Character Controls</h2>
          <!-- Global Clear Button -->
          <div class="global-clear-container">
            <button class="global-clear-btn" id="global-clear-btn">
              <span class="clear-icon">✕</span>
              <span class="clear-text">Clear All</span>
            </button>
          </div>
        </div>

        <!-- Controls Content -->
        <div class="controls-content">
          <!-- Filter Bar -->
          <CharacterFilterBar showFilters={true} />

          <!-- Sort Controls -->
          <div class="ss-sort-component">
            <div class="sort-section">
              <h3 class="sort-title">Sort By</h3>
              <div class="sort-controls">
                <button class="sort-btn" data-sort="rarity">
                  Rarity
                  <span class="sort-arrow"></span>
                </button>
                <button class="sort-btn" data-sort="name">
                  Name
                  <span class="sort-arrow"></span>
                </button>
                <button class="sort-btn" data-sort="hp">
                  HP
                  <span class="sort-arrow"></span>
                </button>
                <button class="sort-btn" data-sort="attack">
                  ATK
                  <span class="sort-arrow"></span>
                </button>
                <button class="sort-btn" data-sort="defense">
                  DEF
                  <span class="sort-arrow"></span>
                </button>
                <button class="sort-btn" data-sort="critRate">
                  Crit%
                  <span class="sort-arrow"></span>
                </button>
                <button class="sort-btn" data-sort="critDmg">
                  Crit DMG
                  <span class="sort-arrow"></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Character Statistics -->
      <div class="stats-overview">
        <h2>Character Overview</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">{STELLA_SORA_CHARACTERS.length}</div>
            <div class="stat-label">Total Characters</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">
              {STELLA_SORA_CHARACTERS.filter(c => c.rarity === '5-Star').length}
            </div>
            <div class="stat-label">5-Star Characters</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">
              {STELLA_SORA_CHARACTERS.filter(c => c.rarity === '4-Star').length}
            </div>
            <div class="stat-label">4-Star Characters</div>
          </div>
        </div>
      </div>

      <!-- Character Database -->
      <div class="character-database">
        <div class="database-header">
          <h2>All Characters</h2>
          <p class="database-description">
            All stats shown at maximum stats. Click on any character to view detailed information.
          </p>
        </div>

        <!-- Desktop Table View -->
        <div class="character-table-container">
          <table class="character-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Image</th>
                <th>Name</th>
                <th>Rarity</th>
                <th>Element</th>
                <th>Icon</th>
                <th>Position</th>
                <th>Faction</th>
                <th>Trekker Style</th>
                <th>HP</th>
                <th>ATK</th>
                <th>DEF</th>
                <th>Crit%</th>
                <th>Crit DMG</th>
              </tr>
            </thead>
            <tbody id="character-table-body">
              {
                sortedCharacters.map((character: any, index: number) => (
                  <tr
                    class="character-row clickable-row"
                    data-name={character.name.toLowerCase()}
                    data-rarity={character.rarity}
                    data-element={character.element}
                    data-role={character.role}
                    data-slug={character.slug}
                  >
                    <td>{index + 1}</td>
                    <td>
                      <div class="character-image-container">
                        <SSCharacterSmallImage
                          characterName={character.slug}
                          alt={`${character.name} - ${character.rarity} ${character.element} ${character.role} character from Stella Sora`}
                          class="character-img"
                          width={200}
                          height={200}
                          quality={100}
                          format="png"
                        />
                      </div>
                    </td>
                    <td class="character-name">{character.name}</td>
                    <td>
                      <span
                        class={`rarity-badge ${character.rarity.toLowerCase().replace('-star', '-star').replace('5-star', 'five-star').replace('4-star', 'four-star').replace('3-star', 'three-star')}`}
                      >
                        {character.rarity}
                      </span>
                    </td>
                    <td>
                      <span class={`element-badge element-${character.element.toLowerCase()}`}>
                        {character.element}
                      </span>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                      <div class="element-icon-container">
                        <SSElementImage
                          elementName={character.element}
                          alt={character.element}
                          class="element-icon"
                          width={400}
                          height={400}
                        />
                      </div>
                    </td>
                    <td>
                      <span class={`position-badge position-${character.role.toLowerCase()}`}>
                        {character.role}
                      </span>
                    </td>
                    <td>{character.faction}</td>
                    <td>
                      <span class="trekker-style-text">{character.trekkerStyle || ''}</span>
                    </td>
                    <td data-hp={character.stats.hp}>{character.stats.hp.toLocaleString()}</td>
                    <td data-attack={character.stats.attack}>
                      {character.stats.attack.toLocaleString()}
                    </td>
                    <td data-defense={character.stats.defense}>
                      {character.stats.defense.toLocaleString()}
                    </td>
                    <td data-critRate={character.stats.critRate}>{character.stats.critRate}%</td>
                    <td data-critDmg={character.stats.critDmg}>{character.stats.critDmg}%</td>
                  </tr>
                ))
              }
            </tbody>
          </table>
        </div>

        <!-- Mobile Card View -->
        <div class="character-cards-container" id="character-cards">
          {
            sortedCharacters.map((character: any) => (
              <div
                class="character-card clickable-card"
                data-name={character.name.toLowerCase()}
                data-rarity={character.rarity}
                data-element={character.element}
                data-role={character.role}
                data-slug={character.slug}
                data-hp={character.stats.hp}
                data-attack={character.stats.attack}
                data-defense={character.stats.defense}
                data-critRate={character.stats.critRate}
                data-critDmg={character.stats.critDmg}
              >
                {/* Card Header: Image + Basic Info */}
                <div class="mobile-card-header">
                  <div class="character-image-container">
                    <SSCharacterSmallImage
                      characterName={character.slug}
                      alt={`${character.name} - ${character.rarity} ${character.element} ${character.role} character from Stella Sora`}
                      class="character-img"
                      width={200}
                      height={200}
                      quality={100}
                      format="png"
                    />
                  </div>
                  <div class="mobile-card-title-group">
                    <h3 class="character-name">{character.name}</h3>
                    <div class="character-rarity">
                      <span
                        class={`rarity-badge ${character.rarity.toLowerCase().replace('-star', '-star').replace('5-star', 'five-star').replace('4-star', 'four-star').replace('3-star', 'three-star')}`}
                      >
                        {character.rarity}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Section Divider */}
                <div class="mobile-card-divider" />

                {/* Primary Stats Section */}
                <div class="mobile-card-section">
                  <div class="section-title">Combat Stats</div>
                  <div class="mobile-card-stats mobile-card-primary-stats">
                    <div class="stat-item">
                      <span class="stat-value">{character.stats.hp.toLocaleString()}</span>
                      <span class="stat-label">HP</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-value">{character.stats.attack.toLocaleString()}</span>
                      <span class="stat-label">ATK</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-value">{character.stats.defense.toLocaleString()}</span>
                      <span class="stat-label">DEF</span>
                    </div>
                  </div>
                </div>

                {/* Section Divider */}
                <div class="mobile-card-divider" />

                {/* Metadata Section */}
                <div class="mobile-card-section">
                  <div class="section-title">Character Info</div>
                  <div class="mobile-card-metadata">
                    <div class="metadata-badges">
                      <span class={`element-badge element-${character.element.toLowerCase()}`}>
                        <SSElementImage
                          elementName={character.element}
                          width={200}
                          height={200}
                          alt={`${character.element} element icon`}
                        />
                        <span>{character.element}</span>
                      </span>
                      <span class={`position-badge position-${character.role.toLowerCase()}`}>
                        {character.role}
                      </span>
                      <span class="faction-badge">{character.faction}</span>
                      {character.trekkerStyle && (
                        <span class="trekker-style-text">{character.trekkerStyle}</span>
                      )}
                    </div>
                  </div>
                </div>

                {/* Advanced Stats Section */}
                <div class="mobile-card-section mobile-card-advanced-stats">
                  <div class="section-title">Advanced Stats</div>
                  <div class="mobile-card-stats mobile-card-secondary-stats">
                    <div class="stat-item">
                      <span class="stat-value">{character.stats.critRate}%</span>
                      <span class="stat-label">Crit%</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-value">{character.stats.critDmg}%</span>
                      <span class="stat-label">Crit DMG</span>
                    </div>
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </section>
</CharactersLayout>

<script>
  // Character Navigation Script
  // Handles click navigation to individual character pages

  function initializeCharacterNavigation() {
    // Get all clickable rows and cards
    const clickableRows = document.querySelectorAll('.clickable-row');
    const clickableCards = document.querySelectorAll('.clickable-card');

    // Add click event listeners to desktop table rows
    clickableRows.forEach(row => {
      row.addEventListener('click', function () {
        const slug = this.dataset.slug;
        if (slug) {
          window.location.href = `/guides/stella-sora/characters/${slug}`;
        }
      });

      // Add hover effect for better UX
      row.addEventListener('mouseenter', function () {
        this.style.cursor = 'pointer';
      });

      row.addEventListener('mouseleave', function () {
        this.style.cursor = 'default';
      });
    });

    // Add click event listeners to mobile cards
    clickableCards.forEach(card => {
      card.addEventListener('click', function () {
        const slug = this.dataset.slug;
        if (slug) {
          window.location.href = `/guides/stella-sora/characters/${slug}`;
        }
      });

      // Add hover effect for better UX
      card.addEventListener('mouseenter', function () {
        this.style.cursor = 'pointer';
      });

      card.addEventListener('mouseleave', function () {
        this.style.cursor = 'default';
      });
    });
  }

  // Initialize navigation when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCharacterNavigation);
  } else {
    initializeCharacterNavigation();
  }

  // ==========================================
  // Combined Filter & Sort Script
  // ==========================================

  // State
  let originalRows: HTMLElement[] = [];
  let originalCards: HTMLElement[] = [];
  let currentSortKey: string | null = null;
  let currentSortDirection: 'asc' | 'desc' | 'normal' = 'normal';

  // DOM references
  let tableBody: HTMLElement | null;
  let mobileCardsContainer: HTMLElement | null;
  let searchInput: HTMLInputElement | null;
  let rarityFilter: HTMLSelectElement | null;
  let elementFilter: HTMLSelectElement | null;
  let roleFilter: HTMLSelectElement | null;

  // Rarity order for sorting (5-Star first)
  const rarityOrder: Record<string, number> = { '5-Star': 0, '4-Star': 1, '3-Star': 2 };

  function initializeDatabase() {
    // Get DOM elements
    tableBody = document.getElementById('character-table-body');
    mobileCardsContainer = document.getElementById('character-cards');
    searchInput = document.getElementById('search-input') as HTMLInputElement;
    rarityFilter = document.getElementById('rarity-filter') as HTMLSelectElement;
    elementFilter = document.getElementById('element-filter') as HTMLSelectElement;
    roleFilter = document.getElementById('role-filter') as HTMLSelectElement;

    if (!tableBody || !mobileCardsContainer) {
      console.error('Required elements not found');
      return;
    }

    // Store original rows and cards
    originalRows = Array.from(tableBody.querySelectorAll('.character-row'));
    originalCards = Array.from(mobileCardsContainer.querySelectorAll('.character-card'));

    if (!originalRows.length) {
      console.log('No character rows found');
      return;
    }

    // Setup filter event listeners
    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (rarityFilter) rarityFilter.addEventListener('change', applyFilters);
    if (elementFilter) elementFilter.addEventListener('change', applyFilters);
    if (roleFilter) roleFilter.addEventListener('change', applyFilters);

    // Setup Clear All button
    const globalClearBtn = document.getElementById('global-clear-btn');
    if (globalClearBtn) {
      globalClearBtn.addEventListener('click', resetAll);
    }

    // Setup sort buttons
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(button => {
      button.addEventListener('click', () => handleSortClick(button as HTMLElement));
    });

    // Apply initial sort by rarity
    sortByRarity();
  }

  // ==========================================
  // Filter Functions
  // ==========================================

  function applyFilters() {
    const search = searchInput?.value.toLowerCase().trim() || '';
    const rarity = rarityFilter?.value || '';
    const element = elementFilter?.value || '';
    const role = roleFilter?.value || '';

    originalRows.forEach((row, index) => {
      const card = originalCards[index];
      const show = shouldShowCharacter(row, search, rarity, element, role);
      row.style.display = show ? '' : 'none';
      if (card) card.style.display = show ? '' : 'none';
    });

    // Re-apply sort after filtering
    if (currentSortKey && currentSortDirection !== 'normal') {
      applySort(currentSortKey);
    }
  }

  function shouldShowCharacter(row: HTMLElement, search: string, rarity: string, element: string, role: string): boolean {
    if (search && !row.dataset.name?.toLowerCase().includes(search)) return false;
    if (rarity && row.dataset.rarity !== rarity) return false;
    if (element && row.dataset.element !== element) return false;
    if (role && row.dataset.role !== role) return false;
    return true;
  }

  // ==========================================
  // Sort Functions
  // ==========================================

  function handleSortClick(button: HTMLElement) {
    const sortKey = button.dataset.sort;
    if (!sortKey) return;

    if (currentSortKey !== sortKey) {
      // New sort field
      currentSortKey = sortKey;
      currentSortDirection = 'desc';
    } else {
      // Cycle: desc -> asc -> normal
      if (currentSortDirection === 'desc') {
        currentSortDirection = 'asc';
      } else if (currentSortDirection === 'asc') {
        currentSortDirection = 'normal';
        currentSortKey = null;
      } else {
        currentSortDirection = 'desc';
      }
    }

    updateSortButtons();

    if (currentSortKey) {
      applySort(currentSortKey);
    } else {
      sortByRarity(); // Default sort
    }
  }

  function updateSortButtons() {
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(button => {
      button.classList.remove('active');
      const arrow = button.querySelector('.sort-arrow');
      if (arrow) arrow.textContent = '';
    });

    if (currentSortKey && currentSortDirection !== 'normal') {
      const activeBtn = document.querySelector(`[data-sort="${currentSortKey}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        const arrow = activeBtn.querySelector('.sort-arrow');
        if (arrow) {
          arrow.textContent = currentSortDirection === 'desc' ? ' ↑' : ' ↓';
        }
      }
    }
  }

  function applySort(sortKey: string) {
    if (!tableBody || !mobileCardsContainer) return;

    // Get visible rows
    const visibleRows = originalRows.filter(row => row.style.display !== 'none');

    // Sort rows
    const sortedRows = [...visibleRows].sort((a, b) => {
      let valueA: any, valueB: any;

      switch (sortKey) {
        case 'rarity':
          valueA = rarityOrder[a.dataset.rarity || ''] ?? 99;
          valueB = rarityOrder[b.dataset.rarity || ''] ?? 99;
          return currentSortDirection === 'asc' ? valueB - valueA : valueA - valueB;

        case 'name':
          valueA = a.querySelector('.character-name')?.textContent || '';
          valueB = b.querySelector('.character-name')?.textContent || '';
          return currentSortDirection === 'asc'
            ? valueA.localeCompare(valueB)
            : valueB.localeCompare(valueA);

        case 'hp':
        case 'attack':
        case 'defense':
        case 'critRate':
        case 'critDmg':
          const cellA = a.querySelector(`[data-${sortKey}]`) as HTMLElement;
          const cellB = b.querySelector(`[data-${sortKey}]`) as HTMLElement;
          valueA = parseFloat(cellA?.dataset[sortKey] || '0');
          valueB = parseFloat(cellB?.dataset[sortKey] || '0');
          return currentSortDirection === 'asc' ? valueA - valueB : valueB - valueA;

        default:
          return 0;
      }
    });

    // Get corresponding cards
    const sortedCards = sortedRows.map(row => {
      const idx = originalRows.indexOf(row);
      return originalCards[idx];
    }).filter(Boolean);

    // Re-append in sorted order
    tableBody.innerHTML = '';
    sortedRows.forEach((row, index) => {
      const numberCell = row.querySelector('td:first-child');
      if (numberCell) numberCell.textContent = String(index + 1);
      tableBody!.appendChild(row);
    });

    mobileCardsContainer.innerHTML = '';
    sortedCards.forEach(card => mobileCardsContainer!.appendChild(card));
  }

  function sortByRarity() {
    if (!tableBody || !mobileCardsContainer) return;

    // Get visible rows
    const visibleRows = originalRows.filter(row => row.style.display !== 'none');

    // Sort by rarity (5-Star first)
    const sortedRows = [...visibleRows].sort((a, b) => {
      const rarityA = rarityOrder[a.dataset.rarity || ''] ?? 99;
      const rarityB = rarityOrder[b.dataset.rarity || ''] ?? 99;
      return rarityA - rarityB;
    });

    // Get corresponding cards
    const sortedCards = sortedRows.map(row => {
      const idx = originalRows.indexOf(row);
      return originalCards[idx];
    }).filter(Boolean);

    // Re-append in sorted order
    tableBody.innerHTML = '';
    sortedRows.forEach((row, index) => {
      const numberCell = row.querySelector('td:first-child');
      if (numberCell) numberCell.textContent = String(index + 1);
      tableBody!.appendChild(row);
    });

    mobileCardsContainer.innerHTML = '';
    sortedCards.forEach(card => mobileCardsContainer!.appendChild(card));
  }

  // ==========================================
  // Reset Function
  // ==========================================

  function resetAll() {
    // Clear filters
    if (searchInput) searchInput.value = '';
    if (rarityFilter) rarityFilter.value = '';
    if (elementFilter) elementFilter.value = '';
    if (roleFilter) roleFilter.value = '';

    // Clear filter active states
    document.querySelectorAll('.filter-select').forEach(select => {
      select.classList.remove('active');
    });

    // Reset sort state
    currentSortKey = null;
    currentSortDirection = 'normal';
    updateSortButtons();

    // Show all rows and cards
    originalRows.forEach(row => row.style.display = '');
    originalCards.forEach(card => card.style.display = '');

    // Sort by rarity (default)
    sortByRarity();
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDatabase);
  } else {
    initializeDatabase();
  }
</script>
