---
// Stella Sora Individual Team Build Page
import TeamBuildIndividualLayout from '../../../../layouts/stella-sora/TeamBuildIndividualLayout.astro';
import { getAllTeamBuilds } from '../../../../data/stella-sora/team-builds.js';
import SSPotentialAllImage from '../../../../components/stella-sora/SSPotentialAllImage.astro';
import SSCharacterImage from '../../../../components/stella-sora/SSCharacterImage.astro';

// Parse description with params at specific level
const parseDescription = (desc: string, params: string[] = [], level: number = 1): string => {
  if (!desc) return '';
  let parsed = desc;

  // Replace &Param1&, &Param2&, etc. with actual values
  params.forEach((param, index) => {
    const placeholder = `&Param${index + 1}&`;
    let value = param;

    // Check if param has level scaling (contains "/")
    if (typeof param === 'string' && param.includes('/')) {
      const levels = param.split('/');
      value = levels[Math.min(level - 1, levels.length - 1)] || levels[0];
    }

    parsed = parsed.split(placeholder).join(`<strong>${value}</strong>`);
  });

  // Parse color tags
  parsed = parsed
    .replace(/<color=#0abec5>(.*?)<\/color>/gi, '<strong>$1</strong>')
    .replace(/<color=#ec6d21>(.*?)<\/color>/gi, '<strong>$1</strong>')
    .replace(/<color=[^>]+>(.*?)<\/color>/gi, '<strong>$1</strong>');

  // Parse skill references ##Name#ID#
  parsed = parsed.replace(/##([^#]+)#(\d+)#/g, '<strong>$1</strong>');

  // Replace vertical tab with space
  parsed = parsed.replace(/\u000b/g, ' ');

  return parsed;
};

export async function getStaticPaths() {
  const teamBuilds = getAllTeamBuilds();
  return teamBuilds.map(teamBuild => ({
    params: { slug: teamBuild.slug },
    props: { teamBuild },
  }));
}

const { teamBuild } = Astro.props;

const title = `${teamBuild.name} - Stella Sora Team Build`;
const description = `${teamBuild.description}`;
const hasBuildNotes = teamBuild.buildNotes && teamBuild.buildNotes.trim() !== '';
---

<TeamBuildIndividualLayout title={title} description={description} teamBuildName={teamBuild.name}>
  <div class="team-build-detail">
    <!-- Team Composition -->
    <section>
      <h2 class="team-build-section-title">Team Composition</h2>
      <div class="team-build-characters-grid">
        {
          teamBuild.characters.map(character => (
            <div class="team-character-card">
              <div class="team-character-avatar">
                <SSCharacterImage
                  imageName={character.image}
                  alt={character.name}
                  width={300}
                  height={300}
                  class="team-character-image"
                />
              </div>
              <div class="team-character-name">{character.name}</div>
              <div class="team-character-badges">
                <span class={`rarity-badge rarity-${character.grade || 5}`}>
                  {character.grade || 5}â˜…
                </span>
                <span class={`element-badge element-${character.element?.toLowerCase()}`}>
                  {character.element}
                </span>
              </div>
            </div>
          ))
        }
      </div>
    </section>

    <!-- Build Notes (only if has content) -->
    {
      hasBuildNotes && (
        <section>
          <h2 class="team-build-section-title">Build Notes</h2>
          <div class="team-build-notes">
            <div set:html={teamBuild.buildNotes} />
          </div>
        </section>
      )
    }

    <!-- Potential Builds -->
    {
      teamBuild.characterBuilds && (
        <section>
          <h2 class="team-build-section-title">Potential Builds</h2>
          {Object.entries(teamBuild.characterBuilds).map(([charKey, build]: [string, any]) => (
            <div class="character-potentials">
              <h3 class="character-build-title">
                {charKey
                  .split(' ')
                  .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                  .join(' ')}
                {build.buildName && ` - ${build.buildName}`}
              </h3>

              {build.potentialCategories &&
                Object.entries(build.potentialCategories).map(
                  ([_, category]: [string, any]) =>
                    category.potentials &&
                    category.potentials.length > 0 && (
                      <div class="potential-category">
                        <h4 class="category-title">{category.title}</h4>
                        <div class="potentials-list">
                          {category.potentials.map((potential: any) => {
                            const level = potential.recommendedLevel || 1;
                            return (
                              <div class="potential-item">
                                <div class="potential-icon-wrapper">
                                  <SSPotentialAllImage
                                    icon={potential.icon}
                                    rarity={potential.rarity}
                                    stype={potential.stype}
                                    alt={potential.name}
                                    width={60}
                                    height={60}
                                  />
                                  <span class="potential-level">Lv {level}</span>
                                </div>
                                <div class="potential-content">
                                  <h5 class="potential-name">{potential.name}</h5>
                                  <div
                                    class="potential-description"
                                    set:html={parseDescription(
                                      potential.shortDescription || potential.description,
                                      potential.params,
                                      level
                                    )}
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )
                )}
            </div>
          ))}
        </section>
      )
    }
  </div>
</TeamBuildIndividualLayout>
