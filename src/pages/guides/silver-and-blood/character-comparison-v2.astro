---
import CharacterComparisonV2Layout from '../../../layouts/silver-and-blood/CharacterComparisonV2Layout.astro';
import SABCharacterIcon from '../../../components/silver-and-blood/SABCharacterIcon.astro';
import SABFactionIcon from '../../../components/silver-and-blood/SABFactionIcon.astro';
import { Image } from 'astro:assets';
import { characters, rankings } from '../../../data/silver-and-blood/character-rankings.js';
import {
  PVE_TIER_LIST,
  PVP_TIER_LIST,
  CLAN_HUNT_TIER_LIST,
  BOSS_RAIDS_TIER_LIST,
  NEW_PLAYER_TIER_LIST,
} from '../../../data/silver-and-blood/tier-lists.js';

// Import icons
import roleAssassin from '../../../assets/images/games/silver-and-blood/icons/role/role_assassin.png';
import roleDefender from '../../../assets/images/games/silver-and-blood/icons/role/role_defender.png';
import roleEnchanter from '../../../assets/images/games/silver-and-blood/icons/role/role_enchanter.png';
import roleMarksman from '../../../assets/images/games/silver-and-blood/icons/role/role_marksman.png';
import roleSorcerer from '../../../assets/images/games/silver-and-blood/icons/role/role_sorcerer.png';
import roleWarrior from '../../../assets/images/games/silver-and-blood/icons/role/role_warrior.png';
import rarityGold from '../../../assets/images/games/silver-and-blood/character_icons/common_img_ssr.png';
import rarityPurple from '../../../assets/images/games/silver-and-blood/character_icons/common_img_sr.png';
import rarityBlue from '../../../assets/images/games/silver-and-blood/character_icons/common_img_r.png';
import moonNew from '../../../assets/images/games/silver-and-blood/icons/moon_phase/filter_icon_moon3.png';
import moonCrescent from '../../../assets/images/games/silver-and-blood/icons/moon_phase/filter_icon_moon2.png';
import moonFull from '../../../assets/images/games/silver-and-blood/icons/moon_phase/filter_icon_moon1.png';
import dmgMagical from '../../../assets/images/games/silver-and-blood/icons/damage_type/level_info_icon_attack_02.png';
import dmgPhysical from '../../../assets/images/games/silver-and-blood/icons/damage_type/level_info_icon_attack_03.png';
import dmgPierce from '../../../assets/images/games/silver-and-blood/icons/damage_type/level_info_icon_attack_04.png';
import equipLight from '../../../assets/images/games/silver-and-blood/icons/equipment_type/EquipType_Light.png';
import equipMedium from '../../../assets/images/games/silver-and-blood/icons/equipment_type/EquipType_Medium.png';
import equipHeavy from '../../../assets/images/games/silver-and-blood/icons/equipment_type/EquipType_Heavy.png';

// Icon maps
const roleImages: Record<string, ImageMetadata> = {
  Assassin: roleAssassin, Defender: roleDefender, Enchanter: roleEnchanter,
  Marksman: roleMarksman, Sorcerer: roleSorcerer, Warrior: roleWarrior,
};
const rarityImages: Record<string, ImageMetadata> = { SSR: rarityGold, SR: rarityPurple, R: rarityBlue };
const moonPhaseImages: Record<string, ImageMetadata> = {
  'filter_icon_moon1.png': moonFull, 'filter_icon_moon2.png': moonCrescent, 'filter_icon_moon3.png': moonNew,
};
const damageTypeImages: Record<string, ImageMetadata> = {
  'level_info_icon_attack_02.png': dmgMagical, 'level_info_icon_attack_03.png': dmgPhysical, 'level_info_icon_attack_04.png': dmgPierce,
};
const equipmentTypeImages: Record<string, ImageMetadata> = {
  'EquipType_Light.png': equipLight, 'EquipType_Medium.png': equipMedium, 'EquipType_Heavy.png': equipHeavy,
};

// Get unique values for filters
const classes = [...new Set(characters.map(c => c.class).filter(Boolean))].sort();
const factions = [...new Set(characters.map(c => c.faction).filter(Boolean))].sort();
const equipmentTypes = [...new Set(characters.map(c => c.equipmentType).filter(Boolean))].sort();
const moonPhases = [...new Set(characters.map(c => c.moonPhase).filter(Boolean))].sort();
const attackTypes = [...new Set(characters.map(c => c.attackType).filter(Boolean))].sort();
const rarities = ['SSR', 'SR', 'R'];

// Sort characters alphabetically
const sortedCharacters = [...characters].sort((a, b) => a.name.localeCompare(b.name));

// Helper function to get tier for a character
function getCharacterTier(charName: string, tierList: any): string {
  if (!tierList?.tiers) return 'Unranked';
  for (const [tierKey, chars] of Object.entries(tierList.tiers)) {
    if (Array.isArray(chars) && chars.some((c: any) => c.name === charName)) {
      return tierKey;
    }
  }
  return 'Unranked';
}

const title = 'Character Comparison Tool V2 - Silver and Blood';
const description =
  'Advanced Silver and Blood character comparison tool. Compare 2 heroes side-by-side: combat stats (HP/ATK/P.DEF/M.DEF), tier rankings, skills, team synergies. Filter by class, faction, moon phase, equipment type.';

// Prepare tier lists for client-side
const tierLists = {
  pve: PVE_TIER_LIST,
  pvp: PVP_TIER_LIST,
  clanHunt: CLAN_HUNT_TIER_LIST,
  bossRaids: BOSS_RAIDS_TIER_LIST,
  newPlayer: NEW_PLAYER_TIER_LIST,
};
---

<CharacterComparisonV2Layout title={title} description={description}>
  <div class="comparison-v2-page-content">
    <!-- Page Header Section -->
    <div class="page-header-section">
      <div class="usage-tips">
        <h3>How to Use</h3>
        <ul>
          <li><strong>Desktop:</strong> Click character icons to select up to 2 heroes for comparison</li>
          <li><strong>Mobile:</strong> Tap character selection buttons to open modal picker</li>
          <li>Use filters to find specific characters by class, faction, rarity, equipment, moon phase, or attack type</li>
        </ul>
        <p class="char-count">{sortedCharacters.length} characters available</p>
      </div>
    </div>

    <!-- Character Selection Header -->
    <div class="character-deck-header">
      <div class="deck-header-container">
        <div class="deck-header-main">
          <!-- Title Row -->
          <div class="deck-header-title-row">
            <h2 class="deck-title">Select Characters</h2>
            <span class="selected-count" id="v2-selected-count">0/2 selected</span>
          </div>

          <!-- Filters Row -->
          <div class="deck-header-controls-row">
            <div class="deck-header-controls">
              <div class="deck-filters-compact">
                <select class="filter-select-compact" id="v2-class-filter">
                  <option value="">All Classes</option>
                  {classes.map(c => <option value={c}>{c}</option>)}
                </select>
                <select class="filter-select-compact" id="v2-faction-filter">
                  <option value="">All Factions</option>
                  {factions.map(f => <option value={f}>{f}</option>)}
                </select>
                <select class="filter-select-compact" id="v2-rarity-filter">
                  <option value="">All Rarities</option>
                  {rarities.map(r => <option value={r}>{r}</option>)}
                </select>
              </div>
              <div class="button-group">
                <button class="reset-filters-btn" id="v2-reset-filters">Reset</button>
                <button class="clear-all-btn" id="v2-clear-all">Clear All</button>
              </div>
            </div>
          </div>

          <!-- Character Selection Area -->
          <div class="character-selection-area">
            <!-- Desktop Icons Strip -->
            <div class="character-icons-strip desktop-only">
              <div class="character-icons-container" id="v2-character-icons">
                {sortedCharacters.map(char => (
                  <div
                    class="character-icon"
                    data-character-id={char.id}
                    data-class={char.class}
                    data-rarity={char.rarity}
                    data-faction={char.faction}
                    title={`${char.name} (${char.rarity} ${char.class})`}
                    role="button"
                    tabindex="0"
                  >
                    <div class="character-icon-portrait">
                      <SABCharacterIcon name={char.name} variant="Base" size="large" width={120} height={160} loading="lazy" />
                      <Image src={rarityImages[char.rarity]} alt={char.rarity} class="icon-rarity-frame" width={36} height={36} loading="lazy" />
                    </div>
                    <span class="character-icon-name">{char.name}</span>
                  </div>
                ))}
              </div>
            </div>

            <!-- Mobile Selection Buttons -->
            <div class="character-selection-mobile mobile-only">
              <div class="character-selection-row">
                <div class="character-selection-slot">
                  <label class="character-slot-label">Character 1:</label>
                  <button class="character-selection-button" id="v2-mobile-select-1" data-slot="1">
                    <div class="selection-button-content" id="v2-mobile-display-1">
                      <div class="selection-placeholder">
                        <span class="selection-icon">+</span>
                        <span class="selection-text">Select Character 1</span>
                      </div>
                    </div>
                  </button>
                </div>
                <div class="character-selection-slot">
                  <label class="character-slot-label">Character 2:</label>
                  <button class="character-selection-button" id="v2-mobile-select-2" data-slot="2">
                    <div class="selection-button-content" id="v2-mobile-display-2">
                      <div class="selection-placeholder">
                        <span class="selection-icon">+</span>
                        <span class="selection-text">Select Character 2</span>
                      </div>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparison Container -->
    <div class="comparison-container-external">
      <div class="comparison-container">
        <div class="comparison-header">
          <h2 class="comparison-title">Character Comparison</h2>
        </div>

        <!-- Empty State -->
        <div class="empty-comparison-message" id="v2-empty-message">
          <p>Select characters from the deck above to start comparing</p>
          <small>You can compare up to 2 characters at once</small>
        </div>

        <!-- Pre-rendered Comparison Cards (hidden by default) -->
        <div class="comparison-cards-container hidden" id="v2-comparison-container">
          <div class="comparison-cards-grid" id="v2-cards-grid">
            {sortedCharacters.map(char => {
              const pveTier = getCharacterTier(char.name, PVE_TIER_LIST);
              const pvpTier = getCharacterTier(char.name, PVP_TIER_LIST);
              const clanHuntTier = getCharacterTier(char.name, CLAN_HUNT_TIER_LIST);
              const bossRaidsTier = getCharacterTier(char.name, BOSS_RAIDS_TIER_LIST);
              const newPlayerTier = getCharacterTier(char.name, NEW_PLAYER_TIER_LIST);
              const hpRank = rankings.hp?.[char.id] ?? 'N/A';
              const atkRank = rankings.atk?.[char.id] ?? 'N/A';
              const pDefRank = rankings.pDef?.[char.id] ?? 'N/A';
              const mDefRank = rankings.mDef?.[char.id] ?? 'N/A';

              return (
                <div class="comparison-character-card" data-card-id={char.id} style="display: none;">
                  <button class="comparison-card-remove" title="Remove character" aria-label={`Remove ${char.name}`}>×</button>

                  <!-- Card Header -->
                  <div class="comparison-card-header">
                    <div class="comparison-card-portrait">
                      <SABCharacterIcon name={char.name} variant="Base" size="large" width={160} height={160} loading="lazy" />
                      <Image src={rarityImages[char.rarity]} alt={char.rarity} class="card-rarity-frame" width={48} height={48} loading="lazy" />
                    </div>
                    <div class="comparison-card-info">
                      <h3 class="comparison-card-name">{char.name}</h3>
                      {char.title && <p class="comparison-card-title">{char.title}</p>}
                      <div class="comparison-card-icons">
                        {roleImages[char.class] && <Image src={roleImages[char.class]} alt={char.class} width={20} height={20} class="card-icon" title={char.class} />}
                        {char.faction && <SABFactionIcon faction={char.faction} width={20} height={20} class="card-icon" />}
                        {moonPhaseImages[char.moonPhaseIcon] && <Image src={moonPhaseImages[char.moonPhaseIcon]} alt="Moon" width={20} height={20} class="card-icon" title={char.moonPhase} />}
                        {damageTypeImages[char.damageTypeIcon] && <Image src={damageTypeImages[char.damageTypeIcon]} alt="Damage" width={20} height={20} class="card-icon" title={char.attackType} />}
                        {equipmentTypeImages[char.equipmentTypeIcon] && <Image src={equipmentTypeImages[char.equipmentTypeIcon]} alt="Equipment" width={20} height={20} class="card-icon" title={char.equipmentType} />}
                      </div>
                    </div>
                  </div>

                  <!-- Stats Sections -->
                  <div class="comparison-card-stats">
                    <!-- Tier Rankings -->
                    <div class="comparison-stat-section">
                      <h4>Tier Rankings</h4>
                      <div class="comparison-stat-grid">
                        <div class="comparison-stat-item"><span class="comparison-stat-label">PvE</span><span class={`comparison-stat-value tier-${pveTier.toLowerCase()}`}>{pveTier}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">PvP</span><span class={`comparison-stat-value tier-${pvpTier.toLowerCase()}`}>{pvpTier}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">Clan Hunt</span><span class={`comparison-stat-value tier-${clanHuntTier.toLowerCase()}`}>{clanHuntTier}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">Boss Raids</span><span class={`comparison-stat-value tier-${bossRaidsTier.toLowerCase()}`}>{bossRaidsTier}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">New Player</span><span class={`comparison-stat-value tier-${newPlayerTier.toLowerCase()}`}>{newPlayerTier}</span></div>
                      </div>
                    </div>

                    <!-- Stat Rankings -->
                    <div class="comparison-stat-section">
                      <h4>Stat Rankings (out of {sortedCharacters.length})</h4>
                      <div class="comparison-stat-grid">
                        <div class="comparison-stat-item"><span class="comparison-stat-label">HP Rank</span><span class="comparison-stat-value">{hpRank !== 'N/A' ? `#${hpRank}` : 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">ATK Rank</span><span class="comparison-stat-value">{atkRank !== 'N/A' ? `#${atkRank}` : 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">P.DEF Rank</span><span class="comparison-stat-value">{pDefRank !== 'N/A' ? `#${pDefRank}` : 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">M.DEF Rank</span><span class="comparison-stat-value">{mDefRank !== 'N/A' ? `#${mDefRank}` : 'N/A'}</span></div>
                      </div>
                    </div>

                    <!-- Base Stats -->
                    <div class="comparison-stat-section">
                      <h4>Base Stats (Lv.200)</h4>
                      <div class="comparison-stat-grid">
                        <div class="comparison-stat-item"><span class="comparison-stat-label">HP</span><span class="comparison-stat-value">{char.stats.hp?.toLocaleString() || 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">ATK</span><span class="comparison-stat-value">{char.stats.atk?.toLocaleString() || 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">P.DEF</span><span class="comparison-stat-value">{char.stats.pDef?.toLocaleString() || 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">M.DEF</span><span class="comparison-stat-value">{char.stats.mDef?.toLocaleString() || 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">Blood Power</span><span class="comparison-stat-value">{char.stats.bloodPower?.toLocaleString() || 'N/A'}</span></div>
                      </div>
                    </div>

                    <!-- Character Details -->
                    <div class="comparison-stat-section">
                      <h4>Character Details</h4>
                      <div class="comparison-stat-grid">
                        <div class="comparison-stat-item"><span class="comparison-stat-label">Faction</span><span class="comparison-stat-value">{char.faction || 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">Equipment</span><span class="comparison-stat-value">{char.equipmentType || 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">Moon Phase</span><span class="comparison-stat-value">{char.moonPhase || 'N/A'}</span></div>
                        <div class="comparison-stat-item"><span class="comparison-stat-label">Attack Type</span><span class="comparison-stat-value">{char.attackType || 'N/A'}</span></div>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Modal -->
    <div class="mobile-character-modal" id="v2-mobile-modal">
      <div class="modal-backdrop" id="v2-modal-backdrop"></div>
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title" id="v2-modal-title">Select Character</h3>
          <button class="modal-close-btn" id="v2-modal-close" aria-label="Close">×</button>
        </div>
        <div class="modal-search-bar">
          <input type="text" class="modal-search-input" id="v2-modal-search" placeholder="Search characters..." autocomplete="off" />
        </div>
        <div class="modal-character-grid" id="v2-modal-character-grid">
          {sortedCharacters.map(char => (
            <div
              class="modal-character-card"
              data-character-id={char.id}
              data-class={char.class}
              data-rarity={char.rarity}
              data-faction={char.faction}
              role="button"
              tabindex="0"
            >
              <div class="modal-character-portrait">
                <SABCharacterIcon name={char.name} variant="Base" size="large" width={140} height={140} loading="lazy" />
                <Image src={rarityImages[char.rarity]} alt={char.rarity} class="modal-rarity-frame" width={40} height={40} loading="lazy" />
              </div>
              <div class="modal-character-info">
                <span class="modal-character-name">{char.name}</span>
                <div class="modal-character-icons">
                  {roleImages[char.class] && <Image src={roleImages[char.class]} alt={char.class} width={14} height={14} class="modal-icon" />}
                  {char.faction && <SABFactionIcon faction={char.faction} width={14} height={14} class="modal-icon" />}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ characters: sortedCharacters }}>
    'use strict';

    const MAX_CHARACTERS = 2;
    const selectedCharacters = [];
    let filteredCharacters = [...characters];
    const charMap = new Map(characters.map(c => [c.id, c]));

    // DOM cache
    const $ = id => document.getElementById(id);
    const iconsContainer = $('v2-character-icons');
    const selectedCount = $('v2-selected-count');
    const emptyMessage = $('v2-empty-message');
    const comparisonContainer = $('v2-comparison-container');
    const cardsGrid = $('v2-cards-grid');
    const mobileModal = $('v2-mobile-modal');
    let currentMobileSlot = null;

    document.addEventListener('DOMContentLoaded', () => {
      initializeFilters();
      initializeIconInteractions();
      initializeMobileModal();
      initializeComparisonControls();
      initializeRemoveButtons();
      updateAllDisplays();
    });

    function initializeFilters() {
      ['v2-class-filter', 'v2-faction-filter', 'v2-rarity-filter'].forEach(id => {
        const el = $(id);
        if (el) el.addEventListener('change', applyFilters);
      });
      const resetBtn = $('v2-reset-filters');
      if (resetBtn) resetBtn.addEventListener('click', resetFilters);
    }

    function initializeIconInteractions() {
      if (iconsContainer) {
        iconsContainer.addEventListener('click', handleIconClick);
        iconsContainer.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleIconClick(e);
          }
        });
      }
    }

    function initializeMobileModal() {
      const mobileSelect1 = $('v2-mobile-select-1');
      const mobileSelect2 = $('v2-mobile-select-2');
      if (mobileSelect1) mobileSelect1.addEventListener('click', () => openMobileModal(1));
      if (mobileSelect2) mobileSelect2.addEventListener('click', () => openMobileModal(2));

      const closeBtn = $('v2-modal-close');
      const backdrop = $('v2-modal-backdrop');
      if (closeBtn) closeBtn.addEventListener('click', closeMobileModal);
      if (backdrop) backdrop.addEventListener('click', closeMobileModal);

      document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && mobileModal?.classList.contains('open')) closeMobileModal();
      });

      const searchInput = $('v2-modal-search');
      if (searchInput) searchInput.addEventListener('input', e => updateModalGrid(e.target.value.toLowerCase()));

      const modalGrid = $('v2-modal-character-grid');
      if (modalGrid) modalGrid.addEventListener('click', handleModalCardClick);
    }

    function initializeComparisonControls() {
      const clearBtn = $('v2-clear-all');
      if (clearBtn) clearBtn.addEventListener('click', clearAllCharacters);
    }

    function initializeRemoveButtons() {
      cardsGrid?.querySelectorAll('.comparison-card-remove').forEach(btn => {
        btn.addEventListener('click', e => {
          const card = e.target.closest('.comparison-character-card');
          if (card) removeCharacter(card.dataset.cardId);
        });
      });
    }

    function handleIconClick(e) {
      const icon = e.target.closest('.character-icon');
      if (!icon) return;
      const charId = icon.dataset.characterId;
      if (!charId) return;
      if (icon.classList.contains('selected')) {
        removeCharacter(charId);
      } else {
        addCharacter(charId);
      }
    }

    function addCharacter(charId) {
      if (selectedCharacters.includes(charId)) return;
      if (selectedCharacters.length >= MAX_CHARACTERS) {
        showNotification('Maximum 2 characters can be compared', 'warning');
        return;
      }
      selectedCharacters.push(charId);
      updateAllDisplays();
      if (selectedCharacters.length === MAX_CHARACTERS && window.innerWidth > 768) {
        setTimeout(() => comparisonContainer?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
      }
    }

    function removeCharacter(charId) {
      const index = selectedCharacters.indexOf(charId);
      if (index > -1) {
        selectedCharacters.splice(index, 1);
        updateAllDisplays();
      }
    }

    function clearAllCharacters() {
      selectedCharacters.length = 0;
      updateAllDisplays();
    }

    function applyFilters() {
      const filters = {
        class: $('v2-class-filter')?.value || '',
        faction: $('v2-faction-filter')?.value || '',
        rarity: $('v2-rarity-filter')?.value || '',
      };
      filteredCharacters = characters.filter(char =>
        (!filters.class || char.class === filters.class) &&
        (!filters.faction || char.faction === filters.faction) &&
        (!filters.rarity || char.rarity === filters.rarity)
      );
      updateIconStates();
    }

    function resetFilters() {
      ['v2-class-filter', 'v2-faction-filter', 'v2-rarity-filter'].forEach(id => {
        const el = $(id);
        if (el) el.value = '';
      });
      filteredCharacters = [...characters];
      updateIconStates();
    }

    function updateIconStates() {
      const filteredIds = new Set(filteredCharacters.map(c => c.id));
      const selectedSet = new Set(selectedCharacters);
      document.querySelectorAll('.character-icon').forEach(icon => {
        const charId = icon.dataset.characterId;
        icon.classList.toggle('selected', selectedSet.has(charId));
        icon.classList.toggle('filtered-out', !filteredIds.has(charId));
      });
    }

    function updateSelectedCount() {
      if (selectedCount) selectedCount.textContent = `${selectedCharacters.length}/${MAX_CHARACTERS} selected`;
    }

    function updateComparisonCards() {
      // Hide all cards first
      cardsGrid?.querySelectorAll('.comparison-character-card').forEach(card => {
        card.style.display = 'none';
      });

      // Show selected cards
      selectedCharacters.forEach(charId => {
        const card = cardsGrid?.querySelector(`[data-card-id="${charId}"]`);
        if (card) card.style.display = 'flex';
      });

      // Toggle container visibility
      if (selectedCharacters.length === 0) {
        emptyMessage?.classList.remove('hidden');
        comparisonContainer?.classList.add('hidden');
      } else {
        emptyMessage?.classList.add('hidden');
        comparisonContainer?.classList.remove('hidden');
      }
    }

    function openMobileModal(slot) {
      if (!mobileModal) return;
      currentMobileSlot = slot;
      const title = $('v2-modal-title');
      if (title) title.textContent = `Select Character ${slot}`;
      const searchInput = $('v2-modal-search');
      if (searchInput) searchInput.value = '';
      updateModalGrid('');
      updateModalSelectionStates();
      mobileModal.classList.add('open');
      document.body.style.overflow = 'hidden';
      if (searchInput) setTimeout(() => searchInput.focus(), 100);
    }

    function closeMobileModal() {
      if (!mobileModal) return;
      mobileModal.classList.remove('open');
      document.body.style.overflow = '';
      currentMobileSlot = null;
    }

    function handleModalCardClick(e) {
      const card = e.target.closest('.modal-character-card');
      if (!card || !currentMobileSlot) return;
      const charId = card.dataset.characterId;
      if (!charId) return;
      selectedCharacters[currentMobileSlot - 1] = charId;
      const cleaned = selectedCharacters.filter(Boolean);
      selectedCharacters.length = 0;
      cleaned.forEach(id => selectedCharacters.push(id));
      updateAllDisplays();
      closeMobileModal();
      if (selectedCharacters.length === MAX_CHARACTERS) {
        setTimeout(() => comparisonContainer?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 300);
      }
    }

    function updateModalGrid(searchTerm) {
      document.querySelectorAll('.modal-character-card').forEach(card => {
        const charId = card.dataset.characterId;
        const char = charMap.get(charId);
        if (!char) { card.classList.add('filtered-out'); return; }
        const matches = !searchTerm || char.name.toLowerCase().includes(searchTerm);
        card.classList.toggle('filtered-out', !matches);
      });
    }

    function updateModalSelectionStates() {
      const selectedSet = new Set(selectedCharacters);
      document.querySelectorAll('.modal-character-card').forEach(card => {
        card.classList.toggle('selected', selectedSet.has(card.dataset.characterId));
      });
    }

    function updateMobileSelectionButtons() {
      [1, 2].forEach(slot => {
        const charId = selectedCharacters[slot - 1];
        const char = charId ? charMap.get(charId) : null;
        const display = $(`v2-mobile-display-${slot}`);
        if (!display) return;
        if (char) {
          display.innerHTML = `
            <div class="selected-character-display">
              <div class="selected-character-info">
                <span class="selected-character-name">${char.name}</span>
                <span class="selected-character-details">${char.rarity} ${char.faction || ''}</span>
              </div>
              <button class="selection-remove-btn" data-slot="${slot}" title="Remove">×</button>
            </div>
          `;
          display.querySelector('.selection-remove-btn')?.addEventListener('click', e => {
            e.stopPropagation();
            selectedCharacters[slot - 1] = null;
            const cleaned = selectedCharacters.filter(Boolean);
            selectedCharacters.length = 0;
            cleaned.forEach(id => selectedCharacters.push(id));
            updateAllDisplays();
          });
        } else {
          display.innerHTML = `
            <div class="selection-placeholder">
              <span class="selection-icon">+</span>
              <span class="selection-text">Select Character ${slot}</span>
            </div>
          `;
        }
      });
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `comparison-notification comparison-notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    function updateAllDisplays() {
      requestAnimationFrame(() => {
        updateIconStates();
        updateMobileSelectionButtons();
        updateComparisonCards();
        updateSelectedCount();
      });
    }
  </script>
</CharacterComparisonV2Layout>
