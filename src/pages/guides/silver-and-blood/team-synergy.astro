---
// Import the dedicated layout
import TeamSynergyLayout from '../../../layouts/silver-and-blood/TeamSynergyLayout.astro';
import SABCharacterIcon from '../../../components/silver-and-blood/SABCharacterIcon.astro';
import { Image } from 'astro:assets';
import { SILVER_AND_BLOOD_TEAMS, getTeamTypeText } from '../../../data/silver-and-blood/team-synergy.js';
import { characters } from '../../../data/silver-and-blood/characters.js';

// Import rarity frame images
import rarityGold from '../../../assets/images/games/silver-and-blood/character_icons/common_img_ssr.png';
import rarityPurple from '../../../assets/images/games/silver-and-blood/character_icons/common_img_sr.png';
import rarityBlue from '../../../assets/images/games/silver-and-blood/character_icons/common_img_r.png';

const rarityImages: Record<string, ImageMetadata> = {
  'SSR': rarityGold,
  'SR': rarityPurple,
  'R': rarityBlue,
};

// Helper to get character rarity
function getCharacterRarity(characterName: string): string {
  const character = characters.find(
    (char: any) => char.name.toLowerCase() === characterName.toLowerCase()
  );
  return character?.rarity || 'SSR';
}

// Helper to get icon name from character name
function getIconName(name: string): string {
  const nameMap: Record<string, string> = {
    'Timeless Aiona': 'Aiona_Covenant',
    'Fleeting Bella': 'Bella_Summer_Base',
    'Transcendent Ami': 'Ami_Covenant',
    'Starry-eyed Aiona': 'Aiona_Lily',
    'Jinxed Selena': 'Selena_Summer',
    'Van Helsing': 'VanHellsing',
    'Incendiary Agares': 'Agares_Covenant',
    'Transcendent Hati': 'Hati_Covenant',
    'Transcendent Noah': 'Noah_Covenant',
    'Spectral Gilrain': 'Gilrain_Shadow',
    'Thibault': 'Hippocratic',
    'Sirene': 'Siegrune',
  };
  return nameMap[name] || name.split(' ')[0];
}

// Helper to get character URL
function getCharacterUrl(characterName: string): string {
  const slug = characterName
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9-]/g, '')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
  return `/guides/silver-and-blood/characters/${slug}`;
}

// Helper for shorter display names
function getDisplayName(characterName: string): string {
  const shortNames: Record<string, string> = {
    'Starry-eyed Aiona': 'S.Aiona',
    'Transcendent Ami': 'T.Ami',
    'Fleeting Bella': 'F.Bella',
    'Jinxed Selena': 'J.Selena',
    'Timeless Aiona': 'T.Aiona',
    'Van Helsing': 'Van H.',
    'Incendiary Agares': 'I.Agares',
  };
  return shortNames[characterName] || characterName;
}

// Use teams as-is (order defined in data file)
const teams = SILVER_AND_BLOOD_TEAMS;
---

<TeamSynergyLayout
  title="Silver and Blood Team Builds - GachaWiki"
  description="Sortable and filterable team composition database for Silver and Blood - Clan Hunt teams, Boss teams, and recommended team compositions"
  gameTitle="Team Builds"
>
  <section class="page-flex">
    <div class="main-content-container">
      <div class="content-wrapper">
        <div
          style="text-align: center; margin: 1.5rem 0; padding: 1rem; background: var(--sab-input-bg); border-radius: 12px; border: 1px solid var(--sab-border-light);"
        >
          <p style="color: var(--sab-muted-gold); margin: 0; font-size: 1rem; font-weight: 600;">
            Team Builds
          </p>
          <p
            style="color: var(--sab-text-muted); margin: 0.5rem 0 0 0; font-size: 0.9rem; font-style: italic;"
          >
            Team building has changed quite a bit, now it's mostly about synergy units and there's little room to build anything outside of that!
          </p>
        </div>

        <!-- Team Database Filter Bar -->
        <div class="team-database-filter-bar">
          <div class="filter-controls">
            <select class="filter-select" id="teamTypeFilter">
              <option value="">All Team Types</option>
              <option value="clan-hunt">Clan Hunt</option>
              <option value="boss">Boss Fight</option>
              <option value="map-clear">Map Clear</option>
              <option value="void-shadow">Void Shadow</option>
              <option value="moon-phase">Moon Phase</option>
              <option value="pvp">PvP</option>
            </select>
            <button class="reset-btn" id="resetFilters">Reset</button>
          </div>
        </div>

        <!-- Team Cards (unified layout for desktop and mobile) -->
        <div class="team-card-view" id="teamCards">
          {teams.map((team) => (
            <div class="team-card" data-type={team.type}>
              <div class="team-card-header">
                <h3 class="team-card-title">{team.name}</h3>
                <span class={`team-type-badge ${team.type}`}>{getTeamTypeText(team.type)}</span>
              </div>

              <div class="team-card-characters">
                {team.characters.map((char, index) => {
                  const rarity = getCharacterRarity(char.name);
                  const subRarity = char.substitute ? getCharacterRarity(char.substitute) : null;
                  return (
                    <div class="team-character-item">
                      <div class="character-position">{index + 1}</div>
                      <div class="character-with-substitute">
                        <div class="character-single">
                          <div class="character-icon-wrapper">
                            <SABCharacterIcon
                              name={getIconName(char.name)}
                              size="large"
                              class="team-character-portrait"
                              width={60}
                              height={60}
                            />
                            <Image
                              src={rarityImages[rarity] || rarityGold}
                              alt={rarity}
                              class="rarity-frame"
                              width={24}
                              height={24}
                            />
                          </div>
                          <a href={getCharacterUrl(char.name)} class="team-character-name-link">
                            <span class="team-character-name">{char.name}</span>
                          </a>
                        </div>
                        {char.substitute && (
                          <>
                            <div class="substitute-divider">
                              <span class="substitute-label">Alt</span>
                            </div>
                            <div class="character-single substitute-character">
                              <div class="character-icon-wrapper substitute">
                                <SABCharacterIcon
                                  name={getIconName(char.substitute)}
                                  size="large"
                                  class="team-character-portrait"
                                  width={60}
                                  height={60}
                                />
                                <Image
                                  src={rarityImages[subRarity || 'SSR'] || rarityGold}
                                  alt={subRarity || 'SSR'}
                                  class="rarity-frame"
                                  width={24}
                                  height={24}
                                />
                              </div>
                              <a href={getCharacterUrl(char.substitute)} class="team-character-name-link">
                                <span class="team-character-name">{char.substitute}</span>
                              </a>
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {team.notes && <div class="team-card-notes">{team.notes}</div>}
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Client-side filtering script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const typeFilter = document.getElementById('teamTypeFilter') as HTMLSelectElement;
      const resetBtn = document.getElementById('resetFilters');
      const teamCards = document.querySelectorAll('.team-card[data-type]');

      function filterTeams() {
        const typeValue = typeFilter?.value || '';
        teamCards.forEach((card) => {
          const type = card.getAttribute('data-type');
          const matchesType = !typeValue || type === typeValue;
          (card as HTMLElement).style.display = matchesType ? '' : 'none';
        });
      }

      typeFilter?.addEventListener('change', filterTeams);
      resetBtn?.addEventListener('click', () => {
        if (typeFilter) typeFilter.value = '';
        filterTeams();
      });
    });
  </script>
</TeamSynergyLayout>

<style>
  /* Character icon wrapper with rarity frame */
  .character-icon-wrapper {
    position: relative;
    display: inline-block;
  }

  .character-icon-wrapper :global(.team-character-portrait) {
    border-radius: 10px;
    display: block;
  }

  .character-icon-wrapper .rarity-frame {
    position: absolute;
    top: -6px;
    right: -6px;
    z-index: 1;
  }

  /* Substitute character styles */
  .character-with-substitute {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .character-single {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
  }

  .substitute-divider {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 0.4rem;
  }

  .substitute-label {
    color: var(--sab-muted-gold);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    background: var(--sab-bg-dark);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--sab-muted-gold);
  }

  .substitute-character {
    opacity: 0.85;
  }

  /* Mobile adjustments */
  @media (max-width: 480px) {
    .character-icon-wrapper .rarity-frame {
      width: 20px;
      height: 20px;
      top: -4px;
      right: -4px;
    }

    .substitute-label {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
    }
  }
</style>
