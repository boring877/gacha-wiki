---
// Busty Burst Character Profiles & Voice Actors Page
// Lists all characters with their personal profiles, illustrators, and voice actors

import CharacterInfoLayout from '../../../layouts/busty-burst/CharacterInfoLayout.astro';
import PaladinImage from '../../../components/busty-burst/PaladinImage.astro';
import ElementImage from '../../../components/busty-burst/ElementImage.astro';
import PositionImage from '../../../components/busty-burst/PositionImage.astro';
import RarityImage from '../../../components/busty-burst/RarityImage.astro';
import WeaponIcon from '../../../components/busty-burst/WeaponIcon.astro';
import { getAllCharacters } from '../../../data/busty-burst/character-info.js';
import { BUSTY_BURST_PALADINS } from '../../../data/busty-burst/paladins.js';

// Get all characters
const characters = getAllCharacters();

const title = 'Busty Burst Character Profiles & Voice Actors';
const description = `Complete Busty Burst character profiles. View personal info, illustrators, and voice actors for all ${characters.length} characters.`;
const gameTitle = 'Character Profiles & Voice Actors';

// Map image filename to characterId using paladins data
const getCharacterId = (imageName: string) => {
  const paladin = BUSTY_BURST_PALADINS.find(p =>
    p.fileName === imageName ||
    p.fileName.toLowerCase() === imageName.toLowerCase()
  );
  return paladin?.characterId || 2001;
};

// Map position roman numeral to position image filename
const getPositionFileName = (roman: string) => {
  const posMap: Record<string, string> = {
    'I': 'Front.png',
    'II': 'Mid.png',
    'III': 'Back.png',
  };
  return posMap[roman] || 'Front.png';
};

// Map position roman numeral to position name
const getPositionName = (roman: string) => {
  const posMap: Record<string, string> = {
    'I': 'Front',
    'II': 'Mid',
    'III': 'Back',
  };
  return posMap[roman] || 'Front';
};
---

<CharacterInfoLayout title={title} description={description} gameTitle={gameTitle}>
  <div class="bb-character-info-page">
    <!-- Stats Overview -->
    <div class="bb-character-info-stats">
      <h2>Overview</h2>
      <div class="bb-character-info-stats-grid">
        <div class="bb-character-info-stat-card">
          <div class="bb-character-info-stat-number">{characters.length}</div>
          <div class="bb-character-info-stat-label">Total Characters</div>
        </div>
        <div class="bb-character-info-stat-card">
          <div class="bb-character-info-stat-number">
            {characters.filter(c => c.role === 'Attacker').length}
          </div>
          <div class="bb-character-info-stat-label">Attackers</div>
        </div>
        <div class="bb-character-info-stat-card">
          <div class="bb-character-info-stat-number">
            {characters.filter(c => c.role === 'Support').length}
          </div>
          <div class="bb-character-info-stat-label">Supports</div>
        </div>
        <div class="bb-character-info-stat-card">
          <div class="bb-character-info-stat-number">
            {characters.filter(c => c.role === 'Tank').length}
          </div>
          <div class="bb-character-info-stat-label">Tanks</div>
        </div>
      </div>
    </div>

    <!-- Filter Controls -->
    <div class="bb-character-info-controls">
      <div class="bb-character-info-filter-row">
        <input
          type="text"
          id="character-search"
          class="bb-character-info-search-input"
          placeholder="Search by name, illustrator, or voice actor..."
        />
        <select id="element-filter" class="bb-character-info-filter-select">
          <option value="">All Elements</option>
          <option value="Fire">Fire</option>
          <option value="Water">Water</option>
          <option value="Wind">Wind</option>
          <option value="Light">Light</option>
          <option value="Dark">Dark</option>
        </select>
        <select id="role-filter" class="bb-character-info-filter-select">
          <option value="">All Roles</option>
          <option value="Attacker">Attacker</option>
          <option value="Support">Support</option>
          <option value="Tank">Tank</option>
        </select>
        <select id="rarity-filter" class="bb-character-info-filter-select">
          <option value="">All Rarities</option>
          <option value="SSR">SSR</option>
          <option value="SR">SR</option>
        </select>
        <select id="weapon-filter" class="bb-character-info-filter-select">
          <option value="">All Weapons</option>
          <option value="Slash">Slash</option>
          <option value="Pierce">Pierce</option>
          <option value="Strike">Strike</option>
          <option value="Shoot">Shoot</option>
          <option value="Throw">Throw</option>
        </select>
        <button type="button" id="clear-filters" class="bb-character-info-clear-btn">
          Clear All
        </button>
      </div>
    </div>

    <!-- Character Cards Grid -->
    <div class="bb-character-info-grid" id="character-grid">
      {
        characters.map(char => (
          <div
            class="bb-character-info-card"
            data-name={char.displayName.toLowerCase()}
            data-element={char.element}
            data-role={char.role}
            data-rarity={char.rarity}
            data-weapon={char.weaponType}
            data-illustrator={char.credits.illustration.romanized.toLowerCase()}
            data-voice={char.credits.voice.romanized.toLowerCase()}
          >
            <div class="bb-character-info-card-header">
              <div class="bb-character-info-avatar">
                <PaladinImage
                  characterId={getCharacterId(char.image)}
                  alt={char.displayName}
                  width={160}
                  height={160}
                  quality={95}
                />
              </div>
              <div class="bb-character-info-header-text">
                <h3 class="bb-character-info-name">{char.displayName}</h3>
                <div class="bb-character-info-rarity">
                  <RarityImage rarity={char.rarity} width={56} height={56} />
                </div>
              </div>
            </div>
            <div class="bb-character-info-card-body">
              <!-- Combat Info Section -->
              <div class="bb-character-info-combat">
                <div class="bb-character-info-combat-item">
                  <div class="bb-character-info-combat-icon">
                    <ElementImage element={char.element} width={24} height={24} />
                  </div>
                  <div class="bb-character-info-combat-text">
                    <span class="bb-character-info-combat-label">Element</span>
                    <span class="bb-character-info-combat-value">{char.element}</span>
                  </div>
                </div>
                <div class="bb-character-info-combat-item">
                  <div class="bb-character-info-combat-text">
                    <span class="bb-character-info-combat-label">Role</span>
                    <span class="bb-character-info-combat-value">{char.role}</span>
                  </div>
                </div>
                <div class="bb-character-info-combat-item">
                  <div class="bb-character-info-combat-icon">
                    <PositionImage
                      fileName={getPositionFileName(char.position.roman)}
                      alt={getPositionName(char.position.roman)}
                      width={28}
                      height={28}
                    />
                  </div>
                  <div class="bb-character-info-combat-text">
                    <span class="bb-character-info-combat-label">Position</span>
                  </div>
                </div>
                <div class="bb-character-info-combat-item">
                  <div class="bb-character-info-combat-text">
                    <span class="bb-character-info-combat-label">Attack</span>
                    <span class="bb-character-info-combat-value">{char.attackType}</span>
                  </div>
                </div>
                <div class="bb-character-info-combat-item">
                  <div class="bb-character-info-combat-icon">
                    <WeaponIcon weapon={char.weaponType === 'Shoot' ? 'Shot' : char.weaponType} width={24} height={24} />
                  </div>
                  <div class="bb-character-info-combat-text">
                    <span class="bb-character-info-combat-label">Weapon</span>
                    <span class="bb-character-info-combat-value">{char.weaponType}</span>
                  </div>
                </div>
                <div class="bb-character-info-combat-item">
                  <div class="bb-character-info-combat-text">
                    <span class="bb-character-info-combat-label">Speed</span>
                    <span class="bb-character-info-combat-value">{char.actionSpeed}</span>
                  </div>
                </div>
                <div class="bb-character-info-combat-item">
                  <div class="bb-character-info-combat-text">
                    <span class="bb-character-info-combat-label">Range</span>
                    <span class="bb-character-info-combat-value">{char.range}</span>
                  </div>
                </div>
              </div>

              <!-- Personal Profile Section -->
              <div class="bb-character-info-profile">
                <div class="bb-character-info-profile-title">Personal Profile</div>
                <div class="bb-character-info-profile-grid">
                  <div class="bb-character-info-profile-item">
                    <span class="bb-character-info-profile-label">Height</span>
                    <span class="bb-character-info-profile-value">{char.profile.height}</span>
                  </div>
                  <div class="bb-character-info-profile-item">
                    <span class="bb-character-info-profile-label">Bust</span>
                    <span class="bb-character-info-profile-value">{char.profile.bust}</span>
                  </div>
                  <div class="bb-character-info-profile-item">
                    <span class="bb-character-info-profile-label">Waist</span>
                    <span class="bb-character-info-profile-value">{char.profile.waist}</span>
                  </div>
                  <div class="bb-character-info-profile-item">
                    <span class="bb-character-info-profile-label">Hips</span>
                    <span class="bb-character-info-profile-value">{char.profile.hips}</span>
                  </div>
                </div>
              </div>
              <div class="bb-character-info-credits">
                <div class="bb-character-info-credit-item">
                  <span class="bb-character-info-credit-label">Illustrator</span>
                  <span class="bb-character-info-credit-value">
                    {char.credits.illustration.japanese}
                    {char.credits.illustration.romanized !== char.credits.illustration.japanese && (
                      <span class="bb-character-info-credit-romanized">
                        ({char.credits.illustration.romanized})
                      </span>
                    )}
                  </span>
                </div>
                <div class="bb-character-info-credit-item">
                  <span class="bb-character-info-credit-label">Voice Actor</span>
                  <span class="bb-character-info-credit-value">
                    {char.credits.voice.japanese}
                    {char.credits.voice.romanized !== char.credits.voice.japanese && (
                      <span class="bb-character-info-credit-romanized">
                        ({char.credits.voice.romanized})
                      </span>
                    )}
                  </span>
                </div>
                <div class="bb-character-info-credit-item">
                  <span class="bb-character-info-credit-label">Obtain</span>
                  <span class="bb-character-info-credit-value">
                    <span class="bb-badge bb-badge-obtain" data-obtain={char.obtain.type}>
                      {char.obtain.type}
                    </span>
                    {char.obtain.source}
                  </span>
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <!-- No Results Message -->
    <div class="bb-character-info-no-results" id="no-results">
      <h3>No characters found</h3>
      <p>Try adjusting your search or filter criteria.</p>
    </div>
  </div>
</CharacterInfoLayout>

<script>
  // Filter functionality
  function initFilters() {
    const searchInput = document.getElementById('character-search') as HTMLInputElement;
    const elementFilter = document.getElementById('element-filter') as HTMLSelectElement;
    const roleFilter = document.getElementById('role-filter') as HTMLSelectElement;
    const rarityFilter = document.getElementById('rarity-filter') as HTMLSelectElement;
    const weaponFilter = document.getElementById('weapon-filter') as HTMLSelectElement;
    const clearBtn = document.getElementById('clear-filters') as HTMLButtonElement;
    const characterGrid = document.getElementById('character-grid');
    const noResults = document.getElementById('no-results');

    if (!characterGrid) return;

    const cards = characterGrid.querySelectorAll('.bb-character-info-card');

    function filterCards() {
      const searchTerm = searchInput?.value.toLowerCase() || '';
      const elementValue = elementFilter?.value || '';
      const roleValue = roleFilter?.value || '';
      const rarityValue = rarityFilter?.value || '';
      const weaponValue = weaponFilter?.value || '';

      let visibleCount = 0;

      cards.forEach(card => {
        const cardEl = card as HTMLElement;
        const name = cardEl.dataset.name || '';
        const element = cardEl.dataset.element || '';
        const role = cardEl.dataset.role || '';
        const rarity = cardEl.dataset.rarity || '';
        const weapon = cardEl.dataset.weapon || '';
        const illustrator = cardEl.dataset.illustrator || '';
        const voice = cardEl.dataset.voice || '';

        // Check search term
        const matchesSearch =
          !searchTerm ||
          name.includes(searchTerm) ||
          illustrator.includes(searchTerm) ||
          voice.includes(searchTerm);

        // Check filters
        const matchesElement = !elementValue || element === elementValue;
        const matchesRole = !roleValue || role === roleValue;
        const matchesRarity = !rarityValue || rarity === rarityValue;
        const matchesWeapon = !weaponValue || weapon === weaponValue;

        const isVisible =
          matchesSearch && matchesElement && matchesRole && matchesRarity && matchesWeapon;

        cardEl.classList.toggle('hidden', !isVisible);
        if (isVisible) visibleCount++;
      });

      // Show/hide no results message
      if (noResults) {
        noResults.classList.toggle('visible', visibleCount === 0);
      }
    }

    // Clear all filters
    function clearFilters() {
      if (searchInput) searchInput.value = '';
      if (elementFilter) elementFilter.value = '';
      if (roleFilter) roleFilter.value = '';
      if (rarityFilter) rarityFilter.value = '';
      if (weaponFilter) weaponFilter.value = '';
      filterCards();
    }

    // Add event listeners
    searchInput?.addEventListener('input', filterCards);
    elementFilter?.addEventListener('change', filterCards);
    roleFilter?.addEventListener('change', filterCards);
    rarityFilter?.addEventListener('change', filterCards);
    weaponFilter?.addEventListener('change', filterCards);
    clearBtn?.addEventListener('click', clearFilters);
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFilters);
  } else {
    initFilters();
  }
</script>
