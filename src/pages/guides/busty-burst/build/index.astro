---
import BuildLandingLayout from '../../../../layouts/busty-burst/BuildLandingLayout.astro';
import { buildConfig } from '../../../../data/busty-burst/build.js';
import PaladinImage from '../../../../components/busty-burst/PaladinImage.astro';
import RarityImage from '../../../../components/busty-burst/RarityImage.astro';
import ElementImage from '../../../../components/busty-burst/ElementImage.astro';
import WeaponIcon from '../../../../components/busty-burst/WeaponIcon.astro';
import TypeofATKImage from '../../../../components/busty-burst/TypeofATKImage.astro';
import { BUSTY_BURST_PALADINS } from '../../../../data/busty-burst/paladins.js';

const { meta, characters } = buildConfig;

// Helper to get characterId from fileName
const getCharacterId = (fileName: string) => {
  const paladin = BUSTY_BURST_PALADINS.find(p =>
    p.fileName === fileName ||
    p.fileName.toLowerCase() === fileName.toLowerCase()
  );
  return paladin?.characterId || 2001;
};
---

<BuildLandingLayout
  title={meta.title}
  description={meta.description}
  gameTitle={meta.gameTitle}
  showTitle={true}
>
  <div class="bb-build-page-container">
    <section class="bb-build-content-section">
      <h2 class="bb-build-section-title">Available Builds</h2>

      <!-- Search and Filter Controls -->
      <div class="bb-build-controls">
        <input
          type="text"
          id="character-search"
          class="bb-build-search-input"
          placeholder="Search by name..."
        />
        <select id="element-filter" class="bb-build-filter-select">
          <option value="">All Elements</option>
          <option value="Fire">Fire</option>
          <option value="Water">Water</option>
          <option value="Wind">Wind</option>
          <option value="Light">Light</option>
          <option value="Dark">Dark</option>
          <option value="Mind">Mind</option>
        </select>
        <select id="rarity-filter" class="bb-build-filter-select">
          <option value="">All Rarities</option>
          <option value="SSR">SSR</option>
          <option value="SR">SR</option>
        </select>
        <select id="tier-filter" class="bb-build-filter-select">
          <option value="">All Tiers</option>
          <option value="SSS">SSS Tier</option>
          <option value="SS">SS Tier</option>
          <option value="S">S Tier</option>
          <option value="A">A Tier</option>
        </select>
        <button type="button" id="clear-filters" class="bb-build-clear-btn">
          Clear
        </button>
      </div>

      <div class="bb-build-grid" id="build-grid">
        {
          characters.map(character => (
            <a
              href={character.buildLink}
              class="bb-build-card"
              data-name={character.name.toLowerCase()}
              data-element={character.element}
              data-rarity={character.rarity}
              data-tier={character.tier}
            >
              <div class="bb-build-card-image">
                <PaladinImage
                  characterId={getCharacterId(character.fileName)}
                  alt={character.name}
                  width={120}
                  height={120}
                  quality={95}
                  loading="eager"
                />
              </div>
              <div class="bb-build-card-info">
                <h3 class="bb-build-card-name">{character.name}</h3>
                <div class="bb-build-card-icons">
                  <RarityImage rarity={character.rarity} width={64} height={32} class="bb-build-rarity-img" />
                  <ElementImage element={character.element} width={24} height={24} />
                  <TypeofATKImage fileName={`${character.attackType}.png`} alt={character.attackType} width={24} height={24} />
                  <WeaponIcon weapon={character.weaponType || 'Slash'} width={24} height={24} />
                </div>
              </div>
            </a>
          ))
        }
      </div>

      <!-- No Results Message -->
      <div class="bb-build-no-results" id="no-results">
        <h3>No builds found</h3>
        <p>Try adjusting your search or filter criteria.</p>
      </div>
    </section>
  </div>
</BuildLandingLayout>

<style>
  /* Search and Filter Controls */
  .bb-build-controls {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .bb-build-search-input {
    flex: 1;
    min-width: 200px;
    padding: 0.6rem 1rem;
    border: 1px solid var(--bb-border, #374151);
    border-radius: 0.5rem;
    background: var(--bb-bg-secondary, #1f2937);
    color: var(--bb-text-primary, #fff);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .bb-build-search-input:focus {
    border-color: var(--bb-accent, #3b82f6);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }

  .bb-build-search-input::placeholder {
    color: var(--bb-text-muted, #6b7280);
  }

  .bb-build-filter-select {
    padding: 0.6rem 1rem;
    border: 1px solid var(--bb-border, #374151);
    border-radius: 0.5rem;
    background: var(--bb-bg-secondary, #1f2937);
    color: var(--bb-text-primary, #fff);
    font-size: 0.9rem;
    cursor: pointer;
    outline: none;
    min-width: 120px;
  }

  .bb-build-filter-select:focus {
    border-color: var(--bb-accent, #3b82f6);
  }

  .bb-build-clear-btn {
    padding: 0.6rem 1.25rem;
    border: 1px solid var(--bb-border, #374151);
    border-radius: 0.5rem;
    background: var(--bb-bg-secondary, #1f2937);
    color: var(--bb-text-primary, #fff);
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .bb-build-clear-btn:hover {
    background: var(--bb-bg-tertiary, #374151);
  }

  /* No Results Message */
  .bb-build-no-results {
    display: none;
    text-align: center;
    padding: 3rem 1rem;
    color: var(--bb-text-muted, #9ca3af);
  }

  .bb-build-no-results.visible {
    display: block;
  }

  .bb-build-no-results h3 {
    margin-bottom: 0.5rem;
    color: var(--bb-text-secondary, #d1d5db);
  }

  /* Hidden state for cards */
  .bb-build-card.hidden {
    display: none;
  }

  .bb-build-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  .bb-build-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bb-bg-secondary);
    border: 1px solid var(--bb-border);
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
  }

  .bb-build-card:hover {
    border-color: var(--bb-primary, #ff6b6b);
  }

  .bb-build-card-image {
    width: 80px;
    height: 80px;
    flex-shrink: 0;
    border-radius: 6px;
    overflow: hidden;
    background: var(--bb-bg-primary);
    border: 1px solid var(--bb-border);
  }

  .bb-build-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .bb-build-card-info {
    flex: 1;
    min-width: 0;
  }

  .bb-build-card-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--bb-text-primary);
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
  }

  .bb-build-card-icons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .bb-build-card-icons img {
    flex-shrink: 0;
  }

  .bb-build-card-icons img.bb-build-rarity-img {
    width: 64px !important;
    height: 32px !important;
    object-fit: contain;
  }

  .bb-build-card-icons .typeofattk-image-wrapper {
    display: flex;
    align-items: center;
  }

  @media (max-width: 600px) {
    .bb-build-grid {
      grid-template-columns: 1fr;
    }

    .bb-build-card {
      padding: 0.875rem;
    }

    .bb-build-card-image {
      width: 70px;
      height: 70px;
    }

    .bb-build-card-name {
      font-size: 0.95rem;
    }

    .bb-build-card-icons {
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .bb-build-card-icons img {
      width: 20px !important;
      height: 20px !important;
    }

    .bb-build-card-icons img.bb-build-rarity-img {
      width: 48px !important;
      height: 24px !important;
    }
  }

  /* Mobile optimization for controls */
  @media (max-width: 768px) {
    .bb-build-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .bb-build-search-input {
      min-width: 100%;
    }

    .bb-build-filter-select,
    .bb-build-clear-btn {
      width: 100%;
    }
  }
</style>

<script>
  // Search and filter functionality
  function initSearch() {
    const searchInput = document.getElementById('character-search') as HTMLInputElement;
    const elementFilter = document.getElementById('element-filter') as HTMLSelectElement;
    const rarityFilter = document.getElementById('rarity-filter') as HTMLSelectElement;
    const tierFilter = document.getElementById('tier-filter') as HTMLSelectElement;
    const clearBtn = document.getElementById('clear-filters') as HTMLButtonElement;
    const noResults = document.getElementById('no-results');
    const buildGrid = document.getElementById('build-grid');

    if (!buildGrid) return;

    const cards = buildGrid.querySelectorAll('.bb-build-card');

    function filterCards() {
      const searchTerm = searchInput?.value.toLowerCase().trim() || '';
      const elementValue = elementFilter?.value || '';
      const rarityValue = rarityFilter?.value || '';
      const tierValue = tierFilter?.value || '';

      let visibleCount = 0;

      cards.forEach(card => {
        const cardEl = card as HTMLElement;
        const name = cardEl.dataset.name || '';
        const element = cardEl.dataset.element || '';
        const rarity = cardEl.dataset.rarity || '';
        const tier = cardEl.dataset.tier || '';

        // Check search term
        const matchesSearch = !searchTerm || name.includes(searchTerm);

        // Check filters
        const matchesElement = !elementValue || element === elementValue;
        const matchesRarity = !rarityValue || rarity === rarityValue;
        const matchesTier = !tierValue || tier === tierValue;

        const isVisible = matchesSearch && matchesElement && matchesRarity && matchesTier;

        cardEl.classList.toggle('hidden', !isVisible);
        if (isVisible) visibleCount++;
      });

      // Show/hide no results message
      if (noResults) {
        noResults.classList.toggle('visible', visibleCount === 0);
      }
    }

    function clearFilters() {
      if (searchInput) searchInput.value = '';
      if (elementFilter) elementFilter.value = '';
      if (rarityFilter) rarityFilter.value = '';
      if (tierFilter) tierFilter.value = '';
      filterCards();
    }

    // Add event listeners
    searchInput?.addEventListener('input', filterCards);
    elementFilter?.addEventListener('change', filterCards);
    rarityFilter?.addEventListener('change', filterCards);
    tierFilter?.addEventListener('change', filterCards);
    clearBtn?.addEventListener('click', clearFilters);
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
</script>
