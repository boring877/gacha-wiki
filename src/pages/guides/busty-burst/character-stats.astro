---
// Busty Burst Character Stats Page
// Displays all character stats with interactive level calculator

import CharacterStatsLayout from '../../../layouts/busty-burst/CharacterStatsLayout.astro';
import PaladinImage from '../../../components/busty-burst/PaladinImage.astro';
import ElementImage from '../../../components/busty-burst/ElementImage.astro';
import {
  getAllCharacterStats,
  STAT_DISPLAY_NAMES,
} from '../../../data/busty-burst/character-stats-full.js';

// Get all character stats and sort by rarity: SSR -> SR -> R
const rarityOrder: Record<string, number> = { 'SSR': 0, 'SR': 1, 'R': 2 };
const characterStats = getAllCharacterStats().sort((a, b) => {
  return (rarityOrder[a.rarity] ?? 99) - (rarityOrder[b.rarity] ?? 99);
});

const title = 'Busty Burst Character Stats Guide';
const description = `Complete stats guide for all ${characterStats.length} Busty Burst characters. View base stats, level scaling, awakening bonuses, GP abilities, bond progression, limit break, and ability grade bonuses with an interactive level calculator.`;
const gameTitle = 'Character Stats Guide';

// Calculate total from nested bonus object (lb1, lb2, etc. or lv1, lv2, etc.)
// Excludes the 'total' key to avoid double counting
const calculateBonusTotal = (bonusObj: Record<string, Record<string, number>>) => {
  const total: Record<string, number> = {};
  Object.entries(bonusObj).forEach(([key, levelBonus]) => {
    // Skip the 'total' key - we calculate our own totals from individual levels
    if (key === 'total') return;
    if (typeof levelBonus === 'object') {
      Object.entries(levelBonus).forEach(([stat, value]) => {
        if (typeof value === 'number') {
          total[stat] = (total[stat] || 0) + value;
        }
      });
    }
  });
  return total;
};
---

<CharacterStatsLayout title={title} description={description} gameTitle={gameTitle}>
  <div class="bb-stats-page">
    <!-- Filter Controls -->
    <div class="bb-stats-controls">
      <div class="bb-stats-filter-row">
        <input
          type="text"
          id="stats-search"
          class="bb-stats-search-input"
          placeholder="Search by character name..."
        />
        <select id="element-filter" class="bb-stats-filter-select">
          <option value="">All Elements</option>
          <option value="Holy">Holy</option>
          <option value="Mind">Mind</option>
          <option value="Fire">Fire</option>
          <option value="Wind">Wind</option>
          <option value="Water">Water</option>
          <option value="Magic">Magic</option>
        </select>
        <select id="role-filter" class="bb-stats-filter-select">
          <option value="">All Roles</option>
          <option value="Attacker">Attacker</option>
          <option value="Support">Support</option>
          <option value="Tank">Tank</option>
        </select>
        <select id="rarity-filter" class="bb-stats-filter-select">
          <option value="">All Rarities</option>
          <option value="SSR">SSR</option>
          <option value="SR">SR</option>
          <option value="R">R</option>
        </select>
        <button type="button" id="clear-filters" class="bb-stats-clear-btn"> Clear All </button>
      </div>
      <p class="bb-stats-note">
        <strong>Note:</strong> The in-game stats display currently only includes Limit Break (up to LB4) and does not include Bond Level bonuses.
      </p>
      <p class="bb-stats-note bb-crit-note">
        <strong>Crit Rate Formula:</strong> Value ÷ 20 = Crit % (e.g., 100 = 5% crit rate). The game incorrectly displays "Crit Damage" in buff text - this actually affects Crit Rate.
      </p>
    </div>

    <!-- Character Stats Grid -->
    <div class="bb-stats-grid" id="stats-grid">
      {
        characterStats.map(char => (
          <div
            class="bb-stats-card"
            data-name={char.name.toLowerCase()}
            data-element={char.element.toLowerCase()}
            data-role={char.role.toLowerCase()}
            data-rarity={char.rarity.toLowerCase()}
            data-stats={JSON.stringify(char.baseStats)}
            data-gp-ability={JSON.stringify(char.gpAbility || {})}
            data-limit-break={JSON.stringify(char.limitBreak || {})}
            data-ability-grade={JSON.stringify(char.abilityGrade || {})}
            data-passive-abilities={JSON.stringify(char.passiveAbilities || [])}
          >
            <div class="bb-stats-card-header">
              <div class="bb-stats-card-avatar">
                <PaladinImage
                  characterId={char.characterId}
                  alt={char.name}
                  width={140}
                  height={140}
                  quality={95}
                />
              </div>
              <div class="bb-stats-card-info">
                <h3 class="bb-stats-card-name">{char.name}</h3>
                <div class="bb-stats-card-badges">
                  <span class="bb-badge" data-rarity={char.rarity}>
                    {char.rarity}
                  </span>
                  <span class="bb-badge" data-element={char.element}>
                    <ElementImage element={char.element} width={14} height={14} />
                    {char.element}
                  </span>
                  <span class="bb-badge" data-role={char.role}>
                    {char.role}
                  </span>
                </div>
              </div>
            </div>

            <div class="bb-stats-card-body">
              {/* Level Calculator */}
              <div class="bb-stats-calculator">
                <div class="bb-stats-calculator-header">
                  <span class="bb-stats-calculator-title">Level</span>
                  <div class="bb-stats-level-controls">
                    <div class="bb-stats-level-input-wrapper">
                      <button type="button" class="bb-stats-level-btn minus" data-level-minus>
                        −
                      </button>
                      <input
                        type="number"
                        class="bb-stats-level-input"
                        min="1"
                        max="90"
                        value="90"
                        data-level-input
                      />
                      <button type="button" class="bb-stats-level-btn plus" data-level-plus>
                        +
                      </button>
                    </div>
                  </div>
                  <div class="bb-stats-quick-levels">
                    <button type="button" class="bb-stats-quick-level-btn" data-level="1">
                      1
                    </button>
                    <button type="button" class="bb-stats-quick-level-btn" data-level="50">
                      50
                    </button>
                    <button type="button" class="bb-stats-quick-level-btn" data-level="70">
                      70
                    </button>
                    <button type="button" class="bb-stats-quick-level-btn active" data-level="90">
                      90
                    </button>
                  </div>
                </div>
              </div>

              {/* Base Stats Table */}
              <div class="bb-stats-table-section">
                <div class="bb-stats-section-title">Combat Stats</div>
                <div class="bb-stats-table" data-stats-table>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">HP</span>
                    <span class="bb-stats-table-value" data-stat="hp">
                      {char.baseStats.hp.lv90.toLocaleString()}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">ATK</span>
                    <span class="bb-stats-table-value" data-stat="atk">
                      {char.baseStats.atk.lv90.toLocaleString()}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">MATK</span>
                    <span class="bb-stats-table-value" data-stat="matk">
                      {char.baseStats.matk.lv90.toLocaleString()}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">DEF</span>
                    <span class="bb-stats-table-value" data-stat="def">
                      {char.baseStats.def.lv90.toLocaleString()}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">MDEF</span>
                    <span class="bb-stats-table-value" data-stat="mdef">
                      {char.baseStats.mdef.lv90.toLocaleString()}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">Accuracy</span>
                    <span class="bb-stats-table-value" data-stat="accuracy">
                      {char.baseStats.accuracy.lv90}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">Block</span>
                    <span class="bb-stats-table-value" data-stat="block">
                      {char.baseStats.block.lv90}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">P.Crit</span>
                    <span class="bb-stats-table-value crit-value" data-stat="physCrit">
                      {char.baseStats.physCrit.lv90}
                      <span class="crit-rate">({(char.baseStats.physCrit.lv90 / 20).toFixed(1)}%)</span>
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">M.Crit</span>
                    <span class="bb-stats-table-value crit-value" data-stat="magicCrit">
                      {char.baseStats.magicCrit.lv90}
                      <span class="crit-rate">({(char.baseStats.magicCrit.lv90 / 20).toFixed(1)}%)</span>
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">HP Regen</span>
                    <span class="bb-stats-table-value" data-stat="hpRegen">
                      {char.baseStats.hpRegen.lv90}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">MP Regen</span>
                    <span class="bb-stats-table-value" data-stat="mpRegen">
                      {char.baseStats.mpRegen.lv90}
                    </span>
                  </div>
                  <div class="bb-stats-table-item">
                    <span class="bb-stats-table-label">Heal Pwr</span>
                    <span class="bb-stats-table-value" data-stat="healPwr">
                      {char.baseStats.healPwr.lv90}
                    </span>
                  </div>
                </div>
                {/* Flat stats (no level scaling) */}
                <div class="bb-stats-flat" data-flat-stats>
                  <div class="bb-stats-flat-item">
                    <span class="bb-stats-flat-label">MP Charge:</span>
                    <span class="bb-stats-flat-value" data-flat="mpCharge">
                      {char.baseStats.mpCharge?.lv90 || char.baseStats.mpCharge || 0}
                    </span>
                  </div>
                  <div
                    class="bb-stats-flat-item"
                    style={(char.baseStats.hpDrain?.lv90 || 0) > 0 ? '' : 'display:none'}
                  >
                    <span class="bb-stats-flat-label">HP Drain:</span>
                    <span class="bb-stats-flat-value" data-flat="hpDrain">
                      {char.baseStats.hpDrain?.lv90 || 0}%
                    </span>
                  </div>
                  <div
                    class="bb-stats-flat-item"
                    style={(char.baseStats.mpCostDown?.lv90 || 0) > 0 ? '' : 'display:none'}
                  >
                    <span class="bb-stats-flat-label">MP Cost Down:</span>
                    <span class="bb-stats-flat-value" data-flat="mpCostDown">
                      {char.baseStats.mpCostDown?.lv90 || 0}
                    </span>
                  </div>
                </div>
              </div>

              {/* Bonus Stats - Hero Card Layout */}
              <div class="bb-hero-cards">
                {/* Limit Break Card */}
                <div class="bb-hero-card bb-hero-lb">
                  <div class="bb-hero-header">
                    <input type="checkbox" class="bb-hero-checkbox" data-bonus-check="limitBreak" checked />
                    <span class="bb-hero-title">Limit Break</span>
                    <div class="bb-hero-input-group">
                      <input type="number" class="bb-hero-input" data-bonus-input="limitBreak" min="0" max="5" value="5" />
                      <span class="bb-hero-input-max">/ 5</span>
                    </div>
                  </div>
                  <div class="bb-hero-stats" data-bonus-display="limitBreak">
                    {Object.entries(calculateBonusTotal(char.limitBreak || {})).map(([stat, value]) => (
                      <div class="bb-hero-stat-row">
                        <span class="bb-hero-stat-name">{STAT_DISPLAY_NAMES[stat] || stat}</span>
                        <span class="bb-hero-stat-value">+{value}</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Bond Level Card */}
                <div class="bb-hero-card bb-hero-bond">
                  <div class="bb-hero-header">
                    <input type="checkbox" class="bb-hero-checkbox" data-bonus-check="gpAbility" checked />
                    <span class="bb-hero-title">Bond Level</span>
                    <div class="bb-hero-input-group">
                      <input type="number" class="bb-hero-input" data-bonus-input="gpAbility" min="0" max="10" value="10" />
                      <span class="bb-hero-input-max">/ 10</span>
                    </div>
                  </div>
                  <div class="bb-hero-stats" data-bonus-display="gpAbility">
                    {Object.entries(calculateBonusTotal(char.gpAbility || {})).map(([stat, value]) => (
                      <div class="bb-hero-stat-row">
                        <span class="bb-hero-stat-name">{STAT_DISPLAY_NAMES[stat] || stat}</span>
                        <span class="bb-hero-stat-value">+{value}</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Ability Grade Card */}
                <div class="bb-hero-card bb-hero-grade">
                  <div class="bb-hero-header">
                    <input type="checkbox" class="bb-hero-checkbox" data-bonus-check="abilityGrade" checked />
                    <span class="bb-hero-title">Ability Grade</span>
                    <div class="bb-hero-input-group">
                      <input type="number" class="bb-hero-input" data-bonus-input="abilityGrade" min="0" max="10" value="10" />
                      <span class="bb-hero-input-max">/ 10</span>
                    </div>
                  </div>
                  <div class="bb-hero-stats" data-bonus-display="abilityGrade">
                    {Object.entries(calculateBonusTotal(char.abilityGrade || {})).map(([stat, value]) => (
                      <div class="bb-hero-stat-row">
                        <span class="bb-hero-stat-name">{STAT_DISPLAY_NAMES[stat] || stat}</span>
                        <span class="bb-hero-stat-value">+{value}</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Passive Abilities Card */}
                <div class="bb-hero-card bb-hero-passive">
                  <div class="bb-hero-header">
                    <input type="checkbox" class="bb-hero-checkbox" data-bonus-check="passive" checked />
                    <span class="bb-hero-title">Passives</span>
                    <div class="bb-hero-input-group">
                      <input type="number" class="bb-hero-input" data-bonus-input="passive" min="0" max="10" value="10" />
                      <span class="bb-hero-input-max">/ 10</span>
                    </div>
                  </div>
                  <div class="bb-hero-stats bb-hero-passive-list" data-passive-display>
                    {(char.passiveAbilities || []).map((passive) => (
                      <div class="bb-hero-stat-row" data-passive-slot={passive.slot}>
                        <span class="bb-hero-stat-name">{passive.stat}</span>
                        <span class="bb-hero-stat-value" data-passive-value={passive.slot}>+{passive.grades?.g10 || 0}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <!-- No Results Message -->
    <div class="bb-stats-no-results" id="no-results">
      <h3>No characters found</h3>
      <p>Try adjusting your search or filter criteria.</p>
    </div>
  </div>
</CharacterStatsLayout>

<script>
  // Calculate stat at any level
  function calculateStatAtLevel(base: number, lv90: number, level: number): number {
    if (level <= 1) return base;
    if (level >= 90) return lv90;
    const growth = lv90 - base;
    const perLevel = growth / 89;
    return Math.floor(base + perLevel * (level - 1));
  }

  // Calculate crit rate from raw value
  function calculateCritRate(critValue: number): string {
    return (critValue / 20).toFixed(2);
  }

  // Filter functionality
  function initFilters() {
    const searchInput = document.getElementById('stats-search') as HTMLInputElement;
    const elementFilter = document.getElementById('element-filter') as HTMLSelectElement;
    const roleFilter = document.getElementById('role-filter') as HTMLSelectElement;
    const rarityFilter = document.getElementById('rarity-filter') as HTMLSelectElement;
    const clearBtn = document.getElementById('clear-filters') as HTMLButtonElement;
    const statsGrid = document.getElementById('stats-grid');
    const noResults = document.getElementById('no-results');

    if (!statsGrid) return;

    const cards = statsGrid.querySelectorAll('.bb-stats-card');

    function filterCards() {
      const searchTerm = searchInput?.value.toLowerCase() || '';
      const elementValue = elementFilter?.value.toLowerCase() || '';
      const roleValue = roleFilter?.value.toLowerCase() || '';
      const rarityValue = rarityFilter?.value.toLowerCase() || '';

      let visibleCount = 0;

      cards.forEach(card => {
        const cardEl = card as HTMLElement;
        const name = cardEl.dataset.name || '';
        const element = cardEl.dataset.element || '';
        const role = cardEl.dataset.role || '';
        const rarity = cardEl.dataset.rarity || '';

        const matchesSearch = !searchTerm || name.includes(searchTerm);
        const matchesElement = !elementValue || element === elementValue;
        const matchesRole = !roleValue || role === roleValue;
        const matchesRarity = !rarityValue || rarity === rarityValue;

        const isVisible = matchesSearch && matchesElement && matchesRole && matchesRarity;

        cardEl.classList.toggle('hidden', !isVisible);
        if (isVisible) visibleCount++;
      });

      if (noResults) {
        noResults.classList.toggle('visible', visibleCount === 0);
      }
    }

    function clearFilters() {
      if (searchInput) searchInput.value = '';
      if (elementFilter) elementFilter.value = '';
      if (roleFilter) roleFilter.value = '';
      if (rarityFilter) rarityFilter.value = '';
      filterCards();
    }

    searchInput?.addEventListener('input', filterCards);
    elementFilter?.addEventListener('change', filterCards);
    roleFilter?.addEventListener('change', filterCards);
    rarityFilter?.addEventListener('change', filterCards);
    clearBtn?.addEventListener('click', clearFilters);
  }

  // Level calculator functionality with bonus support
  function initLevelCalculators() {
    const cards = document.querySelectorAll('.bb-stats-card');

    cards.forEach(card => {
      const cardEl = card as HTMLElement;
      const levelInput = card.querySelector('[data-level-input]') as HTMLInputElement;
      const minusBtn = card.querySelector('[data-level-minus]') as HTMLButtonElement;
      const plusBtn = card.querySelector('[data-level-plus]') as HTMLButtonElement;
      const quickBtns = card.querySelectorAll('.bb-stats-quick-level-btn');
      const statsTable = card.querySelector('[data-stats-table]');
      const flatStats = card.querySelector('[data-flat-stats]');
      const statsData = JSON.parse(cardEl.dataset.stats || '{}');
      const gpAbilityData = JSON.parse(cardEl.dataset.gpAbility || '{}');
      const limitBreakData = JSON.parse(cardEl.dataset.limitBreak || '{}');
      const abilityGradeData = JSON.parse(cardEl.dataset.abilityGrade || '{}');
      const passiveAbilitiesData = JSON.parse(cardEl.dataset.passiveAbilities || '[]');

      // Get bonus input elements
      const limitBreakInput = card.querySelector('[data-bonus-input="limitBreak"]') as HTMLInputElement;
      const gpAbilityInput = card.querySelector('[data-bonus-input="gpAbility"]') as HTMLInputElement;
      const abilityGradeInput = card.querySelector('[data-bonus-input="abilityGrade"]') as HTMLInputElement;
      const passiveInput = card.querySelector('[data-bonus-input="passive"]') as HTMLInputElement;

      // Get bonus checkbox elements
      const limitBreakCheck = card.querySelector('[data-bonus-check="limitBreak"]') as HTMLInputElement;
      const gpAbilityCheck = card.querySelector('[data-bonus-check="gpAbility"]') as HTMLInputElement;
      const abilityGradeCheck = card.querySelector('[data-bonus-check="abilityGrade"]') as HTMLInputElement;
      const passiveCheck = card.querySelector('[data-bonus-check="passive"]') as HTMLInputElement;

      // Get hero card bonus display elements
      const limitBreakDisplay = card.querySelector('[data-bonus-display="limitBreak"]');
      const gpAbilityDisplay = card.querySelector('[data-bonus-display="gpAbility"]');
      const abilityGradeDisplay = card.querySelector('[data-bonus-display="abilityGrade"]');
      const passiveGradeLabel = card.querySelector('[data-passive-grade]');

      if (!levelInput || !statsTable) return;

      // Calculate bonus up to a specific level for limit break (lb1-lb5)
      function calculateLimitBreakBonus(level: number): Record<string, number> {
        const bonuses: Record<string, number> = {};
        for (let i = 1; i <= level; i++) {
          const lbKey = `lb${i}`;
          if (limitBreakData[lbKey]) {
            Object.entries(limitBreakData[lbKey]).forEach(([stat, value]) => {
              if (typeof value === 'number') {
                bonuses[stat] = (bonuses[stat] || 0) + value;
              }
            });
          }
        }
        return bonuses;
      }

      // Calculate bonus up to a specific level for GP ability (lv1-lv10)
      function calculateGpAbilityBonus(level: number): Record<string, number> {
        const bonuses: Record<string, number> = {};
        for (let i = 1; i <= level; i++) {
          const lvKey = `lv${i}`;
          if (gpAbilityData[lvKey]) {
            Object.entries(gpAbilityData[lvKey]).forEach(([stat, value]) => {
              if (typeof value === 'number') {
                bonuses[stat] = (bonuses[stat] || 0) + value;
              }
            });
          }
        }
        return bonuses;
      }

      // Calculate bonus up to a specific grade for ability grade (g1-g10)
      function calculateAbilityGradeBonus(grade: number): Record<string, number> {
        const bonuses: Record<string, number> = {};
        for (let i = 1; i <= grade; i++) {
          const gKey = `g${i}`;
          if (abilityGradeData[gKey]) {
            Object.entries(abilityGradeData[gKey]).forEach(([stat, value]) => {
              if (typeof value === 'number') {
                bonuses[stat] = (bonuses[stat] || 0) + value;
              }
            });
          }
        }
        return bonuses;
      }

      // Get passive abilities for a specific grade (with cumulative values)
      function getPassiveAbilitiesAtGrade(grade: number): Array<{slot: number; stat: string; value: number}> {
        const results: Array<{slot: number; stat: string; value: number}> = [];

        passiveAbilitiesData.forEach((passive: any) => {
          // Handle new format: grades is an array with per-grade stat types (like Ophelio slot 5)
          if (Array.isArray(passive.grades)) {
            const displayGrade = grade === 0 ? 10 : grade;
            const gradeData = passive.grades.find((g: any) => g.grade === displayGrade);

            if (gradeData && gradeData.cumulative) {
              // Has cumulative data - show all stats
              Object.entries(gradeData.cumulative).forEach(([stat, value]: [string, any]) => {
                if (value > 0 || displayGrade === 10) {
                  results.push({
                    slot: passive.slot,
                    stat,
                    value: grade > 0 ? value : 0
                  });
                }
              });
            } else {
              // Fallback: calculate cumulative manually
              const totals: Record<string, number> = {};
              passive.grades.forEach((g: any) => {
                if (g.grade <= displayGrade) {
                  totals[g.stat] = (totals[g.stat] || 0) + g.value;
                }
              });
              Object.entries(totals).forEach(([stat, value]) => {
                results.push({
                  slot: passive.slot,
                  stat,
                  value: grade > 0 ? value : 0
                });
              });
            }
          } else {
            // Handle standard format: grades object now has cumulative values
            const stat = passive.stat;
            const value = grade > 0 ? (passive.grades?.[`g${grade}`] || 0) : 0;
            results.push({ slot: passive.slot, stat, value });
          }
        });

        return results;
      }

      // Update hero card bonus display
      function updateHeroCardDisplay(displayEl: Element | null, bonuses: Record<string, number>, statNames: Record<string, string>) {
        if (!displayEl) return;
        const entries = Object.entries(bonuses);
        if (entries.length === 0) {
          displayEl.innerHTML = '<div class="bb-hero-stat-row bb-hero-empty">No bonuses</div>';
        } else {
          displayEl.innerHTML = entries.map(([stat, value]) => {
            const displayName = statNames[stat] || stat;
            return `<div class="bb-hero-stat-row">
              <span class="bb-hero-stat-name">${displayName}</span>
              <span class="bb-hero-stat-value">+${value}</span>
            </div>`;
          }).join('');
        }
      }

      // Update passive abilities display
      function updatePassiveDisplay(grade: number) {
        const passives = getPassiveAbilitiesAtGrade(grade);
        passives.forEach(p => {
          const rowEl = card.querySelector(`[data-passive-slot="${p.slot}"]`);
          if (rowEl) {
            const nameEl = rowEl.querySelector('.bb-hero-stat-name');
            const valueEl = rowEl.querySelector('.bb-hero-stat-value');
            if (nameEl) nameEl.textContent = p.stat;
            if (valueEl) valueEl.textContent = grade > 0 ? `+${p.value}` : '-';
          }
        });
        if (passiveGradeLabel) {
          passiveGradeLabel.textContent = grade.toString();
        }
      }

      // Get active bonuses from inputs (only if checkbox is checked)
      function getActiveBonuses(): Record<string, number> {
        const bonuses: Record<string, number> = {};

        // Limit Break bonus (only if checked)
        if (limitBreakCheck?.checked) {
          const lbLevel = Math.min(5, Math.max(0, parseInt(limitBreakInput?.value || '5')));
          const lbBonuses = calculateLimitBreakBonus(lbLevel);
          Object.entries(lbBonuses).forEach(([stat, value]) => {
            bonuses[stat] = (bonuses[stat] || 0) + value;
          });
        }

        // GP Ability / Bond Level bonus (only if checked)
        if (gpAbilityCheck?.checked) {
          const gpLevel = Math.min(10, Math.max(0, parseInt(gpAbilityInput?.value || '10')));
          const gpBonuses = calculateGpAbilityBonus(gpLevel);
          Object.entries(gpBonuses).forEach(([stat, value]) => {
            bonuses[stat] = (bonuses[stat] || 0) + value;
          });
        }

        // Ability Grade bonus (only if checked)
        if (abilityGradeCheck?.checked) {
          const agGrade = Math.min(10, Math.max(0, parseInt(abilityGradeInput?.value || '10')));
          const agBonuses = calculateAbilityGradeBonus(agGrade);
          Object.entries(agBonuses).forEach(([stat, value]) => {
            bonuses[stat] = (bonuses[stat] || 0) + value;
          });
        }

        // Passive abilities bonus (only if checked)
        if (passiveCheck?.checked) {
          const passiveGrade = Math.min(10, Math.max(0, parseInt(passiveInput?.value || '10')));
          const passives = getPassiveAbilitiesAtGrade(passiveGrade);

          // Map passive stat names to stat keys
          const passiveStatMap: Record<string, string> = {
            'HP': 'hp', 'ATK': 'atk', 'MATK': 'matk', 'DEF': 'def', 'MDEF': 'mdef',
            'Accuracy': 'accuracy', 'Block': 'block', 'Phys Crit': 'physCrit', 'Magic Crit': 'magicCrit',
            'HP Regen': 'hpRegen', 'MP Regen': 'mpRegen', 'Heal Pwr': 'healPwr',
            'MP Charge': 'mpCharge', 'HP Drain': 'hpDrain'
          };

          passives.forEach(p => {
            const statKey = passiveStatMap[p.stat] || p.stat.toLowerCase();
            bonuses[statKey] = (bonuses[statKey] || 0) + p.value;
          });
        }

        return bonuses;
      }

      // Stat display names
      const STAT_NAMES: Record<string, string> = {
        hp: 'HP', atk: 'ATK', matk: 'MATK', def: 'DEF', mdef: 'MDEF',
        accuracy: 'Accuracy', block: 'Block', physCrit: 'P.Crit', magicCrit: 'M.Crit',
        hpRegen: 'HP Regen', mpRegen: 'MP Regen', healPwr: 'Heal Pwr',
        mpCharge: 'MP Charge', hpDrain: 'HP Drain', mpCostDown: 'MP Cost',
        healingPower: 'Heal Pwr'
      };

      function updateStats(level: number) {
        const bonuses = getActiveBonuses();
        updateStatsWithBonuses(level, bonuses);
      }

      function setLevel(level: number) {
        level = Math.max(1, Math.min(90, level));
        levelInput.value = level.toString();
        // Update stats with current bonus levels
        const bonuses = getActiveBonuses();
        updateStatsWithBonuses(level, bonuses);
      }

      function updateStatsWithBonuses(level: number, bonuses: Record<string, number>) {
        // Helper to get stat with bonus
        const getStatWithBonus = (statKey: string, baseValue: number) => {
          return baseValue + (bonuses[statKey] || 0);
        };

        // Update HP
        const hpEl = statsTable?.querySelector('[data-stat="hp"]');
        if (hpEl && statsData.hp) {
          const base = calculateStatAtLevel(statsData.hp.base, statsData.hp.lv90, level);
          const value = getStatWithBonus('hp', base);
          hpEl.textContent = value.toLocaleString();
        }

        // Update ATK
        const atkEl = statsTable?.querySelector('[data-stat="atk"]');
        if (atkEl && statsData.atk) {
          const base = calculateStatAtLevel(statsData.atk.base, statsData.atk.lv90, level);
          const value = getStatWithBonus('atk', base);
          atkEl.textContent = value.toLocaleString();
        }

        // Update MATK
        const matkEl = statsTable?.querySelector('[data-stat="matk"]');
        if (matkEl && statsData.matk) {
          const base = calculateStatAtLevel(statsData.matk.base, statsData.matk.lv90, level);
          const value = getStatWithBonus('matk', base);
          matkEl.textContent = value.toLocaleString();
        }

        // Update DEF
        const defEl = statsTable?.querySelector('[data-stat="def"]');
        if (defEl && statsData.def) {
          const base = calculateStatAtLevel(statsData.def.base, statsData.def.lv90, level);
          const value = getStatWithBonus('def', base);
          defEl.textContent = value.toLocaleString();
        }

        // Update MDEF
        const mdefEl = statsTable?.querySelector('[data-stat="mdef"]');
        if (mdefEl && statsData.mdef) {
          const base = calculateStatAtLevel(statsData.mdef.base, statsData.mdef.lv90, level);
          const value = getStatWithBonus('mdef', base);
          mdefEl.textContent = value.toLocaleString();
        }

        // Update Accuracy
        const accEl = statsTable?.querySelector('[data-stat="accuracy"]');
        if (accEl && statsData.accuracy) {
          const base = calculateStatAtLevel(statsData.accuracy.base, statsData.accuracy.lv90, level);
          const value = getStatWithBonus('accuracy', base);
          accEl.textContent = value.toString();
        }

        // Update Block
        const blockEl = statsTable?.querySelector('[data-stat="block"]');
        if (blockEl && statsData.block) {
          const base = calculateStatAtLevel(statsData.block.base, statsData.block.lv90, level);
          const value = getStatWithBonus('block', base);
          blockEl.textContent = value.toString();
        }

        // Update Phys Crit
        const physCritEl = statsTable?.querySelector('[data-stat="physCrit"]');
        if (physCritEl && statsData.physCrit) {
          const base = calculateStatAtLevel(statsData.physCrit.base, statsData.physCrit.lv90, level);
          const value = getStatWithBonus('physCrit', base);
          const rate = calculateCritRate(value);
          physCritEl.innerHTML = `${value}<span class="crit-rate">(${rate}%)</span>`;
        }

        // Update Magic Crit
        const magicCritEl = statsTable?.querySelector('[data-stat="magicCrit"]');
        if (magicCritEl && statsData.magicCrit) {
          const base = calculateStatAtLevel(statsData.magicCrit.base, statsData.magicCrit.lv90, level);
          const value = getStatWithBonus('magicCrit', base);
          const rate = calculateCritRate(value);
          magicCritEl.innerHTML = `${value}<span class="crit-rate">(${rate}%)</span>`;
        }

        // Update HP Regen
        const hpRegenEl = statsTable?.querySelector('[data-stat="hpRegen"]');
        if (hpRegenEl && statsData.hpRegen) {
          const base = calculateStatAtLevel(statsData.hpRegen.base, statsData.hpRegen.lv90, level);
          const value = getStatWithBonus('hpRegen', base);
          hpRegenEl.textContent = value.toString();
        }

        // Update MP Regen
        const mpRegenEl = statsTable?.querySelector('[data-stat="mpRegen"]');
        if (mpRegenEl && statsData.mpRegen) {
          const base = calculateStatAtLevel(statsData.mpRegen.base, statsData.mpRegen.lv90, level);
          const value = getStatWithBonus('mpRegen', base);
          mpRegenEl.textContent = value.toString();
        }

        // Update Heal Power
        const healPwrEl = statsTable?.querySelector('[data-stat="healPwr"]');
        if (healPwrEl && statsData.healPwr) {
          const base = calculateStatAtLevel(statsData.healPwr.base, statsData.healPwr.lv90, level);
          const value = getStatWithBonus('healPwr', base);
          healPwrEl.textContent = value.toString();
        }

        // Update flat stats
        if (flatStats) {
          const mpChargeEl = flatStats.querySelector('[data-flat="mpCharge"]');
          if (mpChargeEl) {
            const baseValue = statsData.mpCharge?.lv90 || statsData.mpCharge || 0;
            const value = baseValue + (bonuses.mpCharge || 0);
            mpChargeEl.textContent = value.toString();
          }

          const hpDrainEl = flatStats.querySelector('[data-flat="hpDrain"]');
          if (hpDrainEl) {
            const baseValue = statsData.hpDrain?.lv90 || statsData.hpDrain || 0;
            const value = baseValue + (bonuses.hpDrain || 0);
            hpDrainEl.textContent = value + '%';
            const parent = hpDrainEl.closest('.bb-stats-flat-item') as HTMLElement;
            if (parent) parent.style.display = value > 0 ? '' : 'none';
          }

          const mpCostEl = flatStats.querySelector('[data-flat="mpCostDown"]');
          if (mpCostEl) {
            const baseValue = statsData.mpCostDown?.lv90 || statsData.mpCostDown || 0;
            const value = baseValue + (bonuses.mpCostDown || 0);
            mpCostEl.textContent = value.toString();
            const parent = mpCostEl.closest('.bb-stats-flat-item') as HTMLElement;
            if (parent) parent.style.display = value > 0 ? '' : 'none';
          }
        }

        // Update quick button active state
        quickBtns.forEach(btn => {
          const btnEl = btn as HTMLButtonElement;
          const btnLevel = parseInt(btnEl.dataset.level || '0');
          btnEl.classList.toggle('active', btnLevel === level);
        });
      }

      // Input event listeners
      levelInput.addEventListener('input', () => {
        const level = parseInt(levelInput.value) || 1;
        setLevel(level);
      });

      // Plus/minus button listeners
      minusBtn?.addEventListener('click', () => {
        const currentLevel = parseInt(levelInput.value) || 1;
        setLevel(currentLevel - 1);
      });

      plusBtn?.addEventListener('click', () => {
        const currentLevel = parseInt(levelInput.value) || 90;
        setLevel(currentLevel + 1);
      });

      // Quick level button listeners
      quickBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const level = parseInt((btn as HTMLButtonElement).dataset.level || '90');
          setLevel(level);
        });
      });

      // Bonus input listeners
      function updateAllBonusDisplays() {
        const level = parseInt(levelInput.value) || 90;

        // Calculate all bonuses with clamped values
        const lbLevel = Math.min(5, Math.max(0, parseInt(limitBreakInput?.value || '5')));
        const lbBonuses = calculateLimitBreakBonus(lbLevel);

        const gpLevel = Math.min(10, Math.max(0, parseInt(gpAbilityInput?.value || '10')));
        const bondBonuses = calculateGpAbilityBonus(gpLevel);

        const agGrade = Math.min(10, Math.max(0, parseInt(abilityGradeInput?.value || '10')));
        const gradeBonuses = calculateAbilityGradeBonus(agGrade);

        // Update each hero card display
        updateHeroCardDisplay(limitBreakDisplay, lbBonuses, STAT_NAMES);
        updateHeroCardDisplay(gpAbilityDisplay, bondBonuses, STAT_NAMES);
        updateHeroCardDisplay(abilityGradeDisplay, gradeBonuses, STAT_NAMES);

        // Update passive abilities display (uses its own input)
        const passiveGrade = Math.min(10, Math.max(0, parseInt(passiveInput?.value || '10')));
        updatePassiveDisplay(passiveGrade);

        // Update main stats
        updateStats(level);
      }

      limitBreakInput?.addEventListener('input', updateAllBonusDisplays);
      gpAbilityInput?.addEventListener('input', updateAllBonusDisplays);
      abilityGradeInput?.addEventListener('input', updateAllBonusDisplays);
      passiveInput?.addEventListener('input', updateAllBonusDisplays);

      // Checkbox listeners - toggle bonus inclusion in combat stats
      limitBreakCheck?.addEventListener('change', updateAllBonusDisplays);
      gpAbilityCheck?.addEventListener('change', updateAllBonusDisplays);
      abilityGradeCheck?.addEventListener('change', updateAllBonusDisplays);
      passiveCheck?.addEventListener('change', updateAllBonusDisplays);

      // Initial update
      updateAllBonusDisplays();
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initFilters();
      initLevelCalculators();
    });
  } else {
    initFilters();
    initLevelCalculators();
  }
</script>
