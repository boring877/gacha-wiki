---
import CharacterBuildLayout from '../../../../layouts/horizon-walker/CharacterBuildLayout.astro';
import CharacterImage from '../../../../components/horizon-walker/CharacterImage.astro';
import StigmaImage from '../../../../components/horizon-walker/StigmaImage.astro';
import { getEnhancedBuilds } from '../../../../data/horizon-walker/builds/builds-data.js';
import { HORIZON_WALKER_CHARACTERS } from '../../../../data/horizon-walker/characters.js';
import { stigmas } from '../../../../data/horizon-walker/stigmas.js';
import { getCharacterBuildConfig } from '../../../../data/horizon-walker/builds/character-build-configs.js';

export async function getStaticPaths() {
  const characters = HORIZON_WALKER_CHARACTERS;
  const builds = getEnhancedBuilds();

  // Only create paths for characters that have builds
  const paths = characters
    .filter(character =>
      builds.some(build => build.buildSlug === character.slug && build.available)
    )
    .map(character => ({
      params: { buildSlug: character.slug },
      props: {
        character,
        build: builds.find(build => build.buildSlug === character.slug && build.available),
      },
    }));

  return paths;
}

const { character, build } = Astro.props;

// Validate that we have both character and build data
if (!character || !build) {
  return Astro.redirect('/guides/horizon-walker/builds/');
}

const title = `${character.name} Build - Horizon Walker`;
const description = `Complete build guide for ${character.name} in Horizon Walker. Includes optimal equipment, stats, and strategies.`;

// Get character-specific build configuration
const buildConfig = getCharacterBuildConfig(character.slug);

// Determine the type of stigma recommendation
const isMixedStigma =
  typeof buildConfig.recommendedStigma === 'string' &&
  buildConfig.recommendedStigma.includes('Mixed 2-Set');
const isObjectRecommendation =
  typeof buildConfig.recommendedStigma === 'object' && buildConfig.recommendedStigma !== null;

// Get stigma data for display
let recommendedStigma: any = null;
let recommendedStigmaZeroDupe: any = null;
let recommendedStigmaFullEx5: any = null;
let mixedStigmaPieces: any = null;

if (isMixedStigma) {
  // Handle mixed 2-set stigma builds (like Olivia)
  // Reckoning of Sin pieces
  const reckoningOfSin = stigmas.EX?.find(stigma => stigma.name === 'Reckoning of Sin');
  // The Thousand Mile Weave pieces
  const thousandMileWeave = stigmas.EX?.find(stigma => stigma.name === 'The Thousand Mile Weave');

  if (reckoningOfSin && thousandMileWeave) {
    mixedStigmaPieces = {
      top: thousandMileWeave.pieces.top, // The Thousand Mile Weave
      bottom: reckoningOfSin.pieces.bottom, // Reckoning of Sin
      left: reckoningOfSin.pieces.left, // Reckoning of Sin
      right: thousandMileWeave.pieces.right, // The Thousand Mile Weave
      twoSetBonus1: reckoningOfSin.twoSet, // AP Recovery +4% during battle
      twoSetBonus2: thousandMileWeave.twoSet, // Melee ATK +10% during battle
    };
  }
} else if (isObjectRecommendation) {
  // Handle object-based recommendations (like Emilia)
  const zeroDupeName = buildConfig.recommendedStigma.zeroDupe;
  const fullEx5Name = buildConfig.recommendedStigma.fullEx5;

  // Find zero dupe stigma
  if (stigmas.EX && stigmas.EX.length > 0) {
    recommendedStigmaZeroDupe = stigmas.EX.find(stigma => stigma.name === zeroDupeName);
  }
  if (!recommendedStigmaZeroDupe && stigmas.SS && stigmas.SS.length > 0) {
    recommendedStigmaZeroDupe = stigmas.SS.find(stigma => stigma.name === zeroDupeName);
  }
  if (!recommendedStigmaZeroDupe && stigmas.S && stigmas.S.length > 0) {
    recommendedStigmaZeroDupe = stigmas.S.find(stigma => stigma.name === zeroDupeName);
  }
  if (!recommendedStigmaZeroDupe && stigmas.A && stigmas.A.length > 0) {
    recommendedStigmaZeroDupe = stigmas.A.find(stigma => stigma.name === zeroDupeName);
  }

  // Find full EX5 stigma
  if (stigmas.EX && stigmas.EX.length > 0) {
    recommendedStigmaFullEx5 = stigmas.EX.find(stigma => stigma.name === fullEx5Name);
  }
  if (!recommendedStigmaFullEx5 && stigmas.SS && stigmas.SS.length > 0) {
    recommendedStigmaFullEx5 = stigmas.SS.find(stigma => stigma.name === fullEx5Name);
  }
  if (!recommendedStigmaFullEx5 && stigmas.S && stigmas.S.length > 0) {
    recommendedStigmaFullEx5 = stigmas.S.find(stigma => stigma.name === fullEx5Name);
  }
  if (!recommendedStigmaFullEx5 && stigmas.A && stigmas.A.length > 0) {
    recommendedStigmaFullEx5 = stigmas.A.find(stigma => stigma.name === fullEx5Name);
  }
} else {
  // Handle single stigma set builds (string recommendation)
  const recommendedStigmaName = buildConfig.recommendedStigma;

  if (stigmas.EX && stigmas.EX.length > 0) {
    recommendedStigma = stigmas.EX.find(stigma => stigma.name === recommendedStigmaName);
  }
  if (!recommendedStigma && stigmas.SS && stigmas.SS.length > 0) {
    recommendedStigma = stigmas.SS.find(stigma => stigma.name === recommendedStigmaName);
  }
  if (!recommendedStigma && stigmas.S && stigmas.S.length > 0) {
    recommendedStigma = stigmas.S.find(stigma => stigma.name === recommendedStigmaName);
  }
  if (!recommendedStigma && stigmas.A && stigmas.A.length > 0) {
    recommendedStigma = stigmas.A.find(stigma => stigma.name === recommendedStigmaName);
  }
}
---

<CharacterBuildLayout title={title} description={description} characterName={character.name}>
  <div class="character-build-header">
    <div class="character-build-image">
      <CharacterImage
        imageName={character.name}
        alt={`${character.name} character portrait`}
        width={120}
        height={120}
        class="character-build-portrait"
        loading="eager"
      />
    </div>
    <div class="character-build-info">
      <h2 class="character-build-name">{character.name} Build</h2>
      <div class="character-build-badges">
        <span class="hw-badge" data-type="Cost">{build.cost}</span>
        <span class="hw-badge" data-rarity={build.rarity}>{build.rarity}</span>
        <span class="character-tag damage-scaling">{buildConfig.damageScaling}</span>
      </div>
    </div>
  </div>

  <!-- Core Stats Section -->
  <section class="character-build-section">
    <h3 class="character-build-section-title">Core Stats</h3>
    <!-- Core Stats Explanation -->
    <div class="core-stats-explanation">
      <div class="stat-explanation-grid">
        <span
          ><span class="stat-name">Strength:</span>
          <span class="stat-description">Increases Melee ATK</span></span
        >
        <span
          ><span class="stat-name">Technic:</span>
          <span class="stat-description">Increases Ranged ATK</span></span
        >
        <span
          ><span class="stat-name">Intelligence:</span>
          <span class="stat-description">Increases Magic ATK</span></span
        >
        <span
          ><span class="stat-name">Vitality:</span>
          <span class="stat-description">Increases Max HP</span></span
        >
        <span
          ><span class="stat-name">Agility:</span>
          <span class="stat-description">Increases evasion and AP Recovery</span></span
        >
      </div>
    </div>
    <div class="core-stats-grid">
      <div class="core-stat-card">
        <div class="core-stat-title">Strength</div>
        <div class="core-stat-value">{character.stats?.strength || 'N/A'}</div>
      </div>
      <div class="core-stat-card">
        <div class="core-stat-title">Technic</div>
        <div class="core-stat-value">{character.stats?.technic || 'N/A'}</div>
      </div>
      <div class="core-stat-card">
        <div class="core-stat-title">Intelligence</div>
        <div class="core-stat-value">{character.stats?.intelligence || 'N/A'}</div>
      </div>
      <div class="core-stat-card">
        <div class="core-stat-title">Vitality</div>
        <div class="core-stat-value">{character.stats?.vitality || 'N/A'}</div>
      </div>
      <div class="core-stat-card">
        <div class="core-stat-title">Agility</div>
        <div class="core-stat-value">{character.stats?.agility || 'N/A'}</div>
      </div>
    </div>
  </section>

  <!-- Build Strategy Box -->
  <section class="character-build-section">
    <h3 class="character-build-section-title">Build Note</h3>
    <div class="strategy-box">
      <h4 class="strategy-title">{buildConfig.buildStrategyTitle}</h4>
      <div class="strategy-content">
        {
          buildConfig.buildStrategy.map((strategy, index) => (
            <div class="strategy-point">
              <div class="strategy-text">
                <strong>{strategy.title}</strong> - {strategy.description}
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Recommended Stigma Section -->
  {
    (recommendedStigma ||
      recommendedStigmaZeroDupe ||
      recommendedStigmaFullEx5 ||
      mixedStigmaPieces) && (
      <section class="character-build-section">
        <h3 class="character-build-section-title">Recommended Stigma</h3>
        <div class="stigma-container">
          {isMixedStigma ? (
            // Mixed 2-Set Stigma Display (like Olivia)
            <>
              <div class="stigma-header">
                <div class="stigma-title-section">
                  <div class="stigma-info-container">
                    <div class="stigma-image-container">
                      <StigmaImage
                        imageName="Reckoning of Sin"
                        alt="Reckoning of Sin stigma"
                        width={60}
                        height={60}
                        class="stigma-portrait-small"
                        loading="eager"
                      />
                    </div>
                    <div class="stigma-name-label">
                      <h5>Reckoning of Sin</h5>
                      <span class="hw-badge" data-rarity="EX">
                        EX
                      </span>
                    </div>
                  </div>

                  <div class="stigma-plus-sign">+</div>

                  <div class="stigma-info-container">
                    <div class="stigma-image-container">
                      <StigmaImage
                        imageName="The Thousand Mile Weave"
                        alt="The Thousand Mile Weave stigma"
                        width={60}
                        height={60}
                        class="stigma-portrait-small"
                        loading="eager"
                      />
                    </div>
                    <div class="stigma-name-label">
                      <h5>The Thousand Mile Weave</h5>
                      <span class="hw-badge" data-rarity="EX">
                        EX
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="stigma-bonuses">
                <div class="stigma-set-bonus">
                  <h5>Reckoning of Sin (2-Set Bonus)</h5>
                  <p>{mixedStigmaPieces.twoSetBonus1}</p>
                </div>
                <div class="stigma-set-bonus">
                  <h5>The Thousand Mile Weave (2-Set Bonus)</h5>
                  <p>{mixedStigmaPieces.twoSetBonus2}</p>
                </div>
              </div>

              <div class="stigma-pieces">
                <h5>Mixed Stigma Pieces</h5>
                <div class="stigma-grid">
                  <div class="stigma-piece">
                    <div class="piece-slot">Top</div>
                    <div class="piece-info">
                      <div class="piece-set-name">The Thousand Mile Weave</div>
                      <div class="piece-stat-value">{mixedStigmaPieces.top.stat}</div>
                    </div>
                  </div>
                  <div class="stigma-piece">
                    <div class="piece-slot">Bottom</div>
                    <div class="piece-info">
                      <div class="piece-set-name">Reckoning of Sin</div>
                      <div class="piece-stat-value">{mixedStigmaPieces.bottom.stat}</div>
                    </div>
                  </div>
                  <div class="stigma-piece">
                    <div class="piece-slot">Left</div>
                    <div class="piece-info">
                      <div class="piece-set-name">Reckoning of Sin</div>
                      <div class="piece-stat-value">{mixedStigmaPieces.left.stat}</div>
                    </div>
                  </div>
                  <div class="stigma-piece">
                    <div class="piece-slot">Right</div>
                    <div class="piece-info">
                      <div class="piece-set-name">The Thousand Mile Weave</div>
                      <div class="piece-stat-value">{mixedStigmaPieces.right.stat}</div>
                    </div>
                  </div>
                </div>
              </div>
            </>
          ) : isObjectRecommendation ? (
            // Object-based Stigma Recommendations - Each stigma in separate section
            <>
              {/* First Stigma Option */}
              <div class="stigma-option-section">
                <div class="stigma-option-label">Option 1: Low Investment / Zero Dupe</div>
                <div class="stigma-header">
                  <div class="stigma-title-section">
                    <div class="stigma-image-container">
                      <StigmaImage
                        imageName={recommendedStigmaZeroDupe.name}
                        alt={`${recommendedStigmaZeroDupe.name} stigma`}
                        width={60}
                        height={60}
                        class="stigma-portrait-small"
                        loading="eager"
                      />
                    </div>
                    <div class="stigma-title-info">
                      <h4 class="stigma-name">{recommendedStigmaZeroDupe.name}</h4>
                      <span class="hw-badge" data-rarity="EX">
                        EX
                      </span>
                    </div>
                  </div>
                </div>

                <div class="stigma-bonuses">
                  <div class="stigma-set-bonus">
                    <h5>2-Set Bonus</h5>
                    <p>{recommendedStigmaZeroDupe.twoSet}</p>
                  </div>
                  {recommendedStigmaZeroDupe.fourSet && (
                    <div class="stigma-set-bonus">
                      <h5>4-Set Bonus</h5>
                      <p>{recommendedStigmaZeroDupe.fourSet}</p>
                    </div>
                  )}
                </div>

                <div class="stigma-pieces">
                  <h5>Stigma Pieces</h5>
                  <div class="stigma-grid">
                    <div class="stigma-piece">
                      <div class="piece-slot">Top</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaZeroDupe.pieces.top.name}</div>
                        <div class="piece-stat">{recommendedStigmaZeroDupe.pieces.top.stat}</div>
                      </div>
                    </div>
                    <div class="stigma-piece">
                      <div class="piece-slot">Bottom</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaZeroDupe.pieces.bottom.name}</div>
                        <div class="piece-stat">{recommendedStigmaZeroDupe.pieces.bottom.stat}</div>
                      </div>
                    </div>
                    <div class="stigma-piece">
                      <div class="piece-slot">Left</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaZeroDupe.pieces.left.name}</div>
                        <div class="piece-stat">{recommendedStigmaZeroDupe.pieces.left.stat}</div>
                      </div>
                    </div>
                    <div class="stigma-piece">
                      <div class="piece-slot">Right</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaZeroDupe.pieces.right.name}</div>
                        <div class="piece-stat">{recommendedStigmaZeroDupe.pieces.right.stat}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Divider between options */}
              <div class="stigma-option-divider">
                <span>OR</span>
              </div>

              {/* Second Stigma Option */}
              <div class="stigma-option-section">
                <div class="stigma-option-label">Option 2: Full EX 5 Weapon</div>
                <div class="stigma-header">
                  <div class="stigma-title-section">
                    <div class="stigma-image-container">
                      <StigmaImage
                        imageName={recommendedStigmaFullEx5.name}
                        alt={`${recommendedStigmaFullEx5.name} stigma`}
                        width={60}
                        height={60}
                        class="stigma-portrait-small"
                        loading="eager"
                      />
                    </div>
                    <div class="stigma-title-info">
                      <h4 class="stigma-name">{recommendedStigmaFullEx5.name}</h4>
                      <span class="hw-badge" data-rarity="EX">
                        EX
                      </span>
                    </div>
                  </div>
                </div>

                <div class="stigma-bonuses">
                  <div class="stigma-set-bonus">
                    <h5>2-Set Bonus</h5>
                    <p>{recommendedStigmaFullEx5.twoSet}</p>
                  </div>
                  {recommendedStigmaFullEx5.fourSet && (
                    <div class="stigma-set-bonus">
                      <h5>4-Set Bonus</h5>
                      <p>{recommendedStigmaFullEx5.fourSet}</p>
                    </div>
                  )}
                </div>

                <div class="stigma-pieces">
                  <h5>Stigma Pieces</h5>
                  <div class="stigma-grid">
                    <div class="stigma-piece">
                      <div class="piece-slot">Top</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaFullEx5.pieces.top.name}</div>
                        <div class="piece-stat">{recommendedStigmaFullEx5.pieces.top.stat}</div>
                      </div>
                    </div>
                    <div class="stigma-piece">
                      <div class="piece-slot">Bottom</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaFullEx5.pieces.bottom.name}</div>
                        <div class="piece-stat">{recommendedStigmaFullEx5.pieces.bottom.stat}</div>
                      </div>
                    </div>
                    <div class="stigma-piece">
                      <div class="piece-slot">Left</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaFullEx5.pieces.left.name}</div>
                        <div class="piece-stat">{recommendedStigmaFullEx5.pieces.left.stat}</div>
                      </div>
                    </div>
                    <div class="stigma-piece">
                      <div class="piece-slot">Right</div>
                      <div class="piece-info">
                        <div class="piece-name">{recommendedStigmaFullEx5.pieces.right.name}</div>
                        <div class="piece-stat">{recommendedStigmaFullEx5.pieces.right.stat}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </>
          ) : (
            // Single Stigma Set Display (like Juha, Vlissing)
            <>
              <div class="stigma-header">
                <div class="stigma-title-section">
                  <div class="stigma-image-container">
                    <StigmaImage
                      imageName={recommendedStigma.name}
                      alt={`${recommendedStigma.name} stigma`}
                      width={60}
                      height={60}
                      class="stigma-portrait-small"
                      loading="eager"
                    />
                  </div>
                  <div class="stigma-title-info">
                    <h4 class="stigma-name">{recommendedStigma.name}</h4>
                    <span class="hw-badge" data-rarity="EX">
                      EX
                    </span>
                  </div>
                </div>
              </div>

              <div class="stigma-bonuses">
                <div class="stigma-set-bonus">
                  <h5>2-Set Bonus</h5>
                  <p>{recommendedStigma.twoSet}</p>
                </div>
                <div class="stigma-set-bonus">
                  <h5>4-Set Bonus</h5>
                  <p>{recommendedStigma.fourSet}</p>
                  {recommendedStigma.specialEffect && (
                    <p class="stigma-special-effect"><strong>[{recommendedStigma.specialEffect.name}]:</strong> {recommendedStigma.specialEffect.description}</p>
                  )}
                </div>
              </div>

              <div class="stigma-pieces">
                <h5>Stigma Pieces</h5>
                <div class="stigma-grid">
                  <div class="stigma-piece">
                    <div class="piece-slot">Top</div>
                    <div class="piece-info">
                      <div class="piece-name">{recommendedStigma.pieces.top.name}</div>
                      <div class="piece-stat">{recommendedStigma.pieces.top.stat}</div>
                    </div>
                  </div>
                  <div class="stigma-piece">
                    <div class="piece-slot">Bottom</div>
                    <div class="piece-info">
                      <div class="piece-name">{recommendedStigma.pieces.bottom.name}</div>
                      <div class="piece-stat">{recommendedStigma.pieces.bottom.stat}</div>
                    </div>
                  </div>
                  <div class="stigma-piece">
                    <div class="piece-slot">Left</div>
                    <div class="piece-info">
                      <div class="piece-name">{recommendedStigma.pieces.left.name}</div>
                      <div class="piece-stat">{recommendedStigma.pieces.left.stat}</div>
                    </div>
                  </div>
                  <div class="stigma-piece">
                    <div class="piece-slot">Right</div>
                    <div class="piece-info">
                      <div class="piece-name">{recommendedStigma.pieces.right.name}</div>
                      <div class="piece-stat">{recommendedStigma.pieces.right.stat}</div>
                    </div>
                  </div>
                </div>
              </div>
            </>
          )}

          <div class="recommended-substats">
            <h5>Recommended Sub Stats</h5>
            <div class="substats-list">
              {buildConfig.recommendedSubstats.map((substat, index) => (
                <div
                  class={`substat-item ${index < 3 ? 'priority-best' : index === 3 ? 'priority-alternative' : 'priority-optional'}`}
                >
                  <div class="substat-info">
                    <div class="substat-name">{substat.stat}</div>
                    <div class="substat-priority">{substat.priority}</div>
                  </div>
                  <div class="substat-scale">{substat.scale}</div>
                </div>
              ))}
            </div>
            <div class="substats-note">
              <strong>Priority:</strong> {buildConfig.substatsPriority}
            </div>
          </div>
        </div>
      </section>
    )
  }

  {/* Alternative Build Strategies Section */}
  {
    buildConfig.alternativeBuilds && buildConfig.alternativeBuilds.length > 0 && (
      <section class="character-build-section">
        <h3 class="character-build-section-title">Alternative Build Strategies</h3>
        <div class="alternative-builds-container">
          <div class="alternative-builds-grid">
            {buildConfig.alternativeBuilds.map(build => (
              <div class="alternative-build-card">
                <div class="alternative-build-header">
                  <h4 class="alternative-build-title">{build.title}</h4>
                  {build.recommendedStigma && (
                    <div class="alternative-build-stigma">
                      <div class="stigma-image-container">
                        <StigmaImage
                          imageName={build.recommendedStigma}
                          alt={`${build.recommendedStigma} stigma`}
                          width={64}
                          height={64}
                          class="stigma-portrait-medium"
                          loading="eager"
                        />
                      </div>
                      <div class="stigma-info">
                        <div class="stigma-label">Recommended Stigma</div>
                        <div class="stigma-name">{build.recommendedStigma}</div>
                      </div>
                    </div>
                  )}
                </div>
                <div class="alternative-build-content">
                  <p class="alternative-build-description">{build.description}</p>

                  {build.playstyle && (
                    <div class="alternative-build-playstyle">
                      <h5>Playstyle</h5>
                      <p>{build.playstyle}</p>
                    </div>
                  )}

                  {build.substatsFocus && (
                    <div class="alternative-build-substats">
                      <h5>Substats Priority</h5>
                      <p>{build.substatsFocus}</p>
                    </div>
                  )}

                  {build.note && (
                    <div class="alternative-build-note">
                      <h5>Traits Build Note</h5>
                      <p>{build.note}</p>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  {
    character && (
      <>
        {/* Recommended Traits Section */}
        <section class="character-build-section">
          <h3 class="character-build-section-title">Recommended Traits</h3>
          <div class="recommended-traits">
            <h5>Best Traits for {buildConfig.traitsType} (Max 5 Traits)</h5>
            <div class="traits-list">
              {buildConfig.recommendedTraits.map((trait, index) => (
                <div class={`trait-item ${index < 5 ? 'priority-best' : 'priority-alternative'}`}>
                  <div class="trait-info">
                    <div class="trait-name">{trait.name}</div>
                    <div class="trait-priority">{trait.priority}</div>
                  </div>
                  <div class="trait-effects">
                    {trait.effects.map(effect => (
                      <div class="trait-effect">{effect}</div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
            <div class="traits-note">
              <strong>Recommended Selection:</strong> {buildConfig.traitRecommendation}
            </div>
          </div>
        </section>
      </>
    )
  }
</CharacterBuildLayout>
