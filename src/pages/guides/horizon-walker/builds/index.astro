---
import BuildsLayout from '../../../../layouts/horizon-walker/BuildsLayout.astro';
import CharacterImage from '../../../../components/horizon-walker/CharacterImage.astro';
import {
  getTotalBuilds,
  getEnhancedBuilds,
} from '../../../../data/horizon-walker/builds/builds-data.js';

const title = 'Character Builds';
const description = `Complete collection of ${getTotalBuilds()} character builds for Horizon Walker. Featuring optimized builds for all characters.`;

// Get enhanced builds with character data (including cost from character database)
const enhancedBuilds = getEnhancedBuilds();
const availableBuilds = enhancedBuilds.filter(build => build.available);

// Sort builds by rarity (EX, SS, S, A, B) then by name
const sortedBuilds = availableBuilds.sort((a, b) => {
  const rarityOrder = { EX: 5, SS: 4, S: 3, A: 2, B: 1 };
  const rarityDiff = rarityOrder[b.rarity] - rarityOrder[a.rarity];
  if (rarityDiff !== 0) return rarityDiff;
  return a.displayName.localeCompare(b.displayName);
});

// Group builds by rarity for display
const buildsByRarity = {
  EX: sortedBuilds.filter(build => build.rarity === 'EX'),
  SS: sortedBuilds.filter(build => build.rarity === 'SS'),
  S: sortedBuilds.filter(build => build.rarity === 'S'),
  A: sortedBuilds.filter(build => build.rarity === 'A'),
  B: sortedBuilds.filter(build => build.rarity === 'B'),
};
---

<BuildsLayout title={title} description={description}>
  <div class="hw-builds-container">
    {/* Builds by Rarity */}
    {
      Object.entries(buildsByRarity).map(([rarity, builds]) => {
        if (builds.length === 0) return null;

        return (
          <section class="hw-builds-rarity-section">
            <div class="hw-builds-rarity-header">
              <span class="hw-badge" data-rarity={rarity}>
                {rarity}
              </span>
              <span class="hw-builds-rarity-count">({builds.length} builds)</span>
            </div>

            <div class="hw-builds-grid">
              {builds.map(build => (
                <a
                  href={build.characterSlug}
                  class="hw-build-card-link"
                  aria-label={`View ${build.characterData?.name || build.displayName} build`}
                >
                  <div class="hw-build-card">
                    {/* Character Header */}
                    <div class="hw-build-card-header">
                      <div class="hw-build-character-image">
                        <CharacterImage
                          imageName={build.displayName}
                          alt={`${build.displayName} character portrait`}
                          width={100}
                          height={100}
                          class="hw-character-portrait"
                          loading="eager"
                        />
                      </div>
                      <div class="hw-build-character-info">
                        <h3 class="hw-build-character-name">{build.displayName}</h3>
                        <div class="hw-build-character-meta">
                          <span class="hw-badge" data-type="Cost">
                            {build.cost}
                          </span>
                          <span class="hw-badge" data-rarity={build.rarity}>
                            {build.rarity}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </section>
        );
      })
    }

    {/* Coming Soon Section (for unavailable builds) */}
    {
      enhancedBuilds.filter(build => !build.available).length > 0 && (
        <section class="hw-builds-coming-soon">
          <h3 class="hw-builds-coming-soon-title">Coming Soon</h3>
          <div class="hw-builds-coming-soon-grid">
            {enhancedBuilds
              .filter(build => !build.available)
              .map(build => (
                <div class="hw-build-card hw-build-card-disabled">
                  <div class="hw-build-card-header">
                    <div class="hw-build-character-info">
                      <h3 class="hw-build-character-name">{build.displayName}</h3>
                      <div class="hw-build-character-meta">
                        <span class="hw-badge" data-type="Cost">
                          {build.cost}
                        </span>
                        <span class="hw-badge" data-rarity={build.rarity}>
                          {build.rarity}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="hw-build-card-content">
                    {/* Character tags would go here if needed */}
                  </div>
                  <div class="hw-build-card-footer">
                    <span class="hw-build-coming-soon">Coming Soon</span>
                  </div>
                </div>
              ))}
          </div>
        </section>
      )
    }
  </div>
</BuildsLayout>
