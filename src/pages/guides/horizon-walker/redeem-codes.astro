---
import HWLandingLayout from '../../../layouts/horizon-walker/LandingLayout.astro';
import FormattedDate from '../../../components/FormattedDate.astro';

// Import redeem codes data and CSS
import {
  horizonWalkerRedeemCodes,
  generateRedeemCodesStructuredData,
} from '../../../data/horizon-walker/redeem-codes.js';
import '../../../styles/games/horizon-walker/hw-redeem-codes.css';

// Extract data from the data file
const { meta, availableCodes, expiredCodes, redeemInstructions, communitySection, warnings } =
  horizonWalkerRedeemCodes;

// Page metadata
const title = meta.title;
const description = meta.description;
const gameTitle = 'Redeem Codes';
const lastUpdated = meta.lastUpdated;

// Generate structured data for SEO
const structuredData = generateRedeemCodesStructuredData();
---

<HWLandingLayout title={title} description={description} gameTitle={gameTitle}>
  <section class="page-content">
    <!-- Single Main Container -->
    <div class="hw-redeem-main-container">
      <!-- Header with Combined Warnings -->
      <div class="hw-redeem-header-section">
        <p class="important-notice">{warnings.important}</p>
        <h3>{warnings.noGuarantees.title}</h3>
        <p>{warnings.noGuarantees.message}</p>
        <p class="last-updated">
          Last Updated: <FormattedDate date={lastUpdated} />
        </p>
      </div>

      <!-- Available Codes -->
      <div class="hw-redeem-codes-section">
        <h2 class="hw-redeem-section-title">Available Codes</h2>
        <p class="hw-redeem-section-description">
          These codes were shared by the community. Try them and see!
        </p>

        <div class="hw-redeem-codes-grid">
          {
            availableCodes.map(codeData => (
              <div class="hw-redeem-code-card">
                <div class="hw-code-info">
                  <div class="hw-code-label">Redeem Code</div>
                  <div class="hw-code-value">{codeData.code}</div>
                </div>
                <div class="hw-code-rewards">{codeData.rewards}</div>
                <div class="hw-code-meta">
                  <span class={`hw-code-status ${codeData.status}`}>
                    {codeData.status === 'unknown' ? 'Unverified' : codeData.status}
                  </span>
                  <span class="hw-code-date">Checked: {codeData.lastChecked}</span>
                </div>
                {codeData.expiryDate && (
                  <div class="hw-code-expiry">Expires: {codeData.expiryDate}</div>
                )}
                <button class="hw-copy-button" data-code={codeData.code}>
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                  </svg>
                  Copy Code
                </button>
              </div>
            ))
          }
        </div>
      </div>

      <!-- Instructions -->
      <div class="hw-redeem-instructions-section">
        <h2 class="hw-redeem-section-title">{redeemInstructions.title}</h2>
        <p class="hw-redeem-section-description">{redeemInstructions.description}</p>

        <h3>Step-by-Step Guide:</h3>
        {
          redeemInstructions.steps.map((step, index) => (
            <div class="hw-instruction-step" data-step={index + 1}>
              <h4>{step.title}</h4>
              <p>{step.description}</p>
            </div>
          ))
        }
      </div>

      <!-- Expired Codes -->
      <div class="hw-redeem-expired-section">
        <h2 class="hw-redeem-section-title">Expired Codes</h2>
        {
          expiredCodes.length > 0 ? (
            <>
              <p class="hw-redeem-section-description">
                These codes are no longer active but kept for reference.
              </p>
              <div class="hw-redeem-codes-grid">
                {expiredCodes.map(codeData => (
                  <div class="hw-redeem-code-card expired">
                    <div class="hw-code-info">
                      <div class="hw-code-label">Expired Code</div>
                      <div class="hw-code-value">{codeData.code}</div>
                    </div>
                    <div class="hw-code-rewards">{codeData.rewards}</div>
                    <p class="hw-code-expiry">Expired: {codeData.expiryDate}</p>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <div class="hw-empty-section">
              <p class="hw-empty-message">
                No expired codes yet! All available codes are still worth trying.
              </p>
            </div>
          )
        }
      </div>

      <!-- Community -->
      <div class="hw-redeem-community-section">
        <h2 class="hw-redeem-section-title">{communitySection.title}</h2>
        <p class="hw-redeem-section-description">{communitySection.description}</p>

        <div class="hw-community-buttons">
          {
            communitySection.buttons.map(button => (
              <a
                href={button.url}
                class={`hw-community-button ${button.type}`}
                target={button.external ? '_blank' : '_self'}
                rel={button.external ? 'noopener noreferrer' : ''}
              >
                {button.text}
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </section>

  <!-- Structured Data for SEO -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
</HWLandingLayout>

<script>
  // Simple copy functionality with multiple fallbacks
  function copyCode(button: HTMLButtonElement) {
    const code = button.getAttribute('data-code');
    if (!code) return;

    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.textContent = 'Copying...';

    // Try method 1: Modern Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard
        .writeText(code)
        .then(() => {
          showSuccess(button, originalHTML);
        })
        .catch(() => {
          // Try method 2: execCommand
          tryExecCommand(button, originalHTML, code);
        });
    } else {
      // Try method 2 directly
      tryExecCommand(button, originalHTML, code);
    }
  }

  function tryExecCommand(button: HTMLButtonElement, originalHTML: string, code: string) {
    try {
      // Create hidden textarea
      const textarea = document.createElement('textarea');
      textarea.value = code;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      textarea.style.left = '-9999px';
      textarea.setAttribute('readonly', '');
      document.body.appendChild(textarea);

      // Select and copy
      textarea.select();
      textarea.setSelectionRange(0, 99999);

      const success = document.execCommand('copy');
      document.body.removeChild(textarea);

      if (success) {
        showSuccess(button, originalHTML);
      } else {
        throw new Error('execCommand failed');
      }
    } catch (err) {
      console.error('Copy failed:', err);
      showError(button, originalHTML);
    }
  }

  function showSuccess(button: HTMLButtonElement, originalHTML: string) {
    button.textContent = 'Copied!';
    button.style.background = '#10b981';
    button.style.color = 'white';

    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.style.background = '';
      button.style.color = '';
      button.disabled = false;
    }, 2000);
  }

  function showError(button: HTMLButtonElement, originalHTML: string) {
    button.textContent = 'Try Again';
    button.style.background = '#ef4444';
    button.style.color = 'white';

    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.style.background = '';
      button.style.color = '';
      button.disabled = false;
    }, 2000);
  }

  // Initialize copy buttons
  document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('.hw-copy-button');

    buttons.forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();
        copyCode(this as HTMLButtonElement);
      });
    });
  });
</script>
