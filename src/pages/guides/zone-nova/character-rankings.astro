---
import CharacterRankingsLayout from '../../../layouts/zone-nova/CharacterRankingsLayout.astro';
import { ZONE_NOVA_CHARACTERS } from '../../../data/zone-nova/characters.js';
import {
  rankings,
  overallAnalysis,
  totalCharacters,
  statNames,
  filteredGroups,
  sortedArrays,
  viewIds,
} from '../../../data/zone-nova/character-rankings.js';
import ZNCharacterImage from '../../../components/zone-nova/ZNCharacterImage.astro';
---

<CharacterRankingsLayout
  title="Character Rankings - Zone Nova"
  description="View character stat rankings for HP, ATK, and DEF in Zone Nova"
  gameTitle="Character Rankings"
>
  <section class="content-section">
    <div class="rankings-intro">
      <h2 class="section-title">Character Stat Rankings</h2>
      <p class="intro-text">
        See how each character ranks in key combat stats among all {totalCharacters} characters
      </p>
      <p class="level-note">All stats shown at Level 80 (current max level)</p>
    </div>

    <!-- Character Selector -->
    <div class="character-selector">
      <h3 class="selector-title">Select Character</h3>

      <!-- Filters and Sort Controls -->
      <div class="filter-bar">
        <div class="filter-controls">
          <select class="filter-select" id="role-filter">
            <option value="">Role</option>
            <option value="Tank">Tank</option>
            <option value="DPS">DPS</option>
            <option value="Buffer">Buffer</option>
            <option value="Debuffer">Debuffer</option>
            <option value="Healer">Healer</option>
          </select>
          <select class="filter-select" id="class-filter">
            <option value="">Class</option>
            <option value="Guardian">Guardian</option>
            <option value="Warrior">Warrior</option>
            <option value="Rogue">Rogue</option>
            <option value="Mage">Mage</option>
            <option value="Buffer">Buffer</option>
            <option value="Debuffer">Debuffer</option>
            <option value="Healer">Healer</option>
          </select>
          <select class="filter-select" id="rarity-filter">
            <option value="">Rarity</option>
            <option value="SSR">SSR</option>
            <option value="SR">SR</option>
            <option value="R">R</option>
          </select>
          <select class="filter-select" id="element-filter">
            <option value="">Element</option>
            <option value="Fire">Fire</option>
            <option value="Ice">Ice</option>
            <option value="Wind">Wind</option>
            <option value="Holy">Holy</option>
            <option value="Chaos">Chaos</option>
          </select>
        </div>
        <div class="sort-controls">
          <button class="sort-btn" data-sort="hp">HP</button>
          <button class="sort-btn" data-sort="attack">ATK</button>
          <button class="sort-btn" data-sort="defense">DEF</button>
          <button class="sort-btn" data-sort="critRate">CRIT</button>
          <button class="reset-btn" id="clear-filters">Reset</button>
        </div>
      </div>

      <!-- Character Grid -->
      <div class="character-grid" id="character-grid">
        {
          ZONE_NOVA_CHARACTERS.map(char => (
            <article
              class="character-select-card"
              data-character-id={char.id}
              role="button"
              tabindex="0"
              aria-label={`Select ${char.name}, ${char.rarity} ${char.class}, ranked #${overallAnalysis[char.id].overallRank}`}
            >
              <div
                class="character-rank-number"
                aria-label={`Rank ${overallAnalysis[char.id].overallRank}`}
              >
                {overallAnalysis[char.id].overallRank}
              </div>
              <div style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                <ZNCharacterImage
                  imageName={char.image}
                  alt={`${char.name} portrait`}
                  class="character-portrait"
                  width={320}
                  height={320}
                  loading="lazy"
                  format="jpg"
                  quality={100}
                />
              </div>
              <div class="character-info">
                <h3>{char.name}</h3>
                <div class="character-badges">
                  <span
                    class={`rarity-badge ${char.rarity.toLowerCase()}`}
                    aria-label={`${char.rarity} rarity`}
                  >
                    {char.rarity}
                  </span>
                  <span
                    class={`class-badge ${char.class.toLowerCase().replace(' ', '-')}`}
                    aria-label={`${char.class} class`}
                  >
                    {char.class}
                  </span>
                </div>
                <div class="character-stats" aria-label="Character statistics">
                  <div class="stat-item">
                    <span class="stat-label">HP</span>
                    <span class="stat-value">
                      {typeof char.stats.hp === 'string'
                        ? char.stats.hp
                        : char.stats.hp?.toLocaleString() || 'N/A'}
                    </span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">ATK</span>
                    <span class="stat-value">
                      {typeof char.stats.attack === 'string'
                        ? char.stats.attack
                        : char.stats.attack?.toLocaleString() || 'N/A'}
                    </span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">DEF</span>
                    <span class="stat-value">
                      {typeof char.stats.defense === 'string'
                        ? char.stats.defense
                        : char.stats.defense?.toLocaleString() || 'N/A'}
                    </span>
                  </div>
                  {char.stats.critRate !== undefined ? (
                    <div class="stat-item crit-rate">
                      <span class="stat-label">CRIT</span>
                      <span class="stat-value">
                        {typeof char.stats.critRate === 'string'
                          ? char.stats.critRate
                          : `${char.stats.critRate}%`}
                      </span>
                    </div>
                  ) : null}
                </div>
              </div>
            </article>
          ))
        }
      </div>
    </div>

    <!-- Rankings Display -->
    <div id="rankings-display" class="rankings-display">
      <div id="character-info" class="character-info">
        <img id="character-image" class="character-image" />
        <h3 id="character-name" class="character-name"></h3>
        <p id="character-class" class="character-details"></p>
      </div>

      <div class="rankings-container">
        <h3 class="rankings-title">Stat Rankings</h3>

        <div id="rankings-grid" class="rankings-grid">
          {
            Object.keys(statNames)
              .filter(statKey => statKey !== 'critRate')
              .map(statKey => (
                <div class="ranking-card">
                  <h4 class="ranking-card-title">{statNames[statKey]}</h4>
                  <div class={`rank-display rank-${statKey}`} />
                  <div class={`rank-total rank-${statKey}-total`} />
                  <div class={`stat-value stat-${statKey}`} />
                </div>
              ))
          }

          <!-- Crit Rate card - conditionally shown -->
          <div id="crit-rate-card" class="ranking-card crit-rate-card" style="display: none;">
            <h4 class="ranking-card-title">CRIT RATE</h4>
            <div class="crit-message">Has Crit Rate</div>
            <div class="stat-value stat-critRate"></div>
          </div>
        </div>
      </div>

      <!-- Character Performance Analysis -->
      <div id="character-analysis" class="character-analysis" style="display: none;">
        <h4 class="character-analysis-title">Character Performance Breakdown</h4>
        <div class="performance-summary">
          <div class="summary-stats">
            <div class="summary-stat">
              <span class="summary-label">Overall Rank:</span>
              <span class="summary-value" id="overall-rank"></span>
              <span class="summary-note">based on 3 core stats</span>
            </div>
            <div class="summary-stat">
              <span class="summary-label">Top 3 Stats:</span>
              <div class="summary-stat-details">
                <span class="summary-count" id="top3-count"></span>
                <div class="stat-badges" id="top3-stats"></div>
              </div>
            </div>
            <div class="summary-stat">
              <span class="summary-label">Top 10 Stats:</span>
              <div class="summary-stat-details">
                <span class="summary-count" id="top10-count"></span>
                <div class="stat-badges" id="top10-stats"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back to Database Link -->
    <div class="back-button-container">
      <a href="/guides/zone-nova/characters/" class="back-button"> ‚Üê Back to Character Database </a>
    </div>
  </section>

  <!-- Set data for external script -->
  <script
    is:inline
    define:vars={{
      characters: ZONE_NOVA_CHARACTERS,
      rankings,
      overallAnalysis,
      statNames,
      totalCharacters,
      filteredGroups,
      sortedArrays,
      viewIds,
    }}
  >
    window.zoneNovaRankingsData = {
      characters,
      rankings,
      overallAnalysis,
      statNames,
      totalCharacters,
      filteredGroups,
      sortedArrays,
      viewIds,
    };
  </script>

  <!-- Load external optimized script -->
  <script is:inline src="/scripts/character-rankings/zone-nova-rankings.js"></script>
</CharacterRankingsLayout>
