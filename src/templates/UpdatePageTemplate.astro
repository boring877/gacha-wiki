---
// @ts-nocheck
import ZoneNovaUpdateLayout from '../layouts/zone-nova/UpdateLayout.astro';
import Breadcrumb from '../components/zone-nova/Breadcrumb.astro';
import FormattedDate from '../components/FormattedDate.astro';
import {
  highlightUpdateText,
  highlightUpdateContentArray,
  highlightTldrArray,
} from '../utils/zone-nova/update-highlighting.js';

export interface Props {
  updateData: {
    title: string;
    date: string;
    type: string;
    data?: any; // flexible data object
    tldr?: string[];
    officialUpdate: {
      greeting?: string;
      content: string[];
      closing?: string;
    };
    sourceInfo: {
      source: string;
      verified: boolean;
      gameUrl?: string;
    };
  };
  seoData: {
    title: string;
    description: string;
  };
}

const { updateData, seoData } = Astro.props;

// Apply highlighting to update content for better readability
const highlightedTldr = updateData.tldr ? highlightTldrArray(updateData.tldr) : updateData.tldr;
const highlightedContent = updateData.officialUpdate.content
  ? highlightUpdateContentArray(updateData.officialUpdate.content)
  : updateData.officialUpdate.content;
const highlightedGreeting = updateData.officialUpdate.greeting
  ? highlightUpdateText(updateData.officialUpdate.greeting)
  : updateData.officialUpdate.greeting;
const highlightedClosing = updateData.officialUpdate.closing
  ? highlightUpdateText(updateData.officialUpdate.closing)
  : updateData.officialUpdate.closing;

// Security: URL validation function
function isValidUrl(url: string): boolean {
  try {
    const urlObj = new URL(url);
    // Only allow http and https protocols
    return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
  } catch {
    return false;
  }
}

// Security: Validate gameUrl if present
if (updateData.sourceInfo.gameUrl && !isValidUrl(updateData.sourceInfo.gameUrl)) {
  updateData.sourceInfo.gameUrl = undefined; // Remove invalid URL
}

// You can also get updateType from the filename
// const updateType = getUpdateType(Astro.url.pathname);
---

<ZoneNovaUpdateLayout
  title={seoData.title}
  description={seoData.description}
  gameTitle={updateData.title}
  showBackButton={true}
  backButtonHref="/guides/zone-nova/updates/"
  backButtonText="Back to Updates"
>
  <Fragment slot="head">
    <style>
      /* Override layout title glow for update pages */
      .hero-title,
      .title-only-heading {
        animation: none !important;
      }

      /* Responsive visibility classes */
      .mobile-only {
        display: none;
      }

      .desktop-only {
        display: block;
      }

      @media (max-width: 767px) {
        .mobile-only {
          display: block;
        }

        .desktop-only {
          display: none;
        }
      }
    </style>

    <script is:inline>
      function toggleCollapsible(button) {
        const section = button.parentElement;
        const content = section?.querySelector('.collapsible-content');

        if (section && content) {
          if (section.classList.contains('expanded')) {
            section.classList.remove('expanded');
            content.style.maxHeight = '0';
          } else {
            section.classList.add('expanded');
            content.style.maxHeight = content.scrollHeight + 'px';
          }
        }
      }

      // Auto-expand on desktop or if content is short
      document.addEventListener('DOMContentLoaded', function () {
        const collapsibleSections = document.querySelectorAll('.collapsible-section');

        collapsibleSections.forEach(section => {
          const content = section.querySelector('.collapsible-content');
          const isMobile = window.innerWidth <= 767;

          // Auto-expand if not mobile or if content is short
          if (content && (!isMobile || content.scrollHeight < 400)) {
            section.classList.add('expanded');
            content.style.maxHeight = content.scrollHeight + 'px';
          }
        });
      });
    </script>
  </Fragment>

  <!-- Breadcrumb Navigation -->
  <Breadcrumb
    autoGenerate={true}
    gameKey="zone-nova"
    currentPageName={updateData.title}
    showBackButton={true}
  />

  <div class="update-page">
    <div class="update-container">
      <!-- TLDR Section -->
      {
        highlightedTldr && highlightedTldr.length > 0 && (
          <section class="content-section tldr-section">
            <h2 class="section-title">TL;DR</h2>
            <ul>
              {highlightedTldr.map(point => (
                <li set:html={point} />
              ))}
            </ul>
          </section>
        )
      }

      <!-- Official Update -->
      <section class="content-section official-section">
        <h2 class="section-title">Official Update</h2>

        <!-- Mobile Collapsible Version -->
        <div class="collapsible-section mobile-only">
          <button class="collapsible-header" onclick="toggleCollapsible(this)">
            <span>Full Official Update Details</span>
            <span class="collapsible-toggle">â–¼</span>
          </button>
          <div class="collapsible-content">
            <div class="collapsible-inner">
              {
                highlightedGreeting && (
                  <p>
                    <strong set:html={highlightedGreeting} />
                  </p>
                )
              }
              {
                highlightedContent.map((paragraph, index) => {
                  // Check if paragraph looks like a section header
                  const isHeader =
                    paragraph.match(/^[A-Z][^:]*:?\s*$/) || paragraph.match(/^[0-9]+\.\s/);
                  // Check if paragraph is a numbered event item
                  const isEventItem = paragraph.match(/^[0-9]+\.\s+Launch\s+/i);

                  return (
                    <p
                      class={
                        isHeader ? 'content-section-header' : isEventItem ? 'event-item-header' : ''
                      }
                    >
                      <span set:html={paragraph} />
                    </p>
                  );
                })
              }
            </div>
          </div>
        </div>

        <!-- Desktop Version -->
        <div class="info-card desktop-only">
          {
            highlightedGreeting && (
              <p>
                <strong set:html={highlightedGreeting} />
              </p>
            )
          }
          {
            highlightedContent.map((paragraph, index) => {
              // Check if paragraph looks like a section header
              const isHeader =
                paragraph.match(/^[A-Z][^:]*:?\s*$/) || paragraph.match(/^[0-9]+\.\s/);
              // Check if paragraph is a numbered event item
              const isEventItem = paragraph.match(/^[0-9]+\.\s+Launch\s+/i);

              return (
                <p
                  class={
                    isHeader ? 'content-section-header' : isEventItem ? 'event-item-header' : ''
                  }
                >
                  <span set:html={paragraph} />
                </p>
              );
            })
          }
        </div>
      </section>

      <!-- Closing -->
      {
        highlightedClosing && (
          <section class="content-section">
            <h2 class="section-title">Closing</h2>
            <div class="info-card">
              <p set:html={highlightedClosing} />
            </div>
          </section>
        )
      }

      <!-- Source Information -->
      <section class="content-section">
        <h2 class="section-title">Source Information</h2>
        {
          updateData.sourceInfo.gameUrl ? (
            <a
              href={updateData.sourceInfo.gameUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="source-link"
            >
              <div class="info-card source-info-card">
                <p class="source-text">
                  Source: <span class="source-name" set:text={updateData.sourceInfo.source} />
                </p>
              </div>
            </a>
          ) : (
            <div class="info-card">
              <p class="source-text">
                Source: <span class="source-name" set:text={updateData.sourceInfo.source} />
              </p>
            </div>
          )
        }
      </section>
    </div>
  </div>
</ZoneNovaUpdateLayout>
