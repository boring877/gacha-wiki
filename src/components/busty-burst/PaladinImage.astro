---
import { Image } from 'astro:assets';

// Import all images using glob patterns
// Using the longer filename format (6a0a8297...) which has better design
const iconImages = import.meta.glob<{ default: ImageMetadata }>(
  '../../assets/images/games/Busty_Burst/character/icons/6a0a8297dea7cbe49e003c19a11234da_*_sprite.png',
  { eager: true }
);

const bodyImages = import.meta.glob<{ default: ImageMetadata }>(
  '../../assets/images/games/Busty_Burst/character/full_body/No_*_body.png',
  { eager: true }
);

export interface Props {
  characterId: number;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  loading?: 'lazy' | 'eager';
  format?: 'webp' | 'jpg' | 'png';
  quality?: number;
  imageType?: 'icon' | 'body';
}

const {
  characterId,
  alt,
  width = 180,
  height = 180,
  class: className,
  loading = 'lazy',
  format = 'webp',
  quality = 95,
  imageType = 'icon', // Default to icon for small displays
} = Astro.props;

// Find the matching image based on characterId and imageType
let imageModule: ImageMetadata | null = null;

if (imageType === 'body') {
  // Look for body image: No_{id}_{id}_body.png
  const bodyKey = Object.keys(bodyImages).find(key =>
    key.includes(`No_${characterId}_${characterId}_body.png`)
  );
  if (bodyKey) {
    imageModule = bodyImages[bodyKey].default;
  }
}

if (!imageModule) {
  // Look for icon image: 6a0a8297dea7cbe49e003c19a11234da_{id}_sprite.png
  const iconKey = Object.keys(iconImages).find(key =>
    key.includes(`6a0a8297dea7cbe49e003c19a11234da_${characterId}_sprite.png`)
  );
  if (iconKey) {
    imageModule = iconImages[iconKey].default;
  }
}

// Fallback to character 2001 if not found
if (!imageModule) {
  const fallbackKey = Object.keys(iconImages).find(key =>
    key.includes('6a0a8297dea7cbe49e003c19a11234da_2001_sprite.png')
  );
  if (fallbackKey) {
    imageModule = iconImages[fallbackKey].default;
  }
}
---

{imageModule ? (
  <div class={`paladin-image-wrapper ${className || ''}`}>
    <Image
      src={imageModule}
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      format={format}
      quality={quality}
      class="paladin-image"
    />
  </div>
) : (
  <div class={`paladin-image-wrapper paladin-image-fallback ${className || ''}`} style={`width: ${width}px; height: ${height}px;`}>
    <span>{alt.charAt(0)}</span>
  </div>
)}

<style>
  .paladin-image-wrapper {
    display: inline-block;
    overflow: hidden;
    border-radius: 6px;
  }

  .paladin-image {
    object-fit: cover;
    border-radius: 6px;
  }

  .paladin-image-fallback {
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bb-bg-secondary, #2a2a3e);
    color: var(--bb-text-primary, #fff);
    font-weight: 600;
    font-size: 1.5rem;
  }
</style>
