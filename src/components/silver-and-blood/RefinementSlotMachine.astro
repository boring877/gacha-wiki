---
// Refinement Slot Machine Component
import { gearUpgradesData } from '../../data/silver-and-blood/gear-upgrades.js';

const blessingOptions = [
  { value: 'Blood R.', name: 'Bloodsoul Recovery' },
  { value: 'All DMG', name: 'All DMG Bonus' },
  { value: 'All DMG Red.', name: 'All DMG Reduction' },
  { value: 'ATK SPD', name: 'ATK SPD' },
  { value: 'P. DMG', name: 'P. DMG Bonus' },
  { value: 'M. DMG', name: 'M. DMG Bonus' },
  { value: 'CRIT DMG', name: 'CRIT DMG' },
  { value: 'Healing', name: 'Received Healing Bonus' },
  { value: 'CRIT Rate', name: 'CRIT Rate' },
];
---

<div class="refinement-container">
  <!-- Setup Section -->
  <div id="setup-section">
    <h3>Setup Your Current Gear</h3>

    <div class="setup-grid">
      <!-- Slot 1 -->
      <div class="setup-slot">
        <div class="slot-header">Slot 1</div>
        <select id="blessing-select-1" class="blessing-select">
          <option value="">Choose Blessing</option>
          {blessingOptions.map(opt => <option value={opt.value}>{opt.name}</option>)}
        </select>
        <select id="tier-select-1" class="tier-select" disabled>
          <option value="">Current Tier</option>
          {Array.from({ length: 15 }, (_, i) => <option value={i + 1}>T{i + 1}</option>)}
        </select>
      </div>

      <!-- Slot 2 -->
      <div class="setup-slot">
        <div class="slot-header">Slot 2</div>
        <select id="blessing-select-2" class="blessing-select">
          <option value="">Choose Blessing</option>
          {blessingOptions.map(opt => <option value={opt.value}>{opt.name}</option>)}
        </select>
        <select id="tier-select-2" class="tier-select" disabled>
          <option value="">Current Tier</option>
          {Array.from({ length: 15 }, (_, i) => <option value={i + 1}>T{i + 1}</option>)}
        </select>
      </div>

      <!-- Slot 3 -->
      <div class="setup-slot">
        <div class="slot-header">Slot 3</div>
        <select id="blessing-select-3" class="blessing-select">
          <option value="">Choose Blessing</option>
          {blessingOptions.map(opt => <option value={opt.value}>{opt.name}</option>)}
        </select>
        <select id="tier-select-3" class="tier-select" disabled>
          <option value="">Current Tier</option>
          {Array.from({ length: 15 }, (_, i) => <option value={i + 1}>T{i + 1}</option>)}
        </select>
      </div>
    </div>

    <button id="setup-btn" class="setup-button">Start Refinement</button>
  </div>

  <!-- Refinement Display - Hidden by default -->
  <div id="refinement-display" class="hidden">
    <!-- Container 1: Main Refinement Area (Grid + Button + Choices) -->
    <div class="main-refinement-area">
      <h3>Your Current Gear</h3>
      <div class="gear-slots">
        <!-- Slots will be populated dynamically -->
        <div class="refinement-gear-slot" id="gear-slot-1">
          <div class="refinement-gear-slot-header">
            <span id="blessing-name-1" class="refinement-blessing-name">-</span>
            <div id="lock-indicator-ref-1" class="refinement-lock-indicator hidden">LOCKED</div>
          </div>
          <div class="refinement-tier-display" id="tier-reel-1">
            <div class="refinement-comparison-grid">
              <div class="refinement-current-side">
                <div class="refinement-tier-label">Current</div>
                <div class="refinement-tier-value" id="current-tier-1">T?</div>
                <div class="refinement-tier-stat" id="current-stat-1">-</div>
              </div>
              <div class="refinement-new-side">
                <div class="refinement-tier-label">New</div>
                <div class="refinement-tier-value" id="new-tier-1">T?</div>
                <div class="refinement-tier-stat" id="new-stat-1">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="refinement-gear-slot" id="gear-slot-2">
          <div class="refinement-gear-slot-header">
            <span id="blessing-name-2" class="refinement-blessing-name">-</span>
            <div id="lock-indicator-ref-2" class="refinement-lock-indicator hidden">LOCKED</div>
          </div>
          <div class="refinement-tier-display" id="tier-reel-2">
            <div class="refinement-comparison-grid">
              <div class="refinement-current-side">
                <div class="refinement-tier-label">Current</div>
                <div class="refinement-tier-value" id="current-tier-2">T?</div>
                <div class="refinement-tier-stat" id="current-stat-2">-</div>
              </div>
              <div class="refinement-new-side">
                <div class="refinement-tier-label">New</div>
                <div class="refinement-tier-value" id="new-tier-2">T?</div>
                <div class="refinement-tier-stat" id="new-stat-2">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="refinement-gear-slot" id="gear-slot-3">
          <div class="refinement-gear-slot-header">
            <span id="blessing-name-3" class="refinement-blessing-name">-</span>
            <div id="lock-indicator-ref-3" class="refinement-lock-indicator hidden">LOCKED</div>
          </div>
          <div class="refinement-tier-display" id="tier-reel-3">
            <div class="refinement-comparison-grid">
              <div class="refinement-current-side">
                <div class="refinement-tier-label">Current</div>
                <div class="refinement-tier-value" id="current-tier-3">T?</div>
                <div class="refinement-tier-stat" id="current-stat-3">-</div>
              </div>
              <div class="refinement-new-side">
                <div class="refinement-tier-label">New</div>
                <div class="refinement-tier-value" id="new-tier-3">T?</div>
                <div class="refinement-tier-stat" id="new-stat-3">-</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Refine Button -->
      <button id="refine-btn" class="refine-button">
        REFINE
        <div class="hammer-cost">
          Cost: <span id="refinement-hammer-cost">1</span> Hammer<span
            id="hammer-plural"
            class="hidden">s</span
          >
        </div>
      </button>

      <!-- Optional Undo - Always visible -->
      <div id="keep-original" class="refinement-choice-section">
        <div class="refinement-choice-text">Results applied automatically. Optional:</div>
        <div class="refinement-choice-buttons">
          <button id="keep-new-btn" class="refinement-choice-btn" disabled style="display: none;"
            >Keep New</button
          >
          <button id="keep-original-btn" class="refinement-choice-btn" disabled
            >Keep Original</button
          >
        </div>
      </div>
    </div>

    <!-- Container 2: Lock Controls & Info -->
    <div class="lock-controls-area">
      <div class="lock-section">
        <div class="lock-info">Lock slots to keep them during refinement</div>
        <div id="refinement-lock-buttons" class="lock-buttons">
          <!-- Lock buttons will be dynamically added -->
        </div>
        <div id="refinement-lock-counter" class="lock-counter">Locked: 0/3</div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-item">
        <span class="stat-label">Hammers Used:</span>
        <span id="refinement-hammers" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">T15 Count:</span>
        <span id="t15-count" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Avg Tier:</span>
        <span id="avg-tier" class="stat-value">-</span>
      </div>
    </div>

    <button id="back-btn" class="back-button">‚Üê Back to Setup</button>
  </div>
</div>

<!-- Probability Breakdown -->
<div class="probability-section">
  <h3>Tier Roll Probabilities</h3>
  <div class="probability-details">
    <div class="prob-row prob-row-common">
      <div class="prob-tier-info">
        <strong class="prob-guaranteed">T1-T5 (Common)</strong>
        <div class="prob-description">Most frequent results</div>
      </div>
      <div class="prob-stats">
        <div class="prob-individual">12% each</div>
        <div class="prob-total">60% total</div>
      </div>
    </div>

    <div class="prob-row prob-row-uncommon">
      <div class="prob-tier-info">
        <strong class="prob-medium">T6-T10 (Uncommon)</strong>
        <div class="prob-description">Moderate results</div>
      </div>
      <div class="prob-stats">
        <div class="prob-individual">7% each</div>
        <div class="prob-total">35% total</div>
      </div>
    </div>

    <div class="prob-row prob-row-rare">
      <div class="prob-tier-info">
        <strong class="prob-low">T11-T15 (Rare)</strong>
        <div class="prob-description">Highest tier results</div>
      </div>
      <div class="prob-stats">
        <div class="prob-individual">1% each</div>
        <div class="prob-total">5% total</div>
      </div>
    </div>

    <div class="prob-note">
      <div class="prob-note-header">
        <strong>Hammer Costs</strong>
      </div>
      <div class="hammer-cost-grid">
        <div class="hammer-cost-item">
          <span class="cost-locks">No Locks:</span>
          <span class="cost-hammers">1 hammer</span>
        </div>
        <div class="hammer-cost-item">
          <span class="cost-locks">1 Lock:</span>
          <span class="cost-hammers">2 hammers</span>
        </div>
        <div class="hammer-cost-item">
          <span class="cost-locks">2 Locks:</span>
          <span class="cost-hammers">3 hammers</span>
        </div>
        <div class="hammer-cost-item">
          <span class="cost-locks">3 Locks:</span>
          <span class="cost-hammers">4 hammers</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import '/src/scripts/sab-refinement-machine.js';
</script>
