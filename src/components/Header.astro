---
import { SITE_TITLE } from '../consts';
import DesktopHeader from './DesktopHeader.astro';
import MobileHeader from './MobileHeader.astro';
---

<header class="header-container">
  <nav class="nav-container">
    <div class="header-content">
      <div class="logo-container">
        <a href="/" class="logo-title simple-title">{SITE_TITLE}</a>
      </div>
      <div class="center-nav">
        <DesktopHeader />
      </div>
      <div class="right-elements">
        <button
          class="crypto-button btc-button"
          title="Copy BTC Address"
          data-address="bc1qdqzll9zp50jgs5kkrcfz9w2u60tk9q8ds05gx4"
        >
          <svg class="crypto-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M23.638 14.904c-1.602 6.43-8.113 10.34-14.542 8.736C2.67 22.05-1.244 15.525.362 9.105 1.962 2.67 8.475-1.243 14.9.358c6.43 1.605 10.342 8.115 8.738 14.546zm-6.35-4.613c.24-1.59-.974-2.45-2.64-3.03l.54-2.153-1.315-.33-.52 2.1c-.347-.087-.7-.168-1.053-.25l.53-2.12-1.32-.33-.54 2.153c-.286-.065-.567-.13-.84-.2l-1.815-.45-.35 1.407s.974.224.954.238c.533.133.63.486.613.766l-.615 2.473c.037.01.085.024.137.047l-.14-.035-.86 3.46c-.065.16-.23.4-.6.31.013.02-.954-.24-.954-.24l-.65 1.51 1.71.426.93.24-.54 2.19 1.32.33.54-2.17c.36.1.71.19 1.05.273l-.54 2.14 1.32.33.54-2.18c2.24.42 3.93.25 4.64-1.77.57-1.63-.03-2.57-1.2-3.18.85-.2 1.5-.76 1.67-1.93zm-2.99 4.2c-.4 1.63-3.13.75-4.01.53l.72-2.87c.88.22 3.71.66 3.29 2.34zm.41-4.22c-.37 1.49-2.64.73-3.38.54l.65-2.6c.74.18 3.11.53 2.73 2.06z"/>
          </svg>
        </button>
        <button
          class="crypto-button xmr-button"
          title="Copy XMR Address"
          data-address="4AopuCr53mbHWekXMcpVfoc5Wza6oYxbpPm4nC88EjCbcv3cyG9vAk5EgBi1Q17qVuEuWZzMwF8YC2aVnjkTWz7aF86s3jW"
        >
          <svg class="crypto-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 2.182c5.424 0 9.818 4.394 9.818 9.818 0 5.424-4.394 9.818-9.818 9.818-5.424 0-9.818-4.394-9.818-9.818 0-5.424 4.394-9.818 9.818-9.818zM5.091 16.364V12l3.273 3.273V9.818L12 13.455l3.636-3.637v5.455L18.909 12v4.364h2.182v1.454H2.909v-1.454h2.182z"/>
          </svg>
        </button>
        <MobileHeader />
      </div>
    </div>
  </nav>
</header>

<style>
  /* Colors are available via layout's index.css import */

  .simple-title {
    color: var(--amber-glow);
    transition:
      color 0.2s ease,
      background-color 0.2s ease,
      transform 0.2s ease;
    will-change: transform, background-color;
  }

  /* Header optimizations for CLS prevention */
  .header-container {
    background: linear-gradient(135deg, var(--bg-dark) 0%, #2a2a2a 50%, var(--bg-dark) 100%);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(255, 183, 77, 0.3);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: var(--z-navigation);
    /* Fixed height to prevent layout shift and ensure consistent positioning */
    height: 72px;
    contain: layout style paint;
  }

  .nav-container {
    max-width: 72rem;
    margin: 0 auto;
    /* Prevent horizontal overflow */
    overflow-x: hidden;
    height: 100%;
    display: flex;
    align-items: center;
  }

  .header-content {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    padding: 0 1rem;
    /* Use full width and height */
    width: 100%;
    height: 100%;
  }

  /* Logo optimizations */
  .logo-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    /* Prevent shrinking */
    flex-shrink: 0;
    justify-self: start;
  }

  /* Center navigation */
  .center-nav {
    justify-self: center;
    display: flex;
    align-items: center;
  }

  /* Right side elements */
  .right-elements {
    justify-self: end;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .logo-title {
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--amber-glow);
    transition: all 0.3s ease;
    will-change: transform;
    /* Touch optimization */
    touch-action: manipulation;
    /* Ensure proper vertical centering within fixed header height */
    display: flex;
    align-items: center;
    height: fit-content;
  }

  .crypto-button {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border-radius: 0.5rem;
    touch-action: manipulation;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
  }

  .btc-button {
    background: rgba(247, 147, 26, 0.15);
    border: 1px solid rgba(247, 147, 26, 0.4);
    color: #f7931a;
  }

  .xmr-button {
    background: rgba(255, 102, 0, 0.15);
    border: 1px solid rgba(255, 102, 0, 0.4);
    color: #ff6600;
  }

  .crypto-icon {
    flex-shrink: 0;
  }

  .crypto-button::after {
    content: 'Copied!';
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-dark);
    color: var(--amber-glow);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    border: 1px solid rgba(255, 183, 77, 0.3);
    white-space: nowrap;
  }

  .crypto-button.copied::after {
    opacity: 1;
  }

  /* Touch Device & Mobile Responsive Design */
  @media (max-width: 1024px), (hover: none) and (pointer: coarse) {
    /* Remove sticky positioning on touch devices for smoother scrolling */
    .header-container {
      position: relative;
      height: 72px;
    }

    /* Optimize header padding */
    .header-content {
      padding: 0 1rem !important;
    }

    /* Adjust logo size */
    .logo-title {
      font-size: 1.25rem !important;
    }

    /* Adjust right elements for mobile */
    .right-elements {
      gap: 0.5rem;
    }

    /* Disable animations on mobile for better performance */
    .simple-title,
    .logo-title {
      transition: none;
      will-change: auto;
    }
  }

  /* Mobile landscape specific adjustments */
  @media (max-height: 768px) and (orientation: landscape) and (hover: none) {
    .header-container {
      height: 60px;
    }

    .logo-title {
      font-size: 1.4rem !important; /* Larger title in landscape for better hierarchy */
    }
  }

  /* Hide support buttons on smaller screens to prevent overflow */
  @media (max-width: 900px) {
    .crypto-button {
      display: none;
    }
  }

  @media (max-width: 480px) {
    /* Maintain fixed header height on small mobile */
    .header-container {
      height: 72px;
    }

    .header-content {
      padding: 0 0.75rem !important;
    }

    .logo-title {
      font-size: 1.1rem !important;
      padding: 0.5rem 0.75rem !important;
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .simple-title,
    .logo-title {
      transition: none !important;
      animation: none !important;
    }
  }
</style>

<script>
  // Crypto copy-to-clipboard functionality
  document.querySelectorAll('.crypto-button').forEach(button => {
    button.addEventListener('click', async () => {
      const address = button.getAttribute('data-address');
      if (address) {
        await navigator.clipboard.writeText(address);
        button.classList.add('copied');
        setTimeout(() => button.classList.remove('copied'), 1500);
      }
    });
  });

  // Mobile menu functionality
  document.addEventListener('DOMContentLoaded', function () {
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobileMenu');
    const closeMenuBtn = document.getElementById('closeMenu');
    let isMenuOpen = false;

    const _COMPONENT_ID = 'header-mobile-menu';

    function toggleMenu() {
      isMenuOpen = !isMenuOpen;

      if (hamburger) {
        hamburger.setAttribute('aria-expanded', isMenuOpen.toString());
      }

      if (mobileMenu) {
        if (isMenuOpen) {
          // Simple menu opening without scroll manager
          mobileMenu.classList.add('active');
          document.body.style.overflow = 'hidden';

          // Ensure the menu drawer is visible by scrolling to top
          const drawer = mobileMenu.querySelector('.mobile-menu-drawer');
          if (drawer) {
            drawer.scrollTop = 0;
          }
        } else {
          // Simple menu closing without scroll manager
          mobileMenu.classList.remove('active');
          document.body.style.overflow = '';
        }
      }
    }

    function closeMenu() {
      if (isMenuOpen) {
        toggleMenu();
      }
    }

    // Event listeners
    hamburger?.addEventListener('click', toggleMenu);
    closeMenuBtn?.addEventListener('click', closeMenu);
    // Close menu when clicking on overlay or links
    mobileMenu?.addEventListener('click', e => {
      const target = e.target as HTMLElement;
      if (
        target === mobileMenu ||
        target.classList?.contains('mobile-menu-overlay') ||
        (target &&
          (target.classList?.contains('mobile-nav-link') ||
            target.classList?.contains('mobile-social-link')))
      ) {
        closeMenu();
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && isMenuOpen) {
        closeMenu();
      }
    });

    // Close menu on window resize (desktop breakpoint)
    let resizeTimeout: ReturnType<typeof setTimeout> | undefined;
    const resizeHandler = () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (window.innerWidth > 768 && isMenuOpen) {
          closeMenu();
        }
      }, 100);
    };
    window.addEventListener('resize', resizeHandler);

    // Cleanup on page unload
    const beforeUnloadHandler = () => {
      // Clear timeout to prevent memory leak
      if (resizeTimeout) {
        clearTimeout(resizeTimeout);
        resizeTimeout = undefined;
      }

      // Remove event listeners
      window.removeEventListener('resize', resizeHandler);

      // Reset body overflow
      if (isMenuOpen) {
        document.body.style.overflow = '';
      }
    };
    window.addEventListener('beforeunload', beforeUnloadHandler);
  });
</script>
