---
// Stella Sora Character Database Filter Bar Component
// Provides filtering controls for the character database

import { gameInfo } from '../../data/stella-sora/characters.js';

export interface Props {
  showFilters?: boolean;
}

const { showFilters = true } = Astro.props;
---

{
  showFilters && (
    <div class="character-filter-bar">
      <div class="filter-section">
        <h3 class="filter-title">Filters</h3>
        <div class="filter-controls">
          <select class="filter-select" id="rarity-filter">
            <option value="">Rarity</option>
            {gameInfo.rarities.map(rarity => (
              <option value={rarity}>{rarity}</option>
            ))}
          </select>

          <select class="filter-select" id="element-filter">
            <option value="">Element</option>
            {gameInfo.elements.map(element => (
              <option value={element.name}>{element.name}</option>
            ))}
          </select>

          <select class="filter-select" id="role-filter">
            <option value="">Role</option>
            {gameInfo.roles.map(role => (
              <option value={role.name}>{role.name}</option>
            ))}
          </select>
        </div>
      </div>

      <div class="filter-section">
        <h3 class="filter-title">Search</h3>
        <input
          type="text"
          id="search-input"
          placeholder="Search characters by name or tags..."
          class="search-input"
        />
      </div>
    </div>
  )
}

<script>
  // --- Filter Component State ---
  let originalRows = [];
  let originalCards = [];

  // DOM references for filter elements
  let tableBody, mobileCardsContainer, searchInput, rarityFilter, elementFilter, roleFilter;

  function initializeFilters() {
    // Get DOM references
    tableBody = document.getElementById('character-table-body');
    mobileCardsContainer = document.getElementById('character-cards');
    searchInput = document.getElementById('search-input');
    rarityFilter = document.getElementById('rarity-filter');
    elementFilter = document.getElementById('element-filter');
    roleFilter = document.getElementById('role-filter');

    // Store original rows and cards for filtering
    originalRows = tableBody ? Array.from(tableBody.querySelectorAll('.character-row')) : [];
    originalCards = mobileCardsContainer
      ? Array.from(mobileCardsContainer.querySelectorAll('.character-card'))
      : [];

    // Early exit if required elements don't exist
    if (!tableBody || !mobileCardsContainer) {
      console.error('Required elements not found!');
      return;
    }

    // Restore saved filter state
    restoreFilterState();

    // Setup filter event listeners
    setupFilterEventListeners();

    // Setup Clear All button
    const globalClearBtn = document.getElementById('global-clear-btn');
    if (globalClearBtn) {
      globalClearBtn.addEventListener('click', globalReset);
    }

    // Apply initial filters
    applyFilters();
  }

  function setupFilterEventListeners() {
    // Filter inputs
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }
    if (rarityFilter) {
      rarityFilter.addEventListener('change', applyFilters);
    }
    if (elementFilter) {
      elementFilter.addEventListener('change', applyFilters);
    }
    if (roleFilter) {
      roleFilter.addEventListener('change', applyFilters);
    }

    // Listen for sort component to trigger filter reapplication
    document.addEventListener('filtersChanged', () => {
      applyFilters();
    });
  }

  function applyFilters() {
    const search = searchInput ? searchInput.value.toLowerCase().trim() : '';
    const rarity = rarityFilter ? rarityFilter.value : '';
    const element = elementFilter ? elementFilter.value : '';
    const role = roleFilter ? roleFilter.value : '';

    // Clear all filter states
    const filterSelects = document.querySelectorAll('.filter-select');
    filterSelects.forEach(select => {
      select.classList.remove('active');
    });

    // Apply filters to rows and cards
    originalRows.forEach((row, index) => {
      const card = originalCards[index];
      const showRow = shouldShowCharacter(row, search, rarity, element, role);

      row.style.display = showRow ? '' : 'none';
      if (card) card.style.display = showRow ? '' : 'none';
    });

    // Save filter state
    try {
      sessionStorage.setItem(
        'ss-character-filters',
        JSON.stringify({ search, rarity, element, role })
      );
    } catch (_error) {
      // Ignore storage errors
    }

    // Notify sort component that filters have changed
    document.dispatchEvent(
      new CustomEvent('filtersApplied', {
        detail: { hasActiveFilters: !!(search || rarity || element || role) },
      })
    );

    // Re-number visible rows
    renumberRows();
  }

  function shouldShowCharacter(row, search, rarity, element, role) {
    if (search && !row.dataset.name.toLowerCase().includes(search)) {
      return false;
    }
    if (rarity && row.dataset.rarity !== rarity) {
      return false;
    }
    if (element && row.dataset.element !== element) {
      return false;
    }
    if (role && row.dataset.role !== role) {
      return false;
    }
    return true;
  }

  function resetFilters() {
    if (searchInput) searchInput.value = '';
    if (rarityFilter) rarityFilter.value = '';
    if (elementFilter) elementFilter.value = '';
    if (roleFilter) roleFilter.value = '';

    // Clear sessionStorage
    try {
      sessionStorage.removeItem('ss-character-filters');
    } catch (_error) {
      // Ignore storage errors
    }

    // Show all rows and cards first
    originalRows.forEach(row => (row.style.display = ''));
    originalCards.forEach(card => (card.style.display = ''));

    // Reset to original order (alphabetical by name) - use all rows since we just showed them all
    const sortedRows = originalRows.sort((a, b) => {
      const nameA = a.querySelector('.character-name')?.textContent || '';
      const nameB = b.querySelector('.character-name')?.textContent || '';
      return nameA.localeCompare(nameB);
    });

    const sortedCards = sortedRows
      .map(row => {
        const rowIndex = originalRows.indexOf(row);
        return originalCards[rowIndex];
      })
      .filter(Boolean);

    // Re-append sorted content
    if (tableBody) {
      tableBody.innerHTML = '';
      sortedRows.forEach(row => tableBody.appendChild(row));
      renumberRows();
    }
    if (mobileCardsContainer) {
      mobileCardsContainer.innerHTML = '';
      sortedCards.forEach(card => mobileCardsContainer.appendChild(card));
    }

    // Notify sort component that filters were reset
    document.dispatchEvent(new CustomEvent('filtersReset'));
  }

  function restoreFilterState() {
    // Restore filter state
    try {
      const savedFilters = sessionStorage.getItem('ss-character-filters');
      if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        if (searchInput) searchInput.value = filters.search || '';
        if (rarityFilter) rarityFilter.value = filters.rarity || '';
        if (elementFilter) elementFilter.value = filters.element || '';
        if (roleFilter) roleFilter.value = filters.role || '';
      }
    } catch (_error) {
      // Ignore storage errors
    }
  }

  function renumberRows() {
    const visibleRows = Array.from(tableBody.querySelectorAll('tr.character-row')).filter(
      row => row.style.display !== 'none'
    );
    visibleRows.forEach((row, index) => {
      const numberCell = row.querySelector('td:first-child');
      if (numberCell) {
        numberCell.textContent = index + 1;
      }
    });
  }

  function globalReset() {
    resetFilters();
  }

  // Make functions globally accessible for other components
  window.resetFilters = resetFilters;
  window.renumberRows = renumberRows;

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeFilters);
  } else {
    initializeFilters();
  }
</script>
