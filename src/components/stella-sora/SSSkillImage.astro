---
// Stella Sora Skill Image Component
// Combines: element plate (background) + skill type icon + character skill icon (overlay)
import { Image } from 'astro:assets';

// Import element plate backgrounds
import ignisPlate from '../../assets/images/games/stella-sora/skills/ignis_plate.png';
import aquaPlate from '../../assets/images/games/stella-sora/skills/aqua_plate.png';
import terraPlate from '../../assets/images/games/stella-sora/skills/terra_plate.png';
import ventusPlate from '../../assets/images/games/stella-sora/skills/ventus_plate.png';
import luxPlate from '../../assets/images/games/stella-sora/skills/lux_plate.png';
import umbraPlate from '../../assets/images/games/stella-sora/skills/umbra_plate.png';

// Element plate mapping
const elementPlateMap: Record<string, ImageMetadata> = {
  ignis: ignisPlate,
  aqua: aquaPlate,
  terra: terraPlate,
  ventus: ventusPlate,
  lux: luxPlate,
  umbra: umbraPlate,
};

// Import skill type icons (small icons showing skill type)
import normalIcon from '../../assets/images/games/stella-sora/skills/normal.png';
import skillIcon from '../../assets/images/games/stella-sora/skills/skill.png';
import supportIcon from '../../assets/images/games/stella-sora/skills/support.png';
import ultimateIcon from '../../assets/images/games/stella-sora/skills/ultimate.png';

// Skill type icon mapping
const skillTypeIconMap: Record<string, ImageMetadata> = {
  'normal-attack': normalIcon,
  skill: skillIcon,
  'support-skill': supportIcon,
  ultimate: ultimateIcon,
};

// Dynamically import all character skill images
const characterSkillImages = import.meta.glob<{ default: ImageMetadata }>(
  '../../assets/images/games/stella-sora/characters/*/skills/*.png',
  { eager: true }
);

// Create a nested map: characterSlug -> skillType -> ImageMetadata
const skillImageMap: Record<string, Record<string, ImageMetadata>> = {};
for (const [path, module] of Object.entries(characterSkillImages)) {
  // Extract character slug and skill type from path
  // Path format: ../../assets/images/games/stella-sora/characters/[char]/skills/[skill-type].png
  const match = path.match(/characters\/([^/]+)\/skills\/([^/]+)\.png$/);
  if (match) {
    const [, charSlug, skillType] = match;
    if (!skillImageMap[charSlug]) {
      skillImageMap[charSlug] = {};
    }
    skillImageMap[charSlug][skillType] = module.default;
  }
}

// Character element mapping (all 29 characters)
const characterElementMap: Record<string, string> = {
  amber: 'ignis',
  ann: 'ventus',
  canace: 'ventus',
  caramel: 'umbra',
  chitose: 'aqua',
  chixia: 'ignis',
  coronis: 'umbra',
  cosette: 'umbra',
  flora: 'ignis',
  freesia: 'aqua',
  fuyuka: 'ignis',
  gerie: 'terra',
  iris: 'aqua',
  jinglin: 'lux',
  kasimira: 'ignis',
  laru: 'lux',
  'snowish-laru': 'ignis',
  minova: 'lux',
  mistique: 'umbra',
  nanoha: 'ventus',
  nazuka: 'ventus',
  nazuna: 'terra',
  noya: 'ventus',
  ridge: 'terra',
  shia: 'lux',
  shimiao: 'aqua',
  teresa: 'aqua',
  tilia: 'lux',
};

export interface Props {
  characterName: string;
  skillType: 'normal-attack' | 'skill' | 'support-skill' | 'ultimate';
  alt: string;
  loading?: 'lazy' | 'eager';
  class?: string;
}

const { characterName, skillType, alt, loading = 'lazy', class: className } = Astro.props;

// Get character slug (lowercase, spaces to hyphens)
// Special cases for characters with different folder names
const characterSlugMap: Record<string, string> = {
  'snowish laru': 'snowish-laru',
};
const normalizedName = characterName.toLowerCase().replace(/\s+/g, '-');
const characterSlug = characterSlugMap[normalizedName] || normalizedName;

// Get element plate for this character
const element = characterElementMap[characterSlug] || 'ignis';
const plateSrc = elementPlateMap[element];

// Get skill type icon
const typeIconSrc = skillTypeIconMap[skillType];

// Get character-specific skill image
const characterSkills = skillImageMap[characterSlug];
const skillSrc = characterSkills?.[skillType];

const imageAlt = skillSrc ? alt : `Image not found: ${alt}`;
---

<div class={`skill-image-container ${className || ''}`}>
  {
    plateSrc && skillSrc ? (
      <div class="skill-image-layered">
        {/* Background: Element plate */}
        <Image
          src={plateSrc}
          alt=""
          width={120}
          height={120}
          loading={loading}
          class="skill-bg-plate"
          quality={90}
          format="webp"
        />
        {/* Middle: Skill type icon */}
        {typeIconSrc && (
          <Image
            src={typeIconSrc}
            alt=""
            width={40}
            height={40}
            loading={loading}
            class="skill-type-icon"
            quality={90}
            format="webp"
          />
        )}
        {/* Foreground: Character skill image */}
        <Image
          src={skillSrc}
          alt={imageAlt}
          width={80}
          height={80}
          loading={loading}
          class="skill-char-icon"
          quality={95}
          format="webp"
        />
      </div>
    ) : (
      <div class="skill-image-placeholder">
        <span>No Image</span>
      </div>
    )
  }
</div>

<style>
  /* Styles handled by global CSS in ss-character-individual.css */
</style>
