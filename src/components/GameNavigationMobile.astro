---
import { getGameData, isValidGameKey, type GameKey } from '../data/game-navigation';

interface Props {
  currentPath?: string;
  gameKey?: GameKey;
}

const { currentPath = '', gameKey } = Astro.props;

// Validate and sanitize gameKey
const validatedGameKey = isValidGameKey(gameKey) ? gameKey : undefined;
const game = getGameData(validatedGameKey);

const isActive = (href: string) => {
  if (
    href.endsWith('/zone-nova/') ||
    href.endsWith('/silver-and-blood/') ||
    href.endsWith('/horizon-walker/')
  ) {
    return currentPath === href;
  }
  return (
    currentPath === href ||
    (currentPath.startsWith(href) && currentPath !== href.replace(/\/$/, ''))
  );
};

if (!game) return;
---

<style>
  @import '../styles/components/game-navigation-mobile.css';
</style>

<nav class="game-nav-mobile" data-game={validatedGameKey}>
  <div class="container">
    <div class="game-nav-header">
      <div class="game-nav-header-content">
        <a
          href={`/guides/${validatedGameKey}/`}
          class="game-image-link"
          title={`${game.name} Overview`}
        >
          <div class="game-image-container">
            <img src={game.image} alt={game.name} class="game-image" loading="lazy" />
            <div class="game-image-overlay"></div>
          </div>
        </a>
        <button
          class="game-resources-btn"
          id="navToggle"
          aria-label={`Browse ${game.name} Resources`}
          aria-expanded="false"
        >
          <h2 class="game-title">{game.name} Resources</h2>
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- Mobile Navigation - Overlay System -->
<div class="mobile-overlay" id="navOverlay"></div>
<div class="mobile-links" id="mobileNavLinks" data-game={validatedGameKey}>
  <div class="mobile-game-header">
    <div class="game-header-content">
      <img src={game.image} alt={game.name} class="mobile-game-image" loading="lazy" />
      <div class="mobile-game-title">Resources</div>
    </div>
    <button class="close-btn" id="navClose">âœ•</button>
  </div>

  <div class="mobile-sections-wrapper">
    <div class="mobile-sections-grid">
      {
        game.sections.map(section => (
          <div class="mobile-section">
            <div class="mobile-section-header">
              <span class="mobile-section-title">{section.title}</span>
            </div>
            {section.links.map(link => (
              <a
                href={link.href}
                class={isActive(link.href) ? 'mobile-link active' : 'mobile-link'}
              >
                {link.name}
              </a>
            ))}
          </div>
        ))
      }
    </div>
  </div>
</div>

<script>
  // Import ScrollManager for centralized scroll control
  import { scrollManager } from '../utils/scroll-manager.js';

  // Mobile Navigation - Full-screen popup with viewport isolation
  document.addEventListener('DOMContentLoaded', function () {
    const toggle = document.getElementById('navToggle');
    const mobileMenu = document.getElementById('mobileNavLinks');
    const closeBtn = document.getElementById('navClose');
    const overlay = document.getElementById('navOverlay');
    let isMenuOpen = false;

    const COMPONENT_ID = 'game-navigation-mobile';

    function toggleMenu() {
      isMenuOpen = !isMenuOpen;

      if (toggle) {
        toggle.setAttribute('aria-expanded', isMenuOpen.toString());
      }

      if (mobileMenu) {
        if (isMenuOpen) {
          try {
            // Use ScrollManager for centralized scroll locking
            scrollManager.lockScroll(COMPONENT_ID, {
              preservePosition: true,
              touchAction: 'none',
              preventOverscroll: true,
            });

            mobileMenu.classList.add('active');
            overlay?.classList.add('active');

            // Menu will appear at current viewport - no scrolling needed
          } catch (error) {
            console.error('GameNavigationMobile: Error opening menu:', error);
            isMenuOpen = false;
            if (toggle) {
              toggle.setAttribute('aria-expanded', 'false');
            }
          }
        } else {
          try {
            // Use ScrollManager to restore scrolling
            scrollManager.unlockScroll(COMPONENT_ID);

            mobileMenu.classList.remove('active');
            overlay?.classList.remove('active');
          } catch (error) {
            console.error('GameNavigationMobile: Error closing menu:', error);
            // Force cleanup on error
            scrollManager.forceUnlockAll();
            mobileMenu.classList.remove('active');
            overlay?.classList.remove('active');
          }
        }
      }
    }

    function closeMenu() {
      if (isMenuOpen) {
        toggleMenu();
      }
    }

    // Event listeners
    toggle?.addEventListener('click', toggleMenu);
    closeBtn?.addEventListener('click', closeMenu);
    // Close menu when clicking on overlay or links
    mobileMenu?.addEventListener('click', e => {
      const target = e.target as HTMLElement;
      if (
        target === mobileMenu ||
        target === overlay ||
        (target && target.classList?.contains('mobile-link'))
      ) {
        closeMenu();
      }
    });
    overlay?.addEventListener('click', closeMenu);

    // Close menu on escape key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && isMenuOpen) {
        closeMenu();
      }
    });

    // Close menu on window resize (desktop breakpoint)
    let resizeTimeout: ReturnType<typeof setTimeout> | undefined;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (window.innerWidth > 768 && isMenuOpen) {
          closeMenu();
        }
      }, 100);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (isMenuOpen) {
        scrollManager.unlockScroll(COMPONENT_ID);
      }
    });

    // Cleanup on visibility change (mobile browser switching)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isMenuOpen) {
        closeMenu();
      }
    });
  });
</script>
