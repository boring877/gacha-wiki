---
import { HORIZON_WALKER_CHARACTERS } from '../../data/horizon-walker/characters';

const { currentCharacterSlug } = Astro.props;

const currentIndex = HORIZON_WALKER_CHARACTERS.findIndex(
  char => char.slug === currentCharacterSlug
);

// If character not found, fallback to first character in list
let prevUrl = '/guides/horizon-walker/characters';
let nextUrl = '/guides/horizon-walker/characters';
let prevCharacterName = '';
let nextCharacterName = '';

if (currentIndex !== -1) {
  // Previous character (wrap to end if at start)
  const prevIndex = currentIndex > 0 ? currentIndex - 1 : HORIZON_WALKER_CHARACTERS.length - 1;
  prevUrl = HORIZON_WALKER_CHARACTERS[prevIndex].detailUrl;
  prevCharacterName =
    HORIZON_WALKER_CHARACTERS[prevIndex].name || HORIZON_WALKER_CHARACTERS[prevIndex].id.toString();

  // Next character (wrap to start if at end)
  const nextIndex = currentIndex < HORIZON_WALKER_CHARACTERS.length - 1 ? currentIndex + 1 : 0;
  nextUrl = HORIZON_WALKER_CHARACTERS[nextIndex].detailUrl;
  nextCharacterName =
    HORIZON_WALKER_CHARACTERS[nextIndex].name || HORIZON_WALKER_CHARACTERS[nextIndex].id.toString();
} else {
  // Character not found - log for debugging and use first character
  console.warn(`Character not found: ${currentCharacterSlug}`);
  if (HORIZON_WALKER_CHARACTERS.length > 0) {
    prevUrl = HORIZON_WALKER_CHARACTERS[HORIZON_WALKER_CHARACTERS.length - 1].detailUrl;
    nextUrl = HORIZON_WALKER_CHARACTERS[0].detailUrl;
    prevCharacterName =
      HORIZON_WALKER_CHARACTERS[HORIZON_WALKER_CHARACTERS.length - 1].name ||
      HORIZON_WALKER_CHARACTERS[HORIZON_WALKER_CHARACTERS.length - 1].id.toString();
    nextCharacterName =
      HORIZON_WALKER_CHARACTERS[0].name || HORIZON_WALKER_CHARACTERS[0].id.toString();
  }
}
---

<script define:vars={{ prevUrl, nextUrl, prevCharacterName, nextCharacterName }}>
  document.addEventListener('keydown', e => {
    const target = e.target;
    if (
      target?.tagName === 'INPUT' ||
      target?.tagName === 'TEXTAREA' ||
      e.ctrlKey ||
      e.altKey ||
      e.metaKey
    )
      return;
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      console.log(`Navigating to previous character: ${prevCharacterName}`);
      window.location.href = prevUrl;
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      console.log(`Navigating to next character: ${nextCharacterName}`);
      window.location.href = nextUrl;
    }
  });

  const leftZone = document.getElementById('mobile-swipe-left');
  const rightZone = document.getElementById('mobile-swipe-right');
  let touchStartTime = 0,
    touchMoved = false;

  function handleTouchStart() {
    touchStartTime = Date.now();
    touchMoved = false;
  }
  function handleTouchMove() {
    touchMoved = true;
  }

  if (leftZone) {
    leftZone.addEventListener('touchstart', handleTouchStart);
    leftZone.addEventListener('touchmove', handleTouchMove);
    leftZone.addEventListener('touchend', () => {
      const touchDuration = Date.now() - touchStartTime;
      if (!touchMoved && touchDuration < 400 && touchDuration > 50) window.location.href = prevUrl;
    });
  }

  if (rightZone) {
    rightZone.addEventListener('touchstart', handleTouchStart);
    rightZone.addEventListener('touchmove', handleTouchMove);
    rightZone.addEventListener('touchend', () => {
      const touchDuration = Date.now() - touchStartTime;
      if (!touchMoved && touchDuration < 400 && touchDuration > 50) window.location.href = nextUrl;
    });
  }
</script>

<div id="mobile-swipe-left" class="mobile-swipe-zone"></div>
<div id="mobile-swipe-right" class="mobile-swipe-zone"></div>

<style>
  .mobile-swipe-zone {
    position: fixed;
    top: 0;
    width: 80px;
    height: 100vh;
    z-index: 1000;
    cursor: pointer;
    user-select: none;
    touch-action: manipulation;
  }
  #mobile-swipe-left {
    left: 0;
  }
  #mobile-swipe-right {
    right: 0;
  }
  @media (min-width: 768px) {
    .mobile-swipe-zone {
      display: none;
    }
  }
</style>
